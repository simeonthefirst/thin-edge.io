<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Monitor my device - Thin Edge Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../001_overview.html">Overview</a></li><li class="chapter-item expanded "><a href="../tutorials/index.html"><strong aria-hidden="true">1.</strong> Tutorials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tutorials/connect-c8y.html"><strong aria-hidden="true">1.1.</strong> Connect my device to Cumulocity IoT</a></li><li class="chapter-item expanded "><a href="../tutorials/connect-azure.html"><strong aria-hidden="true">1.2.</strong> Connect my device to Azure IoT</a></li><li class="chapter-item expanded "><a href="../tutorials/send-thin-edge-data.html"><strong aria-hidden="true">1.3.</strong> Send Thin Edge Json data</a></li><li class="chapter-item expanded "><a href="../tutorials/device-monitoring.html" class="active"><strong aria-hidden="true">1.4.</strong> Monitor my device</a></li><li class="chapter-item expanded "><a href="../tutorials/software-management.html"><strong aria-hidden="true">1.5.</strong> Manage my device software</a></li><li class="chapter-item expanded "><a href="../tutorials/write-my-software-management-plugin.html"><strong aria-hidden="true">1.6.</strong> Write my software management plugin</a></li><li class="chapter-item expanded "><a href="../tutorials/supported_operations.html"><strong aria-hidden="true">1.7.</strong> Supported Operations Management for Cumulocity IoT</a></li></ol></li><li class="chapter-item expanded "><a href="../howto-guides/index.html"><strong aria-hidden="true">2.</strong> How-to Guides</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../howto-guides/002_installation.html"><strong aria-hidden="true">2.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../howto-guides/003_registration.html"><strong aria-hidden="true">2.2.</strong> How to create a test certificate</a></li><li class="chapter-item expanded "><a href="../howto-guides/004_connect.html"><strong aria-hidden="true">2.3.</strong> How to connect a cloud end-point</a></li><li class="chapter-item expanded "><a href="../howto-guides/005_pub_sub.html"><strong aria-hidden="true">2.4.</strong> How to send MQTT messages</a></li><li class="chapter-item expanded "><a href="../howto-guides/007_test_connection.html"><strong aria-hidden="true">2.5.</strong> How to test the cloud connection?</a></li><li class="chapter-item expanded "><a href="../howto-guides/008_config_local_mqtt_port.html"><strong aria-hidden="true">2.6.</strong> How to configure the local mqtt port</a></li><li class="chapter-item expanded "><a href="../howto-guides/009_trouble_shooting_monitoring.html"><strong aria-hidden="true">2.7.</strong> How to trouble shoot device monitoring</a></li><li class="chapter-item expanded "><a href="../howto-guides/010_add_self_signed_trusted.html"><strong aria-hidden="true">2.8.</strong> How to add self-signed certificate root to trusted certificates list?</a></li><li class="chapter-item expanded "><a href="../howto-guides/011_retrieve_jwt_token_from_cumulocity.html"><strong aria-hidden="true">2.9.</strong> How to retrieve JWT token from Cumulocity?</a></li><li class="chapter-item expanded "><a href="../howto-guides/012_install_and_enable_software_management.html"><strong aria-hidden="true">2.10.</strong> How to install and enable software management?</a></li><li class="chapter-item expanded "><a href="../howto-guides/013_connect_external_device.html"><strong aria-hidden="true">2.11.</strong> How to connect an external device?</a></li><li class="chapter-item expanded "><a href="../howto-guides/014_thin_edge_logs.html"><strong aria-hidden="true">2.12.</strong> How to access the logs on the device?</a></li><li class="chapter-item expanded "><a href="../howto-guides/015_installation_without_deb_support.html"><strong aria-hidden="true">2.13.</strong> How to install thin-edge.io on any Linux OS (no deb support)?</a></li><li class="chapter-item expanded "><a href="../howto-guides/016_restart_device_operation.html"><strong aria-hidden="true">2.14.</strong> How to restart your thin-edge.io device</a></li></ol></li><li class="chapter-item expanded "><a href="../references/index.html"><strong aria-hidden="true">3.</strong> Reference Guides</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../references/tedge.html"><strong aria-hidden="true">3.1.</strong> The tedge command</a></li><li class="chapter-item expanded "><a href="../references/tedge-config.html"><strong aria-hidden="true">3.2.</strong> The tedge config command</a></li><li class="chapter-item expanded "><a href="../references/tedge-cert.html"><strong aria-hidden="true">3.3.</strong> The tedge cert command</a></li><li class="chapter-item expanded "><a href="../references/tedge-connect.html"><strong aria-hidden="true">3.4.</strong> The tedge connect command</a></li><li class="chapter-item expanded "><a href="../references/tedge-disconnect.html"><strong aria-hidden="true">3.5.</strong> The tedge disconnect command</a></li><li class="chapter-item expanded "><a href="../references/tedge-mqtt.html"><strong aria-hidden="true">3.6.</strong> The tedge mqtt command</a></li><li class="chapter-item expanded "><a href="../references/bridged-topics.html"><strong aria-hidden="true">3.7.</strong> The Bridged Topics</a></li><li class="chapter-item expanded "><a href="../references/plugin-api.html"><strong aria-hidden="true">3.8.</strong> The Software Management Plugin API</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/index.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/thin-edge-json.html"><strong aria-hidden="true">4.1.</strong> Thin Edge Json</a></li><li class="chapter-item expanded "><a href="../architecture/mapper.html"><strong aria-hidden="true">4.2.</strong> The Mapper</a></li><li class="chapter-item expanded "><a href="../architecture/software-management.html"><strong aria-hidden="true">4.3.</strong> Software Management</a></li><li class="chapter-item expanded "><a href="../architecture/faq.html"><strong aria-hidden="true">4.4.</strong> Architecture FAQ</a></li><li class="chapter-item expanded "><a href="../supported-platforms.html"><strong aria-hidden="true">4.5.</strong> Platform support</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Thin Edge Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="monitor-your-device-with-collectd"><a class="header" href="#monitor-your-device-with-collectd">Monitor your device with collectd</a></h1>
<p>With thin-edge.io device monitoring, you can collect metrics from your device
and forward these device metrics to IoT platforms in the cloud.</p>
<p>Using these metrics, you can monitor the health of devices
and can proactively initiate actions in case the device seems to malfunction.
Additionally, the metrics can be used to help the customer troubleshoot when problems with the device are reported.</p>
<p>Thin-edge.io uses the open source component <a href="https://collectd.org/"><code>collectd</code></a> to collect the metrics from the device.
Thin-edge.io translates the collected metrics from their native format to the <a href="../architecture/thin-edge-json.html">thin-edge.io JSON</a> format
and then into the <a href="../architecture/mapper.html">cloud-vendor specific format</a>.</p>
<p>Enabling monitoring on your device is a 3-steps process:</p>
<ol>
<li><a href="#install-collectd">Install <code>collectd</code></a>,</li>
<li><a href="#configure-collectd">Configure <code>collectd</code></a>,</li>
<li><a href="#enable-thin-edge-monitoring">Enable thin-edge.io monitoring</a>.</li>
</ol>
<h2 id="install-mosquitto-client-library"><a class="header" href="#install-mosquitto-client-library">Install <code>mosquitto</code> client library</a></h2>
<p>Since thin-edge.io uses the MQTT plugin of <code>collectd</code>, one needs to install the mosquitto client library
(either <code>libmosquitto1</code> or <code>mosquitto-clients</code>).</p>
<pre><code class="language-shell">sudo apt-get install libmosquitto1
</code></pre>
<p>or</p>
<pre><code class="language-shell">sudo apt-get install mosquitto-clients
</code></pre>
<h2 id="install-collectd"><a class="header" href="#install-collectd">Install <code>collectd</code></a></h2>
<p>Device monitoring is not enabled by default when you install thin edge.
You will have to install and configure <a href="https://collectd.org/"><code>collectd</code></a> first.</p>
<p>To install collectd, follow the <a href="https://collectd.org/download.shtml">collectd installation process</a>
that is specific to your device. On a Debian or Ubuntu linux:</p>
<pre><code class="language-shell">sudo apt-get install collectd-core
</code></pre>
<h2 id="configure-collectd"><a class="header" href="#configure-collectd">Configure <code>collectd</code></a></h2>
<h3 id="tldr-just-want-it-running"><a class="header" href="#tldr-just-want-it-running">TLDR; Just want it running</a></h3>
<p>Thin-edge.io provides a <a href="https://github.com/thin-edge/thin-edge.io/blob/main/configuration/contrib/collectd/collectd.conf">basic <code>collectd</code> configuration</a>
that can be used to collect cpu, memory and disk metrics.</p>
<p>Simply copy that file to the main collectd configuration file and restart the daemon
(it might be good to keep a copy of the original configuration).</p>
<pre><code class="language-shell">sudo cp /etc/collectd/collectd.conf /etc/collectd/collectd.conf.backup
sudo cp /etc/tedge/contrib/collectd/collectd.conf /etc/collectd/collectd.conf
sudo systemctl restart collectd
</code></pre>
<h3 id="collectdconf"><a class="header" href="#collectdconf"><code>Collectd.conf</code></a></h3>
<p>Unless you opted for the <a href="#tldr-just-want-it-running">minimal test configuration provided with thin-edge</a>,
you will have to update the
<a href="https://collectd.org/documentation/manpages/collectd.conf.5.shtml"><code>collectd.conf</code> configuration file</a>
(usually located at <code>/etc/collectd/collectd.conf</code>)</p>
<p><strong>Important notes</strong> You can enable or disable the collectd plugins of your choice, but with some notable exceptions:</p>
<ol>
<li><strong>MQTT must be enabled</strong>.
<ul>
<li>Thin-edge.io expects the collectd metrics to be published on the local MQTT bus.
Hence, you must enable the <a href="https://collectd.org/documentation/manpages/collectd.conf.5.shtml#plugin_mqtt">MQTT write plugin of collectd</a>.</li>
<li>The MQTT plugin is available on most distribution of <code>collectd</code>, but this is not the case on MacOS using homebrew.
If you are missing the MQTT plugin, please recompile <code>collectd</code> to include the MQTT plugin.
See <a href="https://github.com/collectd/collectd">https://github.com/collectd/collectd</a> for details.</li>
<li>Here is a config snippet to configure the MQTT write plugin:
<pre><code>   LoadPlugin mqtt

   &lt;Plugin mqtt&gt;
       &lt;Publish &quot;tedge&quot;&gt;
           Host &quot;localhost&quot;
           Port 1883
           ClientId &quot;tedge-collectd&quot;
       &lt;/Publish&gt;
   &lt;/Plugin&gt;
</code></pre>
</li>
</ul>
</li>
<li><strong>RRDTool and CSV might be disabled</strong>
<ul>
<li>The risk with these plugins is to run out of disk space on a small device.</li>
<li>With thin-edge.io the metrics collected by <code>collectd</code> are forwarded to the cloud,
hence it makes sense to <a href="https://github.com/collectd/collectd/issues/2668">disable Local storage</a>.</li>
<li>For that, simply comment out these two plugins:</li>
</ul>
<pre><code>   #LoadPlugin rrdtool
   #LoadPlugin csv
</code></pre>
</li>
<li><strong>Cherry-pick the collected metrics</strong>
<ul>
<li><code>Collectd</code> can collect a lot of detailed metrics,
and it doesn't always make sense to forward all these data to the cloud.</li>
<li>Here is a config snippet that uses the <code>match_regex</code> plugin to select the metrics of interest,
filtering out every metric emitted by the memory plugin other than the used metric&quot;:</li>
</ul>
<pre><code>    PreCacheChain &quot;PreCache&quot;

    LoadPlugin match_regex

    &lt;Chain &quot;PreCache&quot;&gt;
        &lt;Rule &quot;memory_free_only&quot;&gt;
            &lt;Match &quot;regex&quot;&gt;
                Plugin &quot;memory&quot;
            &lt;/Match&gt;
            &lt;Match &quot;regex&quot;&gt;
                TypeInstance &quot;used&quot;
                Invert true
            &lt;/Match&gt;
            Target &quot;stop&quot;
        &lt;/Rule&gt;
    &lt;/Chain&gt;
</code></pre>
</li>
</ol>
<h2 id="enable-thin-edge-monitoring"><a class="header" href="#enable-thin-edge-monitoring">Enable thin-edge monitoring</a></h2>
<p>To enable monitoring on your device, you have to launch the <code>tedge-mapper-collectd</code> daemon process.</p>
<pre><code class="language-shell">sudo systemctl enable tedge-mapper-collectd
sudo systemctl start tedge-mapper-collectd
</code></pre>
<p>This process subscribes to the <code>collectd/#</code> topics to read the monitoring metrics published by collectd
and emits the translated measurements in thin-edge.io JSON format to the <code>tedge/measurements</code> topic.
You can inspect the collected and translated metrics, by subscribing to these topics:</p>
<p>The metrics collected by <code>collectd</code> are emitted to subtopics named after the collectd plugin and the metric name:</p>
<pre><code>$ tedge mqtt sub 'collectd/#'

[collectd/raspberrypi/cpu/percent-active] 1623076679.154:0.50125313283208
[collectd/raspberrypi/memory/percent-used] 1623076679.159:1.10760866126707
[collectd/raspberrypi/cpu/percent-active] 1623076680.154:0
[collectd/raspberrypi/df-root/percent_bytes-used] 1623076680.158:71.3109359741211
[collectd/raspberrypi/memory/percent-used] 1623076680.159:1.10760866126707

</code></pre>
<p>The <code>tedge-mapper-collectd</code> translates these collectd measurements into the <a href="../architecture/thin-edge-json.html">thin-edge.io JSON</a> format,
<a href="../references/bridged-topics.html#collectd-topics">grouping the measurements</a> emitted by each plugin:</p>
<pre><code>tedge mqtt sub 'tedge/measurements'

[tedge/measurements] {&quot;time&quot;:&quot;2021-06-07T15:38:59.154895598+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;:0.50251256281407},&quot;memory&quot;:{&quot;percent-used&quot;:1.11893578135189}}
[tedge/measurements] {&quot;time&quot;:&quot;2021-06-07T15:39:00.154967388+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;:0},&quot;df-root&quot;:{&quot;percent_bytes-used&quot;:71.3110656738281},&quot;memory&quot;:{&quot;percent-used&quot;:1.12107875001658}}
</code></pre>
<p>From there, if the device is actually connected to a cloud platform like Cumulocity,
these monitoring metrics will be forwarded to the cloud.</p>
<pre><code>tedge mqtt sub 'c8y/#'
[c8y/measurement/measurements/create] {&quot;type&quot;: &quot;ThinEdgeMeasurement&quot;,&quot;time&quot;:&quot;2021-06-07T15:40:30.155037451+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;: {&quot;value&quot;: 0.753768844221106}},&quot;memory&quot;:{&quot;percent-used&quot;: {&quot;value&quot;: 1.16587699972141}},&quot;df-root&quot;:{&quot;percent_bytes-used&quot;: {&quot;value&quot;: 71.3117904663086}}}
[c8y/measurement/measurements/create] {&quot;type&quot;: &quot;ThinEdgeMeasurement&quot;,&quot;time&quot;:&quot;2021-06-07T15:40:31.154898577+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;: {&quot;value&quot;: 0.5}},&quot;memory&quot;:{&quot;percent-used&quot;: {&quot;value&quot;: 1.16608109197519}}}
</code></pre>
<p>If your device is not connected yet see:</p>
<ul>
<li><a href="./connect-c8y.html">Connect my device to Cumulocity IoT</a></li>
<li><a href="./connect-azure.html">Connect my device to Azure IoT</a></li>
</ul>
<h2 id="trouble-shooting"><a class="header" href="#trouble-shooting">Trouble shooting</a></h2>
<p>See here for <a href="../howto-guides/009_touble_shooting_monitoring.html">how to trouble shoot device monitoring?</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../tutorials/send-thin-edge-data.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../tutorials/software-management.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../tutorials/send-thin-edge-data.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../tutorials/software-management.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
