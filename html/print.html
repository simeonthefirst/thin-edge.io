<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>thin-edge.io docs</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="SUMMARY.html"><strong aria-hidden="true">1.</strong> Summary</a></li><li class="chapter-item "><a href="001_overview.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item "><a href="user_doc.html"><strong aria-hidden="true">3.</strong> User Documentation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="tutorials/index.html"><strong aria-hidden="true">3.1.</strong> Tutorials</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="tutorials/connect-c8y.html"><strong aria-hidden="true">3.1.1.</strong> Connect my device to Cumulocity IoT</a></li><li class="chapter-item "><a href="tutorials/connect-azure.html"><strong aria-hidden="true">3.1.2.</strong> Connect my device to Azure IoT</a></li><li class="chapter-item "><a href="tutorials/send-thin-edge-data.html"><strong aria-hidden="true">3.1.3.</strong> Send Thin Edge Json data</a></li><li class="chapter-item "><a href="tutorials/raise-alarm.html"><strong aria-hidden="true">3.1.4.</strong> Raise alarms</a></li><li class="chapter-item "><a href="tutorials/device-monitoring.html"><strong aria-hidden="true">3.1.5.</strong> Monitor my device</a></li><li class="chapter-item "><a href="tutorials/software-management.html"><strong aria-hidden="true">3.1.6.</strong> Manage my device software</a></li><li class="chapter-item "><a href="tutorials/write-my-software-management-plugin.html"><strong aria-hidden="true">3.1.7.</strong> Write my software management plugin</a></li><li class="chapter-item "><a href="tutorials/supported_operations.html"><strong aria-hidden="true">3.1.8.</strong> Supported Operations Management for Cumulocity IoT</a></li></ol></li><li class="chapter-item "><a href="howto-guides/index.html"><strong aria-hidden="true">3.2.</strong> How-to Guides</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="howto-guides/002_installation.html"><strong aria-hidden="true">3.2.1.</strong> Installation</a></li><li class="chapter-item "><a href="howto-guides/003_registration.html"><strong aria-hidden="true">3.2.2.</strong> How to create a test certificate</a></li><li class="chapter-item "><a href="howto-guides/004_connect.html"><strong aria-hidden="true">3.2.3.</strong> How to connect a cloud end-point</a></li><li class="chapter-item "><a href="howto-guides/005_pub_sub.html"><strong aria-hidden="true">3.2.4.</strong> How to send MQTT messages</a></li><li class="chapter-item "><a href="howto-guides/007_test_connection.html"><strong aria-hidden="true">3.2.5.</strong> How to test the cloud connection?</a></li><li class="chapter-item "><a href="howto-guides/008_config_local_mqtt_port.html"><strong aria-hidden="true">3.2.6.</strong> How to configure the local mqtt port</a></li><li class="chapter-item "><a href="howto-guides/009_trouble_shooting_monitoring.html"><strong aria-hidden="true">3.2.7.</strong> How to trouble shoot device monitoring</a></li><li class="chapter-item "><a href="howto-guides/010_add_self_signed_trusted.html"><strong aria-hidden="true">3.2.8.</strong> How to add self-signed certificate root to trusted certificates list?</a></li><li class="chapter-item "><a href="howto-guides/011_retrieve_jwt_token_from_cumulocity.html"><strong aria-hidden="true">3.2.9.</strong> How to retrieve JWT token from Cumulocity?</a></li><li class="chapter-item "><a href="howto-guides/012_install_and_enable_software_management.html"><strong aria-hidden="true">3.2.10.</strong> How to install and enable software management?</a></li><li class="chapter-item "><a href="howto-guides/013_connect_external_device.html"><strong aria-hidden="true">3.2.11.</strong> How to connect an external device?</a></li><li class="chapter-item "><a href="howto-guides/014_thin_edge_logs.html"><strong aria-hidden="true">3.2.12.</strong> How to access the logs on the device?</a></li><li class="chapter-item "><a href="howto-guides/015_installation_without_deb_support.html"><strong aria-hidden="true">3.2.13.</strong> How to install thin-edge.io on any Linux OS (no deb support)?</a></li><li class="chapter-item "><a href="howto-guides/016_restart_device_operation.html"><strong aria-hidden="true">3.2.14.</strong> How to restart your thin-edge.io device</a></li><li class="chapter-item "><a href="howto-guides/017_apama_software_management_plugin.html"><strong aria-hidden="true">3.2.15.</strong> How to use apama software management plugin</a></li><li class="chapter-item "><a href="howto-guides/018_change_temp_path.html"><strong aria-hidden="true">3.2.16.</strong> How to change temp path</a></li><li class="chapter-item "><a href="howto-guides/019_how_to_use_preferred_init_system.html"><strong aria-hidden="true">3.2.17.</strong> How to use thin-edge.io with your preferred init system</a></li></ol></li></ol></li><li class="chapter-item "><a href="dev_doc.html"><strong aria-hidden="true">4.</strong> Developer Documentation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="architecture/index.html"><strong aria-hidden="true">4.1.</strong> Architecture</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="architecture/thin-edge-json.html"><strong aria-hidden="true">4.1.1.</strong> Thin Edge Json</a></li><li class="chapter-item "><a href="architecture/mapper.html"><strong aria-hidden="true">4.1.2.</strong> The Mapper</a></li><li class="chapter-item "><a href="architecture/software-management.html"><strong aria-hidden="true">4.1.3.</strong> Software Management</a></li><li class="chapter-item "><a href="architecture/faq.html"><strong aria-hidden="true">4.1.4.</strong> Architecture FAQ</a></li><li class="chapter-item "><a href="supported-platforms.html"><strong aria-hidden="true">4.1.5.</strong> Platform support</a></li><li class="chapter-item "><a href="references/init-system-config.html"><strong aria-hidden="true">4.1.6.</strong> Init System configuration</a></li></ol></li><li class="chapter-item "><a href="tutorials/write-my-software-management-plugin.html"><strong aria-hidden="true">4.2.</strong> Write my own software management plugin</a></li><li class="chapter-item "><a href="api.html"><strong aria-hidden="true">4.3.</strong> APIs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="references/bridged-topics.html"><strong aria-hidden="true">4.3.1.</strong> The Bridged Topics</a></li><li class="chapter-item "><a href="references/plugin-api.html"><strong aria-hidden="true">4.3.2.</strong> The Software Management Plugin API</a></li></ol></li><li class="chapter-item "><a href="BUILDING.html"><strong aria-hidden="true">4.4.</strong> Building</a></li></ol></li><li class="chapter-item "><a href="references/index.html"><strong aria-hidden="true">5.</strong> Command Line Reference</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="references/tedge.html"><strong aria-hidden="true">5.1.</strong> The tedge command</a></li><li class="chapter-item "><a href="references/tedge-config.html"><strong aria-hidden="true">5.2.</strong> The tedge config command</a></li><li class="chapter-item "><a href="references/tedge-cert.html"><strong aria-hidden="true">5.3.</strong> The tedge cert command</a></li><li class="chapter-item "><a href="references/tedge-connect.html"><strong aria-hidden="true">5.4.</strong> The tedge connect command</a></li><li class="chapter-item "><a href="references/tedge-disconnect.html"><strong aria-hidden="true">5.5.</strong> The tedge disconnect command</a></li><li class="chapter-item "><a href="references/tedge-mqtt.html"><strong aria-hidden="true">5.6.</strong> The tedge mqtt command</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">thin-edge.io docs</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="summary"><a class="header" href="#summary">Summary</a></h1>
<ul>
<li>
<p><a href="./SUMMARY.html">Summary</a></p>
</li>
<li>
<p><a href="001_overview.html">Introduction</a></p>
</li>
<li>
<p><a href="user_doc.html">User Documentation</a></p>
<ul>
<li>
<p><a href="tutorials/README.html">Tutorials</a></p>
<ul>
<li><a href="./tutorials/connect-c8y.html">Connect my device to Cumulocity IoT</a></li>
<li><a href="./tutorials/connect-azure.html">Connect my device to Azure IoT</a></li>
<li><a href="./tutorials/send-thin-edge-data.html">Send Thin Edge Json data</a></li>
<li><a href="./tutorials/raise-alarm.html">Raise alarms</a></li>
<li><a href="./tutorials/device-monitoring.html">Monitor my device</a></li>
<li><a href="./tutorials/software-management.html">Manage my device software</a></li>
<li><a href="./tutorials/write-my-software-management-plugin.html">Write my software management plugin</a></li>
<li><a href="./tutorials/supported_operations.html">Supported Operations Management for Cumulocity IoT</a></li>
</ul>
</li>
<li>
<p><a href="howto-guides/README.html">How-to Guides</a></p>
<ul>
<li><a href="howto-guides/002_installation.html">Installation</a></li>
<li><a href="./howto-guides/003_registration.html">How to create a test certificate</a></li>
<li><a href="./howto-guides/004_connect.html">How to connect a cloud end-point</a></li>
<li><a href="./howto-guides/005_pub_sub.html">How to send MQTT messages</a></li>
<li><a href="./howto-guides/007_test_connection.html">How to test the cloud connection?</a></li>
<li><a href="./howto-guides/008_config_local_mqtt_port.html">How to configure the local mqtt port</a></li>
<li><a href="./howto-guides/009_trouble_shooting_monitoring.html">How to trouble shoot device monitoring</a></li>
<li><a href="./howto-guides/010_add_self_signed_trusted.html">How to add self-signed certificate root to trusted certificates list?</a></li>
<li><a href="./howto-guides/011_retrieve_jwt_token_from_cumulocity.html">How to retrieve JWT token from Cumulocity?</a></li>
<li><a href="./howto-guides/012_install_and_enable_software_management.html">How to install and enable software management?</a></li>
<li><a href="./howto-guides/013_connect_external_device.html">How to connect an external device?</a></li>
<li><a href="./howto-guides/014_thin_edge_logs.html">How to access the logs on the device?</a></li>
<li><a href="./howto-guides/015_installation_without_deb_support.html">How to install thin-edge.io on any Linux OS (no deb support)?</a></li>
<li><a href="./howto-guides/016_restart_device_operation.html">How to restart your thin-edge.io device</a></li>
<li><a href="./howto-guides/017_apama_software_management_plugin.html">How to use apama software management plugin</a></li>
<li><a href="./howto-guides/018_change_temp_path.html">How to change temp path</a></li>
<li><a href="./howto-guides/019_how_to_use_preferred_init_system.html">How to use thin-edge.io with your preferred init system</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="dev_doc.html">Developer Documentation</a></p>
<ul>
<li>
<p><a href="architecture/README.html">Architecture</a></p>
<ul>
<li><a href="architecture/thin-edge-json.html">Thin Edge Json</a></li>
<li><a href="architecture/mapper.html">The Mapper</a></li>
<li><a href="architecture/software-management.html">Software Management</a></li>
<li><a href="architecture/faq.html">Architecture FAQ</a></li>
<li><a href="supported-platforms.html">Platform support</a></li>
<li><a href="references/init-system-config.html">Init System configuration</a></li>
</ul>
</li>
<li>
<p><a href="./tutorials/write-my-software-management-plugin.html">Write my own software management plugin</a></p>
</li>
<li>
<p><a href="api.html">APIs</a></p>
<ul>
<li><a href="./references/bridged-topics.html">The Bridged Topics</a></li>
<li><a href="./references/plugin-api.html">The Software Management Plugin API</a></li>
</ul>
</li>
<li>
<p><a href="./BUILDING.html">Building</a></p>
</li>
</ul>
</li>
<li>
<p><a href="references/README.html">Command Line Reference</a></p>
<ul>
<li><a href="./references/tedge.html">The <code>tedge</code> command</a></li>
<li><a href="./references/tedge-config.html">The <code>tedge config</code> command</a></li>
<li><a href="./references/tedge-cert.html">The <code>tedge cert</code> command</a></li>
<li><a href="./references/tedge-connect.html">The <code>tedge connect</code> command</a></li>
<li><a href="./references/tedge-disconnect.html">The <code>tedge disconnect</code> command</a></li>
<li><a href="./references/tedge-mqtt.html">The <code>tedge mqtt</code> command</a></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<h2 id="why-thin-edgeio"><a class="header" href="#why-thin-edgeio">Why <code>thin-edge.io</code></a></h2>
<p>An open-source &amp; cloud-agnostic IoT framework designed for resource-constrained Edge devices.</p>
<ul>
<li>Simple and secure device connectivity.</li>
<li>Freedom of cloud platform.</li>
<li>Freedom of programming language.</li>
</ul>
<h2 id="how-to-start"><a class="header" href="#how-to-start">How to start</a></h2>
<ol>
<li>The very first step is to <a href="howto-guides/002_installation.html">install <code>thin-edge.io</code></a>
and to connect your device to your IoT cloud,
either <a href="tutorials/connect-c8y.html">Cumulocity IoT</a>
or <a href="tutorials/connect-azure.html">Azure IoT</a> (10 minutes).</li>
<li>You will then be able to <a href="tutorials/send-thin-edge-data.html">send telemetry data</a> to the cloud
using a <a href="architecture/thin-edge-json.html">cloud-agnostic message format</a> (5 minutes).</li>
<li>The next step is to write your own telemetry component, using your preferred programming language,
say Rust or Python.</li>
</ol>
<h2 id="grow-your-skills"><a class="header" href="#grow-your-skills">Grow your skills</a></h2>
<ul>
<li>Explore the <a href="tutorials/README.html">tutorials and use-cases</a>.</li>
<li>Understand the <a href="architecture/README.html">architecture</a>.</li>
<li>Use the <a href="howto-guides/README.html">how-to guides</a> on a daily basis.</li>
<li>Refer to the <a href="references/README.html">reference guides</a> for any in-depth details.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="user-documentation"><a class="header" href="#user-documentation">User Documentation</a></h1>
<p>This part of the documentation is meant for users, that want to use thin-edge.io with the feature set that is provided. If you want to develop something on top of thin-edge.io, head over to the <a href="dev_doc.html">Developer Documentation</a>. Even if you do not yet plan to develop for thin-edge.io some of the contents there might be of interest to you to get a deeper technical understanding.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tutorials"><a class="header" href="#tutorials">Tutorials</a></h1>
<ul>
<li><a href="tutorials/./connect-c8y.html">Connect my device to Cumulocity IoT</a></li>
<li><a href="tutorials/./connect-azure.html">Connect my device to Azure IoT</a></li>
<li><a href="tutorials/./send-thin-edge-data.html">Send Thin Edge Json data</a></li>
<li><a href="tutorials/./device-monitoring.html">Monitor my device</a></li>
<li><a href="tutorials/./software-management.html">Manage my device software</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="connect-your-device-to-cumulocity-iot"><a class="header" href="#connect-your-device-to-cumulocity-iot">Connect your device to Cumulocity IoT</a></h1>
<p>The very first step to enable <code>thin-edge.io</code> is to connect your device to the cloud.</p>
<ul>
<li>This is a 10 minutes operation to be done only once.</li>
<li>It establishes a permanent connection from your device to the cloud end-point.</li>
<li>This connection is secure (encrypted over TLS), and the two peers are identified by x509 certificates.</li>
<li>Sending data to the cloud will then be as simple as sending data locally.</li>
</ul>
<p>The focus is here on connecting to <a href="https://www.cumulocity.com/guides/concepts/introduction/">Cumulocity IoT</a>.
See this <a href="tutorials/connect-azure.html">tutorial</a>, if you want to connect Azure IoT instead.</p>
<p>Before you try to connect your device to Cumulocity IoT, you need:</p>
<ul>
<li>The url of the endpoint to connect (e.g. <code>eu-latest.cumulocity.com</code>).</li>
<li>Your credentials to connect Cumulocity:
<ul>
<li>Your tenant identifier (e.g. <code>t00000007</code>), a user name and password.</li>
<li>None of these credentials will be stored on the device.</li>
<li>These are only required once, to register the device.</li>
</ul>
</li>
</ul>
<p>If not done yet, <a href="tutorials/../howto-guides/002_installation.html">install <code>thin-edge.io</code> on your device</a>.</p>
<p>You can now use the <a href="tutorials/../references/tedge.html"><code>tedge</code> command</a> to:</p>
<ul>
<li><a href="tutorials/connect-c8y.html#create-the-certificate">create a certificate for you device</a>,</li>
<li><a href="tutorials/connect-c8y.html#make-the-device-trusted-by-cumulocity">make the device certificate trusted by Cumulocity</a>,</li>
<li><a href="tutorials/connect-c8y.html#connect-the-device">connect the device</a>, and</li>
<li><a href="tutorials/connect-c8y.html#sending-your-first-telemetry-data">send your first telemetry data</a>.</li>
</ul>
<h2 id="configure-the-device"><a class="header" href="#configure-the-device">Configure the device</a></h2>
<p>To connect the device to the Cumulocity IoT, one needs to set the URL of your Cumulocity IoT tenant and the root certificate as below.</p>
<p>Set the URL of your Cumulocity IoT tenant.</p>
<pre><code>$ sudo tedge config set c8y.url your-tenant.cumulocity.com
</code></pre>
<p>Set the path to the root certificate if necessary. The default is <code>/etc/ssl/certs</code>.</p>
<pre><code>$ sudo tedge config set c8y.root.cert.path /etc/ssl/certs
</code></pre>
<p>This will set the root certificate path of the Cumulocity IoT.
In most of the Linux flavors, the certificate will be present in /etc/ssl/certs.
If not found download it from <a href="https://www.identrust.com/dst-root-ca-x3">here</a>.</p>
<h2 id="create-the-certificate"><a class="header" href="#create-the-certificate">Create the certificate</a></h2>
<p>The <code>tedge cert create</code> command creates a self-signed certificate which can be used for testing purpose.</p>
<p>A single argument is required: an identifier for the device.
This identifier will be used to uniquely identify your devices among others in your cloud tenant.
This identifier will be also used as the Common Name (CN) of the certificate.
Indeed, this certificate aims to authenticate that this device is actually the device with that identity.</p>
<pre><code>$ sudo tedge cert create --device-id my-device
</code></pre>
<p>You can then check the content of that certificate.</p>
<pre><code>$ sudo tedge cert show
Device certificate: /etc/tedge/device-certs/tedge-certificate.pem
Subject: CN=my-device, O=Thin Edge, OU=Test Device
Issuer: CN=my-device, O=Thin Edge, OU=Test Device
Valid from: Tue, 09 Feb 2021 17:16:52 +0000
Valid up to: Tue, 11 May 2021 17:16:52 +0000
Thumbprint: CDBF4EC17AA02829CAC4E4C86ABB82B0FE423D3E
</code></pre>
<p>You may notice that the issuer of this certificate is the device itself.
This is a self-signed certificate.
To use a certificate signed by your Certificate Authority,
see the reference guide of <a href="tutorials/../references/tedge-cert.html"><code>tedge cert</code></a>.</p>
<h2 id="make-the-device-trusted-by-cumulocity"><a class="header" href="#make-the-device-trusted-by-cumulocity">Make the device trusted by Cumulocity</a></h2>
<p>For a certificate to be trusted by Cumulocity,
one needs to add the certificate of the signing authority to the list of trusted certificates.
In the Cumulocity GUI, navigate to &quot;Device Management/Management/Trusted certificates&quot;
in order to see this list for your Cumulocity tenant.</p>
<p>Here, the device certificate is self-signed and has to be directly trusted by Certificate.
This can be done:</p>
<ul>
<li>either with the GUI: upload the certificate from your device (<code>/etc/tedge/device-certs/tedge-certificate.pem</code>)
to your tenant &quot;Device Management/Management/Trusted certificates&quot;.</li>
<li>or using the <code>tedge cert upload c8y</code> command.</li>
</ul>
<pre><code>$ sudo tedge cert upload c8y --user &lt;username&gt;
</code></pre>
<blockquote>
<p>To upload the certificate to cumulocity this user needs to have &quot;Tenant management&quot; admin rights. If you get an error 503 here, check the appropriate rights in cumulocity user management.</p>
</blockquote>
<h2 id="connect-the-device"><a class="header" href="#connect-the-device">Connect the device</a></h2>
<p>Now, you are ready to run <code>tedge connect c8y</code>.
This command configures the MQTT broker:</p>
<ul>
<li>to establish a permanent and secure connection to the cloud,</li>
<li>to forward local messages to the cloud and vice versa.</li>
</ul>
<p>Also, if you have installed <code>tedge_mapper</code>, this command starts and enables the tedge-mapper-c8y systemd service.
At last, it sends packets to Cumulocity to check the connection.
If your device is not yet registered, you will find the digital-twin created in your tenant after <code>tedge connect c8y</code>!</p>
<pre><code class="language-shell">$ sudo tedge connect c8y
Checking if systemd is available.

Checking if configuration for requested bridge already exists.

Validating the bridge certificates.

Saving configuration for requested bridge.

Restarting mosquitto service.

Awaiting mosquitto to start. This may take up to 5 seconds.

Enabling mosquitto service on reboots.

Successfully created bridge connection!

Checking if tedge-mapper is installed.

Starting tedge-mapper-c8y service.

Persisting tedge-mapper-c8y on reboot.

tedge-mapper-c8y service successfully started and enabled!

Sending packets to check connection. This may take up to 10 seconds.

Try 1 / 2: Sending a message to Cumulocity.
Received expected response message, connection check is successful.

Enabling software management.

Checking if tedge-agent is installed.

Starting tedge-agent service.

Persisting tedge-agent on reboot.

tedge-agent service successfully started and enabled!

Starting tedge-mapper-sm-c8y service.

Persisting tedge-mapper-sm-c8y on reboot.

tedge-mapper-sm-c8y service successfully started and enabled!
</code></pre>
<h2 id="sending-your-first-telemetry-data"><a class="header" href="#sending-your-first-telemetry-data">Sending your first telemetry data</a></h2>
<p>Sending data to Cumulocity is done using MQTT over topics prefixed with <code>c8y</code>.
Any messages sent to one of these topics will be forwarded to Cumulocity.
The messages are expected to have a format specific to each topic.
Here, we use <code>tedge mqtt pub</code> a raw Cumulocity SmartRest message to be understood as a temperature of 20 Celsius.</p>
<pre><code>$ tedge mqtt pub c8y/s/us 211,20
</code></pre>
<p>To check that this message has been received by Cumulocity,
navigate to &quot;Device Management/Devices/All devices/&lt;your device id&gt;/Measurements&quot;.
You should observe a &quot;temperature measurement&quot; graph with the new data point.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>You can now:</p>
<ul>
<li>learn how to <a href="tutorials/send-thin-edge-data.html">send various kind of telemetry data</a>
using the cloud-agnostic <a href="tutorials/../architecture/thin-edge-json.html">Thin-Edge-Json data format</a>,</li>
<li>or have a detailed view of the <a href="tutorials/../references/bridged-topics.html#cumulocity-mqtt-topics">topics mapped to and from Cumulocity</a>
if you prefer to use directly Cumulocity specific formats and protocols.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="connect-your-device-to-azure-iot"><a class="header" href="#connect-your-device-to-azure-iot">Connect your device to Azure IoT</a></h1>
<p>The very first step to enable <strong>thin-edge.io</strong> is to connect your device to the cloud.</p>
<ul>
<li>This is a 10 minutes operation to be done only once.</li>
<li>It establishes a permanent connection from your device to the cloud end-point.</li>
<li>This connection is secure (encrypted over TLS), and the two peers are identified by x509 certificates.</li>
<li>Sending data to the cloud will then be as simple as sending data locally.</li>
</ul>
<p>The focus is here on connecting the device to Azure IoT.
See this <a href="tutorials/connect-c8y.html">tutorial</a>, if you want to connect Cumulocity IoT instead.</p>
<p>Before you try to connect your device to Azure IoT, you need:</p>
<ul>
<li>Create a Azure <strong>IoT Hub</strong> in Azure portal as described <a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-create-through-portal">here</a>.</li>
<li><a href="tutorials/../howto-guides/002_installation.html">Install <code>thin-edge.io</code> on your device</a>.</li>
</ul>
<p>You can now use <a href="tutorials/../references/tedge.html"><code>tedge</code> command</a> to:</p>
<ul>
<li><a href="tutorials/connect-azure.html#create-the-certificate">create a certificate for your device</a>,</li>
<li><a href="tutorials/connect-azure.html#register-the-device-on-Azure">register the device on Azure IoT Hub</a>,</li>
<li><a href="tutorials/connect-azure.html#configure-the-device">configure the device</a>,</li>
<li><a href="tutorials/connect-azure.html#connect-the-device">connect the device</a>, and</li>
<li><a href="tutorials/connect-azure.html#sending-your-first-telemetry-data">send your first telemetry data</a>.</li>
</ul>
<h2 id="create-the-certificate-1"><a class="header" href="#create-the-certificate-1">Create the certificate</a></h2>
<p>The <code>tedge cert create</code> command creates a self-signed certificate which can be used for testing purpose.</p>
<p>A single argument is required: an identifier for the device.
This identifier will be used to uniquely identify your devices among others in your cloud tenant.
This identifier will be also used as the Common Name (CN) of the certificate.
Indeed, this certificate aims to authenticate that this device is the device with that identity.</p>
<pre><code>$ sudo tedge cert create --device-id my-device
</code></pre>
<h2 id="show-certificate-details"><a class="header" href="#show-certificate-details">Show certificate details</a></h2>
<p>You can then check the content of that certificate.</p>
<pre><code>$ sudo tedge cert show
Device certificate: /etc/tedge/device-certs/tedge-certificate.pem
Subject: CN=my-device, O=Thin Edge, OU=Test Device
Issuer: CN=my-device, O=Thin Edge, OU=Test Device
Valid from: Tue, 09 Mar 2021 14:10:30 +0000
Valid up to: Thu, 10 Mar 2022 14:10:30 +0000
Thumbprint: 860218AD0A996004449521E2713C28F67B5EA580
</code></pre>
<p>You may notice that the issuer of this certificate is the device itself.
This is a self-signed certificate.
The Thumbprint is the Sha1sum of the certificate. This is required for registering the
device using the self-signed certificate on Azure IoT Hub.
To use a certificate signed by your Certificate Authority,
see the reference guide of <a href="tutorials/../references/tedge-cert.html"><code>tedge cert</code></a>.</p>
<h2 id="register-the-device-on-azure-iot-hub"><a class="header" href="#register-the-device-on-azure-iot-hub">Register the device on Azure IoT Hub</a></h2>
<p>For a device to be trusted by Azure, one needs to add the self-signed certificate thumbprint to the Azure IoT Hub Portal.
In the Azure IoT Hub Portal, navigate to &quot;Explores&quot;-&gt;&quot;IoT Devices&quot; click on &quot;+ New&quot;, this will open a new blade &quot;Create a device&quot;.</p>
<p>Here provide the configuration parameters that are required to create the device as described below.</p>
<ul>
<li>Device ID: Should be the same as the Subject of the certificate.</li>
<li>Authentication type: Select <strong>X.509 Self-Signed</strong> option.
<ul>
<li>Provide the Primary Thumbprint that was displayed in <a href="tutorials/connect-azure.html#show-certificate-details"><code>tedge cert show</code></a>.</li>
<li>Use the same for the Secondary Thumbprint as well (Since we are using a single certificate).</li>
</ul>
</li>
<li>Set &quot;Connect this device to an IoT Hub&quot; to <strong>Enable</strong>.</li>
<li>Then save the configuration.
Upon successfully saved the configuration a new device has been created on the IoT Hub.
The new device can be seen on the IoT Hub portal by navigating to &quot;Explores&quot;-&gt;&quot;IoT Devices&quot;.</li>
</ul>
<p>More info about registering a device can be found <a href="https://docs.microsoft.com/en-us/azure/iot-edge/how-to-authenticate-downstream-device?view=iotedge-2018-06">here</a></p>
<h2 id="configure-the-device-1"><a class="header" href="#configure-the-device-1">Configure the device</a></h2>
<p>To connect the device to the Azure IoT Hub, one needs to set the URL/Hostname of the IoT Hub and the root certificate of the IoT Hub as below.</p>
<p>Set the URL/Hostname of your Azure IoT Hub.</p>
<pre><code>sudo tedge config set az.url your-iot-hub-name.azure-devices.net
</code></pre>
<p>The URL/Hostname can be found in the Azure web portal, clicking on the overview section of your IoT Hub.</p>
<p>Set the path to the root certificate if necessary. The default is <code>/etc/ssl/certs</code>.</p>
<pre><code>sudo tedge config set az.root.cert.path /etc/ssl/certs/Baltimore_CyberTrust_Root.pem
</code></pre>
<p>This will set the root certificate path of the Azure IoT Hub.
In most of the Linux flavors, the certificate will be present in /etc/ssl/certs. If not found download it from <a href="https://www.digicert.com/kb/digicert-root-certificates.htm">here</a>.</p>
<h2 id="connect-the-device-1"><a class="header" href="#connect-the-device-1">Connect the device</a></h2>
<p>Now, you are ready to get your device connected to Azure IoT Hub with <code>tedge connect az</code>.
This command configures the MQTT broker:</p>
<ul>
<li>to establish a permanent and secure connection to the Azure cloud,</li>
<li>to forward local messages to the cloud and vice versa.</li>
</ul>
<p>Also, if you have installed <code>tedge_mapper</code>, this command starts and enables the tedge-mapper-az systemd service.
At last, it sends packets to Azure IoT Hub to check the connection.</p>
<pre><code>$ sudo tedge connect az

Checking if systemd is available.

Checking if configuration for requested bridge already exists.

Validating the bridge certificates.

Saving configuration for requested bridge.

Restarting mosquitto service.

Awaiting mosquitto to start. This may take up to 5 seconds.

Persisting mosquitto on reboot.

Successfully created bridge connection!

Checking if tedge-mapper is installed.

Starting tedge-mapper service.

Persisting tedge-mapper on reboot.

tedge-mapper service successfully started and enabled!

Sending packets to check connection. This may take up to 10 seconds.

Received expected response message, connection check is successful.
</code></pre>
<h2 id="sending-your-first-telemetry-data-1"><a class="header" href="#sending-your-first-telemetry-data-1">Sending your first telemetry data</a></h2>
<p>Sending data to Azure is done using MQTT over topics prefixed with <code>az</code>.
Any messages sent on the topic will be forwarded to Azure.
Here, we use <code>tedge mqtt pub az/messages/events/</code> a message to be understood as a temperature of 20 Degree.</p>
<pre><code>$ tedge mqtt pub az/messages/events/ '{&quot;temperature&quot;: 20}'
</code></pre>
<p>To view the messages that were sent from the device to the cloud, follow this <a href="https://docs.microsoft.com/en-us/azure/iot-hub/quickstart-send-telemetry-cli#create-and-monitor-a-device">document</a>.</p>
<p>More info about sending telemetry to Azure can be found <a href="https://docs.microsoft.com/en-us/azure/iot-hub/quickstart-send-telemetry-dotnet">here</a></p>
<h2 id="next-steps-1"><a class="header" href="#next-steps-1">Next Steps</a></h2>
<p>You can now:</p>
<ul>
<li>learn how to <a href="tutorials/send-thin-edge-data.html">send various kind of telemetry data</a>
using the cloud-agnostic <a href="tutorials/../architecture/thin-edge-json.html">Thin-Edge-Json data format</a>,</li>
<li>or have a detailed view of the <a href="tutorials/../references/bridged-topics.html#azure-mqtt-topics">topics mapped to and from Azure</a>
if you prefer to use directly Azure specific formats and protocols.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="send-thin-edge-json-data"><a class="header" href="#send-thin-edge-json-data">Send Thin Edge JSON data</a></h1>
<p>Once your Thin Edge device is configured and connected to an IoT cloud provider, you can start sending measurements.
Refer to <a href="tutorials/../tutorials/connect-c8y.html">Connecting to Cumulocity</a> or tutorials for other cloud providers 
to learn how to connect your Thin Edge device to an IoT cloud provider. </p>
<p>In this tutorial, we'll see how different kinds of measurements are represented in Thin Edge JSON format and 
how they can be sent to the connected cloud provider.
For a more detailed specification of this data format, refer to <a href="tutorials/../architecture/thin-edge-json.html">Thin Edge JSON Specification</a>.</p>
<h2 id="sending-measurements"><a class="header" href="#sending-measurements">Sending measurements</a></h2>
<p>A simple single-valued measurement like a temperature measurement, can be represented in Thin Edge JSON as follows:</p>
<pre><code class="language-json">{ &quot;temperature&quot;: 25 }
</code></pre>
<p>with the key-value pair representing the measurement type and the numeric value of the measurement.</p>
<p>This measurement can be sent from the Thin Edge device to the cloud by publishing this message to the <code>tedge/measurements</code> MQTT topic.
Processes running on the Thin Edge device can publish messages to the local MQTT broker using any MQTT client or library.
In this tutorial, we'll be using the <code>tedge mqtt pub</code> command line utility for demonstration purposes.</p>
<p>The temperature measurement described above can be sent using the <code>tedge mqtt pub</code> command as follows:</p>
<pre><code class="language-shell">$ tedge mqtt pub tedge/measurements '{ &quot;temperature&quot;: 25 }'
</code></pre>
<p>The first argument to the <code>tedge mqtt pub</code> command is the topic to which the measurements must be published to.
The second argument is the Thin Edge JSON representation of the measurement itself.</p>
<p>When connected to a cloud provider, a message mapper component for that cloud provider would be running as a daemon, 
listening to any measurements published to <code>tedge/measurements</code>.
The mapper, on receipt of these Thin Edge JSON measurements, will map those measurements to their equivalent
cloud provider native representation and send it to that cloud.</p>
<p>For example, when the device is connected to Cumulocity, the Cumulocity mapper component will be performing these actions.
To check if these measurements have reached Cumulocity, login to your Cumulocity dashboard and navigate to
<em>Device Management =&gt; Devices =&gt; All devices =&gt; <your device id> =&gt; Measurements</em> 
and see if your temperature measurement is appearing in the dashboard.</p>
<h2 id="complex-measurements"><a class="header" href="#complex-measurements">Complex measurements</a></h2>
<p>You can represent measurements that are far more complex than the single-valued ones described above using the Thin Edge JSON format.</p>
<p>A multi-valued measurement like <code>three_phase_current</code> that consists of <code>L1</code>, <code>L2</code> and <code>L3</code> values,
representing the current on each phase can be represented as follows:</p>
<pre><code class="language-json">{
  &quot;three_phase_current&quot;: {
    &quot;L1&quot;: 9.5,
    &quot;L2&quot;: 10.3,
    &quot;L3&quot;: 8.8
  }
}
</code></pre>
<p>Here is another complex message consisting of single-valued measurements: <code>temperature</code> and <code>pressure</code> 
along with a multi-valued <code>coordinate</code> measurement, all sharing a single timestamp captured as <code>time</code>.</p>
<pre><code class="language-json">{
  &quot;time&quot;: &quot;2020-10-15T05:30:47+00:00&quot;,
  &quot;temperature&quot;: 25,
  &quot;current&quot;: {
    &quot;L1&quot;: 9.5,
    &quot;L2&quot;: 10.3,
    &quot;L3&quot;: 8.8
  },
  &quot;pressure&quot;: 98
}
</code></pre>
<p>The <code>time</code> field is not a regular measurement like <code>temperature</code> or <code>pressure</code> but a special reserved field.
Refer to <a href="tutorials/../architecture/thin-edge-json.html">Thin Edge JSON Specification</a> for more details on the kinds of telemetry 
data that can be represented in Thin Edge JSON format and the reserved fields like <code>time</code> used in the above example.</p>
<h2 id="sending-measurements-to-child-devices"><a class="header" href="#sending-measurements-to-child-devices">Sending measurements to child devices</a></h2>
<blockquote>
<p>Note: Currently this feature supports Cumulocity IoT only.</p>
</blockquote>
<p>If valid Thin Edge JSON measurements are published to the <code>tedge/measurements/&lt;child-id&gt;</code> topic,
the measurements are recorded under a child device of your thin-edge.io device.</p>
<p>Given your desired child device ID is <code>child1</code>, publish a Thin Edge JSON message to the <code>tedge/measurements/child1</code> topic:</p>
<pre><code class="language-shell">$ tedge mqtt pub tedge/measurements/child1 '{ &quot;temperature&quot;: 25 }'
</code></pre>
<p>Then, you will see a child device with the name <code>child1</code> is created in your Cumulocity IoT tenant,
and the measurement is recorded in <code>Measurements</code> of the <code>child1</code> device.</p>
<h2 id="error-detection"><a class="header" href="#error-detection">Error detection</a></h2>
<p>If the data published to the <code>tedge/measurements</code> topic are not valid Thin Edge JSON measurements, those won't be
sent to the cloud but instead you'll get a feedback on the <code>tedge/errors</code> topic, if you subscribe to it.
The error messages published to this topic will be highly verbose and may change in the future.
So, use it only for debugging purposes during the development phase and it should <strong>not</strong> be used for any automation.</p>
<p>You can use the <code>tedge mqtt sub</code> command to subscribe to the error topic as follows:</p>
<pre><code class="language-shell">$ tedge mqtt sub tedge/errors
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="thin-edge-alarm"><a class="header" href="#thin-edge-alarm">Thin Edge Alarm</a></h1>
<p>Alarms on thin-edge.io can be used to create alerts, represent state changes etc.
For example, an alarm can be raised when a certain measurement value breaches some threshold (like high temperature) or when an unexpected event occurs in the system (like a sensor failure).</p>
<p>A typical alarm cycle starts by the raising of an alarm by some monitoring process which alerts a system/human of an event needing some action.
Once some action is taken, the alarm is cleared explicitly by that system/human.</p>
<p>Every alarm is uniquely identified by its type and severity.
That is, for a given alarm type, alarms of varying severities are treated as independent alarms and hence, must be acted upon separately.
For an alarm of a given type and severity, only the last known state is considered relevant.
Thin-edge.io doesn't keep a history of all its state changes but only reacts to the last one it receives.</p>
<h2 id="raising-an-alarm"><a class="header" href="#raising-an-alarm">Raising an alarm</a></h2>
<p>An alarm can be raised on thin-edge.io by sending an MQTT message in Thin Edge JSON format to certain MQTT topics.</p>
<p>The scheme of the topic to publish the alarm data is as follows:</p>
<p><code>tedge/alarms/&lt;severity&gt;/&lt;alarm-type&gt;</code></p>
<p>The payload format must be as follows:</p>
<pre><code class="language-json">{
    &quot;message&quot;: &quot;&lt;message text&gt;&quot;,
    &quot;time&quot;: &quot;&lt;Timestamp in ISO-8601 format&gt;&quot;
}
</code></pre>
<blockquote>
<p>Note: These messages must be sent with MQTT retained flag enabled and with QOS &gt; 1 to ensure guaranteed processing by thin-edge.io.
Enabling the retained flag ensures that the alarm stays persisted with the MQTT broker until its state changes again.
These retained messages will make sure that the thin-edge.io processes or any other third-party processes subscribed to these alarms will get those, even if they were down at the moment the alarm was raised.
If multiple messages are sent to the same alarm topic, the last alarm is considered to have overwritten the previous one.</p>
</blockquote>
<p>Here is a sample alarm raised for <code>temperature_high</code> alarm type with <code>critical</code> severity:</p>
<p>Topic: 
<code>tedge/alarms/critical/temperature_high</code></p>
<p>Payload:</p>
<pre><code class="language-json">{
    &quot;message&quot;: &quot;Temperature is very high&quot;,
    &quot;time&quot;: &quot;&quot;2021-01-01T05:30:45+00:00&quot;&quot;
}
</code></pre>
<blockquote>
<p>Note: Both the <code>message</code> field and the <code>time</code> field are optional.
When a <code>message</code> is not provided, it is assumed to be empty.
When <code>time</code> is not provided, thin-edge.io will use the current system time as the <code>time</code> of the alarm.
When you want to skip both fields, use an empty json fragment <code>{}</code> as the payload to indicate the same.
An empty message can't be used for the same as empty messages are used to clear alarms, which is discussed in the next section.</p>
</blockquote>
<p>The <code>&lt;severity&gt;</code> value in the MQTT topic can only be one of the following values:</p>
<ol>
<li>critical</li>
<li>major</li>
<li>minor</li>
<li>warning</li>
</ol>
<p>There are no such restrictions on the <code>&lt;alarm-type&gt;</code> value.</p>
<p>Thin-edge.io doesn't keep any history of all alarms raised on an alarm topic.</p>
<h2 id="clearing-alarms"><a class="header" href="#clearing-alarms">Clearing alarms</a></h2>
<p>An already raised alarm can be cleared by sending an empty message with retained flag enabled to the same alarm topic on which the original alarm was raised.</p>
<blockquote>
<p>Note: Using the retained flag is a must while clearing the alarm as well, without which the alarm won't be cleared properly.</p>
</blockquote>
<p>If alarms of different severities exist for a given alarm type, they must all be cleared separately as they're all treated as independent alarms.</p>
<h2 id="cloud-data-mapping"><a class="header" href="#cloud-data-mapping">Cloud data mapping</a></h2>
<p>If the device is connected to some supported IoT cloud platform, any alarms raised locally on thin-edge.io will be forwarded to the connected cloud platform as well.
The mapping of thin-edge alarms data to its respective cloud-native representation will be done by the corresponding cloud mapper process.
For example, if the device is connected to Cumulocity IoT cloud platform, the Cumulocity cloud mapper process will translate the thin-edge alarm JSON data to its equivalent Cumulocity SmartREST representation.</p>
<blockquote>
<p>Warning: As of now, alarm data mapping is supported only on Cumulocity IoT cloud platform.
Find more information about alarms data model in Cumulocity <a href="https://cumulocity.com/guides/concepts/domain-model/#events">here</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="monitor-your-device-with-collectd"><a class="header" href="#monitor-your-device-with-collectd">Monitor your device with collectd</a></h1>
<p>With thin-edge.io device monitoring, you can collect metrics from your device
and forward these device metrics to IoT platforms in the cloud.</p>
<p>Using these metrics, you can monitor the health of devices
and can proactively initiate actions in case the device seems to malfunction.
Additionally, the metrics can be used to help the customer troubleshoot when problems with the device are reported.</p>
<p>Thin-edge.io uses the open source component <a href="https://collectd.org/"><code>collectd</code></a> to collect the metrics from the device.
Thin-edge.io translates the collected metrics from their native format to the <a href="tutorials/../architecture/thin-edge-json.html">thin-edge.io JSON</a> format
and then into the <a href="tutorials/../architecture/mapper.html">cloud-vendor specific format</a>.</p>
<p>Enabling monitoring on your device is a 3-steps process:</p>
<ol>
<li><a href="tutorials/device-monitoring.html#install-collectd">Install <code>collectd</code></a>,</li>
<li><a href="tutorials/device-monitoring.html#configure-collectd">Configure <code>collectd</code></a>,</li>
<li><a href="tutorials/device-monitoring.html#enable-thin-edge-monitoring">Enable thin-edge.io monitoring</a>.</li>
</ol>
<h2 id="install-mosquitto-client-library"><a class="header" href="#install-mosquitto-client-library">Install <code>mosquitto</code> client library</a></h2>
<p>Since thin-edge.io uses the MQTT plugin of <code>collectd</code>, one needs to install the mosquitto client library
(either <code>libmosquitto1</code> or <code>mosquitto-clients</code>).</p>
<pre><code class="language-shell">sudo apt-get install libmosquitto1
</code></pre>
<p>or</p>
<pre><code class="language-shell">sudo apt-get install mosquitto-clients
</code></pre>
<h2 id="install-collectd"><a class="header" href="#install-collectd">Install <code>collectd</code></a></h2>
<p>Device monitoring is not enabled by default when you install thin edge.
You will have to install and configure <a href="https://collectd.org/"><code>collectd</code></a> first.</p>
<p>To install collectd, follow the <a href="https://collectd.org/download.shtml">collectd installation process</a>
that is specific to your device. On a Debian or Ubuntu linux:</p>
<pre><code class="language-shell">sudo apt-get install collectd-core
</code></pre>
<h2 id="configure-collectd"><a class="header" href="#configure-collectd">Configure <code>collectd</code></a></h2>
<h3 id="tldr-just-want-it-running"><a class="header" href="#tldr-just-want-it-running">TLDR; Just want it running</a></h3>
<p>Thin-edge.io provides a <a href="https://github.com/thin-edge/thin-edge.io/blob/main/configuration/contrib/collectd/collectd.conf">basic <code>collectd</code> configuration</a>
that can be used to collect cpu, memory and disk metrics.</p>
<p>Simply copy that file to the main collectd configuration file and restart the daemon
(it might be good to keep a copy of the original configuration).</p>
<pre><code class="language-shell">sudo cp /etc/collectd/collectd.conf /etc/collectd/collectd.conf.backup
sudo cp /etc/tedge/contrib/collectd/collectd.conf /etc/collectd/collectd.conf
sudo systemctl restart collectd
</code></pre>
<h3 id="collectdconf"><a class="header" href="#collectdconf"><code>Collectd.conf</code></a></h3>
<p>Unless you opted for the <a href="tutorials/device-monitoring.html#tldr-just-want-it-running">minimal test configuration provided with thin-edge</a>,
you will have to update the
<a href="https://collectd.org/documentation/manpages/collectd.conf.5.shtml"><code>collectd.conf</code> configuration file</a>
(usually located at <code>/etc/collectd/collectd.conf</code>)</p>
<p><strong>Important notes</strong> You can enable or disable the collectd plugins of your choice, but with some notable exceptions:</p>
<ol>
<li><strong>MQTT must be enabled</strong>.
<ul>
<li>Thin-edge.io expects the collectd metrics to be published on the local MQTT bus.
Hence, you must enable the <a href="https://collectd.org/documentation/manpages/collectd.conf.5.shtml#plugin_mqtt">MQTT write plugin of collectd</a>.</li>
<li>The MQTT plugin is available on most distribution of <code>collectd</code>, but this is not the case on MacOS using homebrew.
If you are missing the MQTT plugin, please recompile <code>collectd</code> to include the MQTT plugin.
See <a href="https://github.com/collectd/collectd">https://github.com/collectd/collectd</a> for details.</li>
<li>Here is a config snippet to configure the MQTT write plugin:
<pre><code>   LoadPlugin mqtt

   &lt;Plugin mqtt&gt;
       &lt;Publish &quot;tedge&quot;&gt;
           Host &quot;localhost&quot;
           Port 1883
           ClientId &quot;tedge-collectd&quot;
       &lt;/Publish&gt;
   &lt;/Plugin&gt;
</code></pre>
</li>
</ul>
</li>
<li><strong>RRDTool and CSV might be disabled</strong>
<ul>
<li>The risk with these plugins is to run out of disk space on a small device.</li>
<li>With thin-edge.io the metrics collected by <code>collectd</code> are forwarded to the cloud,
hence it makes sense to <a href="https://github.com/collectd/collectd/issues/2668">disable Local storage</a>.</li>
<li>For that, simply comment out these two plugins:</li>
</ul>
<pre><code>   #LoadPlugin rrdtool
   #LoadPlugin csv
</code></pre>
</li>
<li><strong>Cherry-pick the collected metrics</strong>
<ul>
<li><code>Collectd</code> can collect a lot of detailed metrics,
and it doesn't always make sense to forward all these data to the cloud.</li>
<li>Here is a config snippet that uses the <code>match_regex</code> plugin to select the metrics of interest,
filtering out every metric emitted by the memory plugin other than the used metric&quot;:</li>
</ul>
<pre><code>    PreCacheChain &quot;PreCache&quot;

    LoadPlugin match_regex

    &lt;Chain &quot;PreCache&quot;&gt;
        &lt;Rule &quot;memory_free_only&quot;&gt;
            &lt;Match &quot;regex&quot;&gt;
                Plugin &quot;memory&quot;
            &lt;/Match&gt;
            &lt;Match &quot;regex&quot;&gt;
                TypeInstance &quot;used&quot;
                Invert true
            &lt;/Match&gt;
            Target &quot;stop&quot;
        &lt;/Rule&gt;
    &lt;/Chain&gt;
</code></pre>
</li>
</ol>
<h2 id="enable-thin-edge-monitoring"><a class="header" href="#enable-thin-edge-monitoring">Enable thin-edge monitoring</a></h2>
<p>To enable monitoring on your device, you have to launch the <code>tedge-mapper-collectd</code> daemon process.</p>
<pre><code class="language-shell">sudo systemctl enable tedge-mapper-collectd
sudo systemctl start tedge-mapper-collectd
</code></pre>
<p>This process subscribes to the <code>collectd/#</code> topics to read the monitoring metrics published by collectd
and emits the translated measurements in thin-edge.io JSON format to the <code>tedge/measurements</code> topic.
You can inspect the collected and translated metrics, by subscribing to these topics:</p>
<p>The metrics collected by <code>collectd</code> are emitted to subtopics named after the collectd plugin and the metric name:</p>
<pre><code>$ tedge mqtt sub 'collectd/#'

[collectd/raspberrypi/cpu/percent-active] 1623076679.154:0.50125313283208
[collectd/raspberrypi/memory/percent-used] 1623076679.159:1.10760866126707
[collectd/raspberrypi/cpu/percent-active] 1623076680.154:0
[collectd/raspberrypi/df-root/percent_bytes-used] 1623076680.158:71.3109359741211
[collectd/raspberrypi/memory/percent-used] 1623076680.159:1.10760866126707

</code></pre>
<p>The <code>tedge-mapper-collectd</code> translates these collectd measurements into the <a href="tutorials/../architecture/thin-edge-json.html">thin-edge.io JSON</a> format,
<a href="tutorials/../references/bridged-topics.html#collectd-topics">grouping the measurements</a> emitted by each plugin:</p>
<pre><code>tedge mqtt sub 'tedge/measurements'

[tedge/measurements] {&quot;time&quot;:&quot;2021-06-07T15:38:59.154895598+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;:0.50251256281407},&quot;memory&quot;:{&quot;percent-used&quot;:1.11893578135189}}
[tedge/measurements] {&quot;time&quot;:&quot;2021-06-07T15:39:00.154967388+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;:0},&quot;df-root&quot;:{&quot;percent_bytes-used&quot;:71.3110656738281},&quot;memory&quot;:{&quot;percent-used&quot;:1.12107875001658}}
</code></pre>
<p>From there, if the device is actually connected to a cloud platform like Cumulocity,
these monitoring metrics will be forwarded to the cloud.</p>
<pre><code>tedge mqtt sub 'c8y/#'
[c8y/measurement/measurements/create] {&quot;type&quot;: &quot;ThinEdgeMeasurement&quot;,&quot;time&quot;:&quot;2021-06-07T15:40:30.155037451+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;: {&quot;value&quot;: 0.753768844221106}},&quot;memory&quot;:{&quot;percent-used&quot;: {&quot;value&quot;: 1.16587699972141}},&quot;df-root&quot;:{&quot;percent_bytes-used&quot;: {&quot;value&quot;: 71.3117904663086}}}
[c8y/measurement/measurements/create] {&quot;type&quot;: &quot;ThinEdgeMeasurement&quot;,&quot;time&quot;:&quot;2021-06-07T15:40:31.154898577+01:00&quot;,&quot;cpu&quot;:{&quot;percent-active&quot;: {&quot;value&quot;: 0.5}},&quot;memory&quot;:{&quot;percent-used&quot;: {&quot;value&quot;: 1.16608109197519}}}
</code></pre>
<p>If your device is not connected yet see:</p>
<ul>
<li><a href="tutorials/./connect-c8y.html">Connect my device to Cumulocity IoT</a></li>
<li><a href="tutorials/./connect-azure.html">Connect my device to Azure IoT</a></li>
</ul>
<h2 id="trouble-shooting"><a class="header" href="#trouble-shooting">Trouble shooting</a></h2>
<p>See here for <a href="tutorials/../howto-guides/009_trouble_shooting_monitoring.html">how to trouble shoot device monitoring?</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="manage-the-softwares-on-your-devices-from-cumulocity-cloud"><a class="header" href="#manage-the-softwares-on-your-devices-from-cumulocity-cloud">Manage the softwares on your devices from Cumulocity cloud</a></h1>
<p>This document describes how to manage the software modules that are installed on a thin-edge device from the
cloud using the <strong>software management</strong> feature of thin-edge.io.</p>
<blockquote>
<p>Note: This tutorial shows the Debian based distributions <strong>apt</strong> package manager use-case powered by our official <strong>apt</strong> plugin.
Other package managers can be supported by adding a plugin.
Refer to <a href="tutorials/./write-my-software-management-plugin.html">this</a> document on how to write a plugin to support software management for any other software type.</p>
</blockquote>
<blockquote>
<p>Important: As of now, software management feature is supported only from Cumulocity cloud, which supports only <code>install</code> and <code>delete</code> as an action of c8y_SoftwareUpdate operation.</p>
</blockquote>
<p>Three components are required on your devices to enable software management:</p>
<ol>
<li>
<p>Software management mapper for Cumulocity cloud
Sm-mapper acts  as a proxy between the cloud and the device.
This translates the cloud specific message type into device specific type and vice-versa.(Example: Cumulocity smart-rest to/from thin-edge json)
The messages from cloud will be translated and forwarded to the <code>tedge_agent</code> and messages from <code>tedge_agent</code> will be translated and sent to cumulocity cloud.
You can find this process with the name <code>tedge_mapper sm-c8y</code> in <code>ps</code> once it starts.</p>
</li>
<li>
<p>Software management agent
The thin-edge software management agent is the one that calls the plugins.
You can find this process with the name <code>tedge_agent</code> in <code>ps</code> once it starts.</p>
</li>
<li>
<p>Software management plugin
Plugins are the interfaces that call the package manager (example: apt/apt-get) to do the software management operations (Install, Remove or update)
You can find them in /etc/tedge/sm-plugins.
As of now there is only one (apt) plugin is supported.</p>
</li>
</ol>
<h2 id="enable-software-management-feature"><a class="header" href="#enable-software-management-feature">Enable software management feature</a></h2>
<p>Find more information about <a href="tutorials/../howto-guides/012_install_and_enable_software_management.html">how to install and enable software management.</a></p>
<h2 id="managing-the-device-software-repository-on-cumulocity-cloud"><a class="header" href="#managing-the-device-software-repository-on-cumulocity-cloud">Managing the device software <strong>repository</strong> on Cumulocity cloud</a></h2>
<p>Managing the software packages installed on the devices from your Cumulocity tenant is a two steps operation.</p>
<ul>
<li>Populate the software repository with all the software packages and versions you plan to install.</li>
<li>Trigger software update operations on the devices, to install specific packages from the repository.</li>
</ul>
<p>Find more information about <a href="https://cumulocity.com/guides/users-guide/device-management/#managing-device-software">managing the device software</a></p>
<h3 id="adding-new-software-into-the-software-repository-of-your-tenant"><a class="header" href="#adding-new-software-into-the-software-repository-of-your-tenant">Adding new software into the software repository of your tenant</a></h3>
<ol>
<li>
<p>In the Software repository page, click Add software at the right of the top menu bar.</p>
</li>
<li>
<p>In the resulting dialog box,</p>
<ul>
<li>to add a new software, enter a name for the software (and confirm it by clicking Create new in the resulting window),
a description and its version.</li>
<li>to add a new version, select the software for which you want to add a new version from the dropdown list in the Software
field and enter a version of the package. The version is optional and can be left with a white space, meaning the latest version.</li>
</ul>
<blockquote>
<p>Note: The version field format is <code>package_version::plugin_type_name</code>.The plugin type name that is provided here is used to pick
the appropriate plugin among those installed in /etc/tedge/sm-plugins.</p>
</blockquote>
<blockquote>
<p>Note 2: If the postfix <code>::plugin_type_name</code> is left empty, a <code>default</code> plugin will be used if defined or if only a single plugin is installed.</p>
</blockquote>
</li>
<li>
<p>Optionally, you can define the device type filter when adding a new software.</p>
</li>
<li>
<p>thin-edge.io ships a default plugin supporting <code>debian</code> packages from both <code>apt</code> repositories as well as remote locations.
If you prefer to use packages from an <code>apt</code> repository, select the <strong>Provide a file path</strong> option and give an <strong>empty space</strong> (' ').
<img src="tutorials/./images/add-new-software-to-repo.png" alt="Add new software" /></p>
<p>If you would like to use other sources (eg. file uploaded to your cloud or an external source), provide the full url to the file.
<img src="tutorials/./images/add-new-software-to-repo-binary.png" alt="Add new software from uploaded binary" /></p>
<p>If you would like to upload your binaries, select <code>Upload a binary</code> option and upload the file to Cumulocity software repository.
<img src="tutorials/./images/add-new-software-to-repo-remote.png" alt="Add new software from remote" /></p>
<blockquote>
<p>Note: Bear in mind that some external remotes may require additional authentication which is not supported at the moment.</p>
</blockquote>
</li>
<li>
<p>Press <code>Add Software</code> button.</p>
</li>
</ol>
<h3 id="deleting-software-or-software-version"><a class="header" href="#deleting-software-or-software-version">Deleting software or software version</a></h3>
<p>One can remove a software module or a specific version of it from the software repository.
Find more information about <a href="https://cumulocity.com/guides/users-guide/device-management/#deleting-softwares-or-software-versions">how to delete the software or the specific software version</a></p>
<h2 id="managing-software-on-a-device"><a class="header" href="#managing-software-on-a-device">Managing software on a device</a></h2>
<p>Find more information about <a href="https://cumulocity.com/guides/users-guide/device-management/#managing-software-on-a-device">how to manage the software</a> on a device.</p>
<p>From the Cumulocity cloud <code>Software</code> tab of a device, software can be</p>
<ul>
<li><a href="https://cumulocity.com/guides/users-guide/device-management/#to-install-software-on-a-device">installed</a></li>
</ul>
<blockquote>
<p>Note: Software profiles are not supported as of now on thin-edge.</p>
</blockquote>
<ul>
<li><a href="https://cumulocity.com/guides/users-guide/device-management/#to-update-software-on-a-device">updated</a></li>
</ul>
<blockquote>
<p>Note: Thin-edge treats install and update same.</p>
</blockquote>
<ul>
<li><a href="https://cumulocity.com/guides/users-guide/device-management/#to-delete-software-from-a-device">removed</a></li>
</ul>
<blockquote>
<p>Note: Once the above mentioned operation is selected, one should click on <strong>Apply changes</strong> to confirm operation.</p>
</blockquote>
<h2 id="default-plugin"><a class="header" href="#default-plugin">Default plugin</a></h2>
<p>When there are multiple plugins installed on the device, one can set one of them as a default plugin.
If there is only one plugin installed on the device, then implicitly this will be the default plugin.</p>
<h3 id="usage-of-default-plugin"><a class="header" href="#usage-of-default-plugin">Usage of <code>default plugin</code></a></h3>
<p>When the default plugin is set, then the software operation does not need to provide an explicit type of the software, then the default will be used.
In Cumulocity, one can then simply provide the package to update without having to annotate the version field with its type.</p>
<h3 id="configuring-the-default-plugin"><a class="header" href="#configuring-the-default-plugin">Configuring the default plugin</a></h3>
<p>Default plugin can be configured using the thin-edge cli command <code>tedge</code>.</p>
<p>For example set <code>apt</code> plugin as a <code>default plugin</code></p>
<pre><code>$ sudo tedge config set software.plugin.default apt
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="write-my-software-management-plugin"><a class="header" href="#write-my-software-management-plugin">Write my software management plugin</a></h1>
<p><strong>thin-edge.io</strong> Software Management natively supports APT (Debian) packages.
However, there are many package management systems in the world,
and you may want to have a plugin that is suitable for your device.
For such a demand, we provide the <a href="tutorials/./../references/plugin-api.html"><strong>Package Manager Plugin API</strong></a>
to write a custom Software Management plugin in your preferred programming language.</p>
<p>In this tutorial, we will look into the <strong>Package Manager Plugin API</strong>,
and learn how to write your own plugin with a docker plugin shell script example.</p>
<h2 id="create-a-plugin"><a class="header" href="#create-a-plugin">Create a plugin</a></h2>
<p>Create a <em>docker</em> file in the directory <em>/etc/tedge/sm-plugins/</em>. 
A plugin must be an executable file located in that directory.</p>
<p>Filename: /etc/tedge/sm-plugins/docker</p>
<pre><code class="language-shell">#!/bin/sh

COMMAND=&quot;$1&quot;
IMAGE_NAME=&quot;$2&quot;

case &quot;$COMMAND&quot; in
    list)
        docker image list --format '{{.Repository}}\t{{.Tag}}' || exit 2
        ;;
    install)
        docker pull $IMAGE_NAME || exit 2
        ;;
    remove)
        docker rmi $IMAGE_NAME || exit 2
        ;;
    prepare)
        ;;
    finalize)
        ;;
    update-list)
        exit 1
        ;;
esac
exit 0
</code></pre>
<blockquote>
<p><strong>Info</strong>: the filename will be used as a plugin type to report the software list to a cloud.
If you name it <code>docker.sh</code>, you will see <code>docker.sh</code> as a plugin type in cloud.</p>
</blockquote>
<p>If you execute <code>./docker list</code>, you will see this kind of output.</p>
<pre><code class="language-csv">alpine  3.14
eclipse-mosquitto   2.0-openssl
...
</code></pre>
<p>The Software Management Agent runs executable plugins with a special argument, like <code>list</code>.
Let's call the pre-defined argument such as <code>list</code>, <code>install</code>, and <code>remove</code> a <strong>command</strong> here. 
As you can see from this example, a plugin should be an executable file 
that accepts the commands and outputs to stdout and stderr.
Hence, you can implement a plugin in your preferred language.</p>
<p>Here is the table of the commands that you can use in a plugin.</p>
<table><thead><tr><th>Command</th><th>Input arguments</th><th>Expected output</th><th>Description</th></tr></thead><tbody>
<tr><td>list</td><td>-</td><td>lines with tab separated values</td><td>Returns the list of software modules that have been installed with this plugin.</td></tr>
<tr><td>prepare</td><td>-</td><td>-</td><td>Executes the provided actions before a sequence of install and remove commands.</td></tr>
<tr><td>finalize</td><td>-</td><td>-</td><td>Executes the provided actions after a sequence of install and remove commands.</td></tr>
<tr><td>install</td><td>NAME [--version VERSION] [--file FILE]</td><td>-</td><td>Executes the action of installation.</td></tr>
<tr><td>remove</td><td>NAME [--version VERSION]</td><td>-</td><td>Executes the action of uninstallation.</td></tr>
<tr><td>update-list</td><td>COMMAND NAME [--version VERSION] [--file FILE]</td><td>-</td><td>Executes the list of <code>install</code> and <code>remove</code> commands.</td></tr>
</tbody></table>
<p>The order of the commands invoked by the Software Management Agent is:
<code>prepare</code> -&gt; <code>update-list</code> or [<code>install</code>, <code>remove</code>] -&gt;<code>finalize</code></p>
<blockquote>
<p><strong>info</strong>: There is no guarantee of the order between <code>install</code> and <code>remove</code>.
If you need a specific order, use <code>update-list</code> command instead.</p>
</blockquote>
<p>In the following sections, we will dive into each command and other rules deeply.</p>
<h2 id="input-output-and-errors"><a class="header" href="#input-output-and-errors">Input, Output, and Errors</a></h2>
<p>Before we dive into each command, we should clarify the basic rules of plugins.</p>
<h3 id="input"><a class="header" href="#input">Input</a></h3>
<p>The command themselves and further required arguments must be given as command-line arguments.
The only exception is <code>update-list</code>, which requires <strong>stdin</strong> input.</p>
<h3 id="output"><a class="header" href="#output">Output</a></h3>
<p>The <strong>stdout</strong> and <strong>stderr</strong> of the process running a plugin command are captured by the Software Management Agent.</p>
<h3 id="exit-status"><a class="header" href="#exit-status">Exit status</a></h3>
<p>The exit status of plugins are interpreted by sm-agent as follows:</p>
<ul>
<li><strong>0</strong>: success.</li>
<li><strong>1</strong>: usage. The command arguments cannot be interpreted, and the command has not been launched.</li>
<li><strong>2</strong>: failure. The command failed and there is no point to retry.</li>
<li><strong>3</strong>: retry. The command failed but might be successful later (for instance, when the network will be back).</li>
</ul>
<h2 id="list"><a class="header" href="#list">List</a></h2>
<p>The <code>list</code> command is responsible to return the list of the installed software modules.</p>
<p>Rules:</p>
<ul>
<li>This command takes no arguments.</li>
<li>The list is returned using <a href="https://en.wikipedia.org/wiki/Tab-separated_values">CSV with tabulations as separators</a>,
including:
<ul>
<li><strong>name</strong>: the name of the software module, e.g. <code>mosquitto</code>.
This name is the name that has been used to install it and that needs to be used to remove it.</li>
<li><strong>version</strong>: the version currently installed.
This is a string that can only be interpreted in the context of the plugin.
&gt;Note: If the version is not present for a module, then list can return only the module name without trailing tabulation.
Given that your plugin is named <code>docker</code>, then the Software Management Agent calls</li>
</ul>
</li>
</ul>
<pre><code class="language-shell">sudo /etc/tedge/sm-plugins/docker list
</code></pre>
<p>to report the list of software modules installed.</p>
<blockquote>
<p><strong>Important</strong>: the Software Management Agent executes a plugin using <code>sudo</code> and as <code>tedge-agent</code> user.</p>
</blockquote>
<p><code>docker</code> should output in the CSV with tabulations as separators like</p>
<pre><code class="language-csv">alpine  3.14
eclipse-mosquitto   2.0-openssl
rust    1.51-alpine
</code></pre>
<p>with exit code <code>0</code> (successful).</p>
<p>In most cases, the output of the <code>list</code> command is multi-lines.
The line separator should be <code>\n</code>.</p>
<p>A plugin must return a CSV line per software module, using a tabulation <code>\t</code> as separator.
If there is no version field then only the module name will be returned.
In the <em>docker</em> file example, the following command outputs CSV structures with tabulations as separator.</p>
<pre><code class="language-shell">docker image list --format '{{.Repository}}\t{{.Tag}}'
</code></pre>
<h2 id="prepare"><a class="header" href="#prepare">Prepare</a></h2>
<p>The <code>prepare</code> command is invoked by the sm-agent before a sequence of install and remove commands.</p>
<p>Rules:</p>
<ul>
<li>It takes no argument and no output is expected.</li>
<li>If the <code>prepare</code> command fails,
then the whole Software Management operation is cancelled.</li>
</ul>
<p>For many plugins, this command has nothing specific to do, and can simply return with a <code>0</code> exit status.</p>
<p>In some plugin types, this <code>prepare</code> command can help you.
For example, assume that you want to implement a plugin for APT,
and want to run <code>apt-get update</code> always before calling the <code>install</code> command. 
In this example, the <code>prepare</code> command is the right place to invoke <code>apt-get update</code>.</p>
<h2 id="finalize"><a class="header" href="#finalize">Finalize</a></h2>
<p>The <code>finalize</code> command closes a sequence of install and removes commands started by a prepare command.</p>
<p>Rules:</p>
<ul>
<li>It takes no argument and no output is expected.</li>
<li>If the <code>finalize</code> command fails, then the whole Software Management operation is reported as failed,
even if all the atomic actions have been successfully completed.</li>
</ul>
<p>Similar to the <code>prepare</code> plugin, you must define the command even if you want nothing in the <code>finalize</code> command.</p>
<p>The command can be used in several situations. For example, </p>
<ul>
<li>remove any unnecessary software module after a sequence of actions.</li>
<li>commit or roll back the sequence of actions.</li>
<li>restart any processes using the modules,
e.g. restart the analytics engines if the modules have changed.</li>
</ul>
<h2 id="install"><a class="header" href="#install">Install</a></h2>
<p>The <code>install</code> command installs a software module, possibly of some expected version.
A plugin must be executable in the below format.</p>
<pre><code class="language-shell">$ myplugin install NAME [--module-version VERSION] [--file FILE]
</code></pre>
<p>This command takes 1 mandatory argument and has 2 optional flags.</p>
<ul>
<li><strong>NAME</strong>: the name of the software module to be installed, e.g. <code>mosquitto</code>. (Mandatory)</li>
<li><strong>VERSION</strong>: the version to be installed. e.g. <code>1.5.7-1+deb10u1</code>.
The version can be blank, so it's recommended to define the behaviour if a version is not provided. 
For example, always installs the &quot;latest&quot; version if a version is not provided. (Optional)</li>
<li><strong>FILE</strong>: the path to the software to be installed. (Optional)</li>
</ul>
<p>The installation phase may fail due to the following reasons.
An error must be reported if:</p>
<ul>
<li>The module name is unknown.</li>
<li>There is no version for the module that matches the constraint provided by the <code>--module-version</code> option.</li>
<li>The file content provided by <code>--file</code> option:
<ul>
<li>is not in the expected format,</li>
<li>doesn't correspond to the software module name,</li>
<li>has a version that doesn't match the constraint provided by the <code>--module-version</code> option (if any).</li>
</ul>
</li>
<li>The module cannot be downloaded.</li>
<li>The module cannot be installed.</li>
</ul>
<p>At the API level, there is no command to distinguish install or upgrade.</p>
<p>Back to the first <em>docker</em> example, it doesn't address the case with version. 
Let's expand the example file as below.</p>
<p>Filename: /etc/tedge/sm-plugins/docker</p>
<pre><code class="language-shell">#!/bin/sh

COMMAND=&quot;$1&quot;
IMAGE_NAME=&quot;$2&quot;
VERSION_FLAG=&quot;$3&quot;
IMAGE_TAG=&quot;$4&quot;

case &quot;$COMMAND&quot; in
    list)
        docker image list --format '{{.Repository}}\t{{.Tag}}' || exit 2
        ;;
    install)
        if [ $# -eq 2 ]; then
            docker pull $IMAGE_NAME || exit 2
        elif [ $# -eq 4 ] &amp;&amp; [ $VERSION_FLAG = &quot;--module-version&quot; ]; then
            docker pull $IMAGE_NAME:$IMAGE_TAG || exit 2
        else
            echo &quot;Invalid arguments&quot;
            exit 1
        fi
        ;;
    remove)
        if [ $# -eq 2 ]; then
            docker rmi $IMAGE_NAME || exit 2
        elif [ $# -eq 4 ] &amp;&amp; [ $VERSION_FLAG = &quot;--module-version&quot; ]; then
            docker rmi $IMAGE_NAME:$IMAGE_TAG || exit 2
        else
            echo &quot;Invalid arguments&quot;
            exit 1
        fi
        ;;
    prepare)
        ;;
    finalize)
        ;;
    update-list)
        exit 1
        ;;
esac
exit 0
</code></pre>
<p>Pay attention to the exit statuses.
In case of invalid arguments, the plugin returns <code>1</code>.
If a command is executed but fails, the plugin returns <code>2</code>.
Each exit status is defined <a href="tutorials/write-my-software-management-plugin.html#exit-status">here</a>.</p>
<p>If the given NAME is <code>mosquitto</code>, and the given VERSION is <code>1.5.7-1+deb10u1</code>,
the Software Management Agent calls</p>
<pre><code class="language-shell">sudo /etc/tedge/sm-plugins/docker install mosquitto --module-version 1.5.7-1+deb10u1
</code></pre>
<p>Then, the plugin executes</p>
<pre><code class="language-shell">docker pull mosquitto:1.5.7-1+deb10u1
</code></pre>
<h2 id="remove"><a class="header" href="#remove">Remove</a></h2>
<p>The <code>remove</code> command uninstalls a software module,
and possibly its dependencies if no other modules are dependent on those.
A plugin must be executable in the below format.</p>
<pre><code class="language-shell">$ myplugin remove NAME [--module-version VERSION]
</code></pre>
<p>This command takes 1 mandatory argument and 1 optional argument with a flag.</p>
<ul>
<li><strong>NAME</strong>: the name of the software module to be removed, e.g. <code>mosquitto</code>. (Mandatory)</li>
<li><strong>VERSION</strong>: the version to be installed. e.g. <code>1.5.7-1+deb10u1</code>.
The version can be blank, so it's recommended to define the behaviour if a version is not provided.
For example, uninstall a software module regardless of its version if a version is not provided. (Optional)</li>
</ul>
<p>The uninstallation phase can be failed due to several reasons. An error must be reported if:</p>
<ul>
<li>The module name is unknown.</li>
<li>The module cannot be uninstalled.</li>
</ul>
<p>Back to the first <em>docker</em> plugin example,
if the NAME is <code>mosquitto</code>, and the VERSION is <code>1.5.7-1+deb10u1</code>,
the Software Management Agent calls</p>
<pre><code class="language-shell">sudo /etc/tedge/sm-plugins/docker remove mosquitto --module-version 1.5.7-1+deb10u1
</code></pre>
<p>Then, the plugin executes</p>
<pre><code class="language-shell">docker rmi mosquitto:1.5.7-1+deb10u1
</code></pre>
<h2 id="update-list"><a class="header" href="#update-list">Update-list</a></h2>
<p>The <code>update-list</code> command accepts a list of software modules and associated operations as <code>install</code> or <code>remove</code>.
This basically achieves the same purpose as original commands install and remove,
but gets passed all software modules to be processed in one command.
This can be needed when an order of processing software modules is relevant.</p>
<p>In other words, you can choose a combination of the <code>install</code> or <code>remove</code> commands or this <code>update-list</code> command up to your requirement.
If you don't want to use <code>update-list</code>, the plugin must return <code>1</code> like the first <em>docker</em> plugin example.</p>
<pre><code class="language-shell">case &quot;$COMMAND&quot; in
    ...
    update-list)
        exit 1
        ;;
esac
</code></pre>
<p>Let's expand the first <em>docker</em> plugin example to use <code>update-list</code>.
First, learn what is the input of <code>update-list</code>.</p>
<p>The Software Management Agent calls a plugin as below. Note that each argument is tab separated:</p>
<pre><code class="language-shell">$ sudo /etc/tedge/sm-plugins/docker update-list &lt;&lt;EOF
  install	name1	version1
  install	name2		path2
  remove	name3	version3
  remove	name4
EOF
</code></pre>
<p>The point is that it doesn't take any command-line argument, 
but the software action list is sent through <strong>stdin</strong>.</p>
<p>The behaviour of operations <code>install</code> and <code>remove</code> is the same as for original commands <code>install</code> and <code>remove</code>. 
The above input is equivalent to the use of original commands (<code>install</code> and <code>remove</code>):</p>
<pre><code class="language-shell">$ /etc/tedge/sm-plugins/docker install name1 --module-version version1
$ /etc/tedge/sm-plugins/docker install name2 --file path2
$ /etc/tedge/sm-plugins/docker remove &quot;name 3&quot; --module-version version3
$ /etc/tedge/sm-plugins/docker remove name4
</code></pre>
<p>To make the <em>docker</em> plugin accept a list of install and remove actions,
let's change the file as below.
Note that this example works only in bash.</p>
<p>Filename: /etc/tedge/sm-plugins/docker</p>
<pre><code class="language-shell">#!/bin/bash

COMMAND=&quot;$1&quot;

case &quot;$COMMAND&quot; in
    list)
        docker image list --format '{{.Repository}}\t{{.Tag}}' || exit 2
        ;;
    install)
        echo docker pull &quot;$2:$3&quot;
        ;;
    remove)
        echo docker rmi &quot;$2:$3&quot;
        ;;
    prepare)
        ;;
    finalize)
        ;;
    update-list)
        while IFS=$'\t' read -r ACTION MODULE VERSION FILE
        do
            bash -c &quot;$0 $ACTION $MODULE $VERSION&quot;
        done
        ;;
esac
exit 0
</code></pre>
<p>You can find that <code>install</code> and <code>remove</code> are replaced by <code>update-list</code>.
<code>update-list</code> should define the behaviour to read line by line for the case <code>install</code> and <code>remove</code>.</p>
<p>Also, <code>update-list</code> must be <strong>fail-fast</strong>.
That example exists immediately if one of the commands fails.</p>
<h2 id="project-references"><a class="header" href="#project-references">Project references</a></h2>
<p>You can also refer to:</p>
<ul>
<li>the specification of the <a href="https://github.com/thin-edge/thin-edge.io/blob/main/docs/src/references/plugin-api.md">Package Manager Plugin API</a>.</li>
<li><a href="https://github.com/thin-edge/thin-edge.io/tree/main/plugins/tedge_apt_plugin">the APT plugin</a> written in Rust. </li>
<li><a href="https://github.com/thin-edge/thin-edge.io/blob/main/sm/plugins/tedge_docker_plugin/tedge_docker_plugin.sh">the example Docker plugin</a> written in POSIX standard shell script.
This plugin can install/remove docker containers using docker image tags. This plugin is <strong>not</strong> to be used in production without necessary enhancements. It is to be used only as a reference to write your own plugin.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="thin-edgeio-supported-operations"><a class="header" href="#thin-edgeio-supported-operations">thin-edge.io Supported Operations</a></h1>
<h2 id="supported-operations-concepts"><a class="header" href="#supported-operations-concepts">Supported Operations concepts</a></h2>
<h3 id="device-operations"><a class="header" href="#device-operations">Device operations</a></h3>
<p>IoT devices often do more than just send data to the cloud. They also do things like:</p>
<ul>
<li>receive triggers from the operator</li>
<li>reboot on demand</li>
<li>install or remove software</li>
</ul>
<p>These operations that are supported by <a href="https://cumulocity.com/api/10.11.0/#section/Device-management-library">Cumulocity IoT</a> and other cloud providers.
On <code>thin-edge.io</code> the support for one such operation can be added using the <code>thin-edge.io</code> Supported Operations API.</p>
<h3 id="thin-edgeio-supported-operations-api"><a class="header" href="#thin-edgeio-supported-operations-api"><code>thin-edge.io</code> Supported Operations API</a></h3>
<p>The Supported Operations utilises the file system to add and remove operations. A special file placed in <code>/etc/tedge/operations</code> directory will indicate that an operation is supported.
The specification for the operation files is described in <code>thin-edge.io</code> specifications repository<a href="https://github.com/thin-edge/thin-edge.io-specs/blob/main/src/supported-operations/README.md">src/supported-operations/README.md</a></p>
<h2 id="thin-edgeio-list-of-supported-operations"><a class="header" href="#thin-edgeio-list-of-supported-operations"><code>thin-edge.io</code> List of Supported Operations</a></h2>
<p><code>thin-edge.io</code> supports natively the following operations:</p>
<ul>
<li>Software Update</li>
<li>Software Update Log Upload</li>
<li>Restart</li>
</ul>
<p>The list is growing as we support more operations, but is not exhaustive and we encourage you to contribute to the list.</p>
<h2 id="how-to-use-supported-operations"><a class="header" href="#how-to-use-supported-operations">How to use Supported Operations</a></h2>
<h3 id="listing-current-operations"><a class="header" href="#listing-current-operations">Listing current operations</a></h3>
<p>You can obtain the current list of supported operations by listing the content of the <code>/etc/tedge/operations</code> directory.
This directory should have permissions set to <code>755</code> and the owner to <code>tedge</code>.
This directory will contain a set subdirectories based on cloud providers currently supported eg:</p>
<pre><code class="language-shell">$ ls -l /etc/tedge/operations

drwxr-xr-x 2 tedge tedge 4096 Jan 01 00:00 az
drwxr-xr-x 2 tedge tedge 4096 Jan 01 00:00 c8y
</code></pre>
<p>From the above you can see that there are two cloud providers supported by <code>thin-edge.io</code>.
The directories should be readable by <code>thin-edge.io</code> user - <code>tedge</code> - and should have permissions <code>755</code>.</p>
<p>To list all currently supported operations for a cloud provider, run:</p>
<pre><code class="language-shell">$ ls -l /etc/tedge/operations/c8y

-rw-r--r-- 1 tedge tedge 0 Jan 01 00:00 c8y_Restart
</code></pre>
<p>To list all currently supported operations, run:
The operations files should have permissions <code>644</code> and the owner <code>tedge</code>.</p>
<pre><code class="language-shell">$ sudo ls -lR /etc/tedge/operations
/etc/tedge/operations:
drwxr-xr-x 2 tedge tedge 4096 Jan 01 00:00 az
drwxr-xr-x 2 tedge tedge 4096 Jan 01 00:00 c8y

/etc/tedge/operations/az:
-rw-r--r-- 1 tedge tedge 0 Jan 01 00:00 Restart

/etc/tedge/operations/c8y:
-rw-r--r-- 1 tedge tedge 0 Jan 01 00:00 c8y_Restart
</code></pre>
<h3 id="adding-new-operations"><a class="header" href="#adding-new-operations">Adding new operations</a></h3>
<p>To add new operation we need to create new file in <code>/etc/tedge/operations</code> directory.
Before we create that file we have to know which cloud provider we are going to support (it is possible to support multiple cloud providers, but we won't cover this here).</p>
<p>We will add operation <code>Restart</code> for our device which can be triggered from Cumulocity IoT called, in Cumulocity IoT this operations name is <code>c8y_Restart</code>.
This operation will do the reboot of our device when we receive trigger from the operator. <code>thin-edge.io</code> device will receive an MQTT message with certain payload and we already have a handler for that payload in the <code>tedge-mapper-c8y</code>.</p>
<p>To add new operation we will create a file in <code>/etc/tedge/operations/c8y</code> directory:</p>
<pre><code class="language-shell">sudo -u tedge touch /etc/tedge/operations/c8y/c8y_Restart
</code></pre>
<blockquote>
<p>Note: We are using <code>sudo -u</code> to create the file because we want to make sure that the file is owned by <code>tedge</code> user.</p>
</blockquote>
<p>Now we just need to reboot the <code>tedge-mapper-c8y</code> so it picks new operations and it will automatically add it to the list and send it to the cloud.</p>
<h3 id="removing-supported-operations"><a class="header" href="#removing-supported-operations">Removing supported operations</a></h3>
<p>To remove supported operation we can remove the file from <code>/etc/tedge/operations/c8y</code> directory and restart the <code>tedge-mapper-c8y</code> to pick up the new list of supported operations. eg:</p>
<pre><code class="language-shell">sudo rm /etc/tedge/operations/c8y/c8y_Restart
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-guides"><a class="header" href="#how-to-guides">How-to Guides</a></h1>
<ol>
<li><a href="howto-guides/./002_installation.html">How to install thin-edge.io?</a></li>
<li><a href="howto-guides/./003_registration.html">How to create a test certificate?</a></li>
<li><a href="howto-guides/./004_connect.html">How to connect a cloud end-point?</a></li>
<li><a href="howto-guides/./005_pub_sub.html">How to use <code>tedge mqtt</code> module?</a></li>
<li><a href="howto-guides/./007_test_connection.html">How to test connection to cloud?</a></li>
<li><a href="howto-guides/./007_test_connection.html">How to test the cloud connection?</a></li>
<li><a href="howto-guides/./008_config_local_mqtt_port.html">How to configure the local mqtt port?</a></li>
<li><a href="howto-guides/./009_trouble_shooting_monitoring.html">How to trouble shoot device monitoring?</a></li>
<li><a href="howto-guides/./010_add_self_signed_trusted.html">How to add self-signed certificate root to trusted certificates list?</a></li>
<li><a href="howto-guides/./011_retrieve_jwt_token_from_cumulocity.html">How to retrieve JWT token from Cumulocity?</a></li>
<li><a href="howto-guides/./012_install_and_enable_software_management.html">How to install and enable software management?</a></li>
<li><a href="howto-guides/./013_connect_external_device.html">How to connect an external device?</a></li>
<li><a href="howto-guides/./014_thin_edge_logs.html">How to access the logs on the device?</a></li>
<li><a href="howto-guides/./015_installation_without_deb_support.html">How to install thin-edge.io on any Linux OS (no deb support)?</a></li>
<li><a href="howto-guides/./017_apama_software_management_plugin.html">How to manage apama software artefatcs with apama plugin?</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-install-thin-edgeio"><a class="header" href="#how-to-install-thin-edgeio">How to install <code>thin-edge.io</code>?</a></h1>
<h2 id="installation-with-get-thin-edge_iosh-script"><a class="header" href="#installation-with-get-thin-edge_iosh-script">Installation with get-thin-edge_io.sh script</a></h2>
<p>There are two possibilities to install thin-edge.io, the easiest way is to use the installation script with this command:</p>
<pre><code class="language-shell">curl -fsSL https://raw.githubusercontent.com/thin-edge/thin-edge.io/main/get-thin-edge_io.sh | sudo sh -s
</code></pre>
<p>You can execute that command on your device and it will do all required steps for an initial setup.</p>
<p>If you prefer to have a little more control over the installation or the script did not work for you, please go on with the following steps.</p>
<h2 id="manual-installation-steps"><a class="header" href="#manual-installation-steps">Manual installation steps</a></h2>
<p>To install thin edge package it is required to use <code>curl</code> to download the package and <code>dpkg</code> to install it.</p>
<h2 id="dependency-installation"><a class="header" href="#dependency-installation">Dependency installation</a></h2>
<p>thin-edge.io has single dependency and it is <code>mosquitto</code> used for communication southbound and northbound e.g. southbound, devices can publish measurements; northbound, gateway may relay messages to cloud.
<code>mosquitto</code> can be installed with your package manager. For apt the command may look as following:</p>
<pre><code class="language-shell">apt install mosquitto
</code></pre>
<blockquote>
<p>Note: Some OSes may require you to use <code>sudo</code> to install packages.</p>
</blockquote>
<pre><code class="language-shell">sudo apt install mosquitto
</code></pre>
<h2 id="thin-edgeio-installation"><a class="header" href="#thin-edgeio-installation"><code>thin-edge.io</code> installation</a></h2>
<p>When all dependencies are in place you can proceed with installation of <code>thin-edge.io cli</code> and <code>thin-edge.io mapper</code> service.</p>
<h3 id="upgrading-thin-edgeio"><a class="header" href="#upgrading-thin-edgeio">Upgrading <code>thin-edge.io</code></a></h3>
<p>If you already have <code>thin-edge.io</code> on your device to upgrade <code>thin-edge.io</code> follow the steps below, there is no need to remove old version.</p>
<blockquote>
<p>Note: To successfully upgrade <code>thin-edge.io</code> all thin-edge.io components should be stopped, eg: <code>tedge-mapper</code> and <code>tedge-agent</code>:</p>
<pre><code class="language-shell">systemctl stop tedge-mapper-c8y
systemctl stop tedge-agent
</code></pre>
</blockquote>
<h3 id="package-download"><a class="header" href="#package-download">Package download</a></h3>
<p>thin-edge.io package is in thin-edge.io repository on GitHub: <a href="https://github.com/thin-edge/thin-edge.io/releases">thin-edge.io</a>.</p>
<p>To download the package from github repository use following command (use desired version):</p>
<pre><code class="language-shell">curl -LJO https://github.com/thin-edge/thin-edge.io/releases/download/&lt;package&gt;_&lt;version&gt;_&lt;arch&gt;.deb
</code></pre>
<p>where:</p>
<blockquote>
<p><code>version</code> -&gt; thin-edge.io version in x.x.x format</p>
<p><code>arch</code> -&gt; architecture type (amd64, armhf, arm64)</p>
</blockquote>
<p>Eg:</p>
<pre><code class="language-shell">curl -LJO https://github.com/thin-edge/thin-edge.io/releases/download/0.5.0/tedge_0.5.0_armhf.deb
</code></pre>
<p>and for <code>mapper</code>:</p>
<pre><code class="language-shell">curl -LJO https://github.com/thin-edge/thin-edge.io/releases/download/0.5.0/tedge_mapper_0.5.0_armhf.deb
</code></pre>
<h3 id="package-installation"><a class="header" href="#package-installation">Package installation</a></h3>
<p>Now, we have downloaded the package we can proceed to installation. First we will install cli tool <code>tedge</code>.</p>
<blockquote>
<p>Note: Some OSes may require you to use <code>sudo</code> to install packages and therefore all following commands may need <code>sudo</code>.</p>
</blockquote>
<p>To install <code>tedge</code> use following command:</p>
<pre><code class="language-shell">dpkg -i tedge_&lt;version&gt;_&lt;arch&gt;.deb
</code></pre>
<p>Eg:</p>
<pre><code class="language-shell">dpkg -i tedge_0.5.0_armhf.deb
</code></pre>
<p>To install mapper for thin-edge.io do:</p>
<pre><code class="language-shell">dpkg -i tedge_mapper_&lt;version&gt;_&lt;arch&gt;.deb
</code></pre>
<p>Eg:</p>
<pre><code class="language-shell">dpkg -i tedge_mapper_0.5.0_armhf.deb
</code></pre>
<h3 id="add-your-user-to-tedge-users-group"><a class="header" href="#add-your-user-to-tedge-users-group">Add your user to <code>tedge-users</code> group</a></h3>
<p>During the installation process, a <code>tedge-users</code> group is automatically created,
in order to ease the administration of who can use the <code>sudo tedge</code> command on the device.
Indeed, the <code>tedge</code> command needs to be run using <code>sudo</code>.
So, unless all the users are granted sudo privileges, you have to add a user to the <code>tedge-users</code> group for that user to be able to use <code>tedge</code>.</p>
<p>Run this command to add a user to the group.</p>
<pre><code class="language-shell">sudo adduser &lt;user&gt; tedge-users
</code></pre>
<h2 id="next-steps-2"><a class="header" href="#next-steps-2">Next steps</a></h2>
<ol>
<li><a href="howto-guides/../tutorials/connect-c8y.html">Connect your device to Cumulocity IoT</a></li>
<li><a href="howto-guides/../tutorials/connect-azure.html">Connect your device to Azure IoT</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-register"><a class="header" href="#how-to-register">How to register?</a></h1>
<h2 id="create-self-signed-certificate"><a class="header" href="#create-self-signed-certificate">Create self-signed certificate</a></h2>
<p>To create new certificate you can use <a href="howto-guides/../references/tedge-cert.html"><code>tedge cert create</code></a> thin-edge.io command:</p>
<pre><code class="language-shell">sudo tedge cert create --device-id alpha
</code></pre>
<blockquote>
<p>Note: <code>tedge cert</code> requires <code>sudo</code> privilege. This command provides no output on success.</p>
</blockquote>
<p><a href="howto-guides/../references/tedge-cert.html"><code>sudo tedge cert create</code></a> will create certificate in a default location (<code>/etc/tedge/device-certs/</code>).
To use a custom location, refer to <a href="howto-guides/../references/tedge-config.html"><code>tedge config</code></a>.</p>
<p>Now you should have a certificate in the <code>/etc/tedge/device-certs/</code> directory.</p>
<pre><code class="language-shell">$ ls /etc/tedge/device-certs/
/etc/tedge/device-certs/tedge-certificate.pem
</code></pre>
<h3 id="errors"><a class="header" href="#errors">Errors</a></h3>
<h4 id="certificate-creation-fails-due-to-invalid-device-id"><a class="header" href="#certificate-creation-fails-due-to-invalid-device-id">Certificate creation fails due to invalid device id</a></h4>
<p>If non-supported characters are used for the device id then the cert create will fail with below error:</p>
<pre><code class="language-plain">Error: failed to create a test certificate for the device +.

Caused by:
    0: DeviceID Error
    1: The string '&quot;+&quot;' contains characters which cannot be used in a name [use only A-Z, a-z, 0-9, ' = ( ) , - . ? % * _ ! @]
</code></pre>
<h4 id="certificate-already-exists-in-the-given-location"><a class="header" href="#certificate-already-exists-in-the-given-location">Certificate already exists in the given location</a></h4>
<p>If the certificate already exists you may see following error:</p>
<pre><code class="language-plain">Error: failed to create a test certificate for the device alpha.

Caused by:
    A certificate already exists and would be overwritten.
            Existing file: &quot;/etc/tedge/device-certs/tedge-certificate.pem&quot;
            Run `tedge cert remove` first to generate a new certificate.
</code></pre>
<blockquote>
<p>Warning! Removing a certificate can break the bridge and more seriously delete a certificate that was a CA-signed certificate.</p>
</blockquote>
<p>Follow the instruction to remove the existing certificate and issue <a href="howto-guides/../references/tedge-cert.html"><code>tedge cert remove</code></a>:</p>
<pre><code class="language-shell">sudo tedge cert remove
</code></pre>
<p>and try <a href="howto-guides/../references/tedge-cert.html"><code>tedge cert create</code></a> once again.</p>
<h2 id="next-steps-3"><a class="header" href="#next-steps-3">Next steps</a></h2>
<ol>
<li><a href="howto-guides/./004_connect.html">How to connect?</a></li>
<li><a href="howto-guides/./005_pub_sub.html">How to use mqtt pub/sub?</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-connect"><a class="header" href="#how-to-connect">How to connect?</a></h1>
<h2 id="connect-to-cumulocity-iot"><a class="header" href="#connect-to-cumulocity-iot">Connect to Cumulocity IoT</a></h2>
<p>To create northbound connection a local bridge shall be established and this can be achieved with <code>tedge</code> cli and following commands:</p>
<blockquote>
<p>Note: <code>tedge connect</code> requires <code>sudo</code> privilege.</p>
</blockquote>
<hr />
<p>Configure required parameters for thin-edge.io with <a href="howto-guides/../references/tedge-config.html"><code>tedge config set</code></a>:</p>
<pre><code class="language-shell">sudo tedge config set c8y.url example.cumulocity.com
</code></pre>
<blockquote>
<p>Tip: If you you are unsure which parameters are required for the command to work run the command and it will tell you which parameters are missing.
For example, if we issue <a href="howto-guides/../references/tedge-connect.html"><code>tedge connect c8y</code></a> without any configuration following advice will be given:</p>
<pre><code class="language-shell">$ tedge connect c8y`
...
Error: failed to execute `tedge connect`.

Caused by:
    Required configuration item is not provided 'c8y.url', run 'tedge config set c8y.url &lt;value&gt;' to add it to config.
</code></pre>
<p>This message explains which configuration parameter is missing and how to add it to configuration, in this case we are told to run <code>tedge config set c8y.url &lt;value&gt;</code>.</p>
</blockquote>
<hr />
<p>The next step is to have the device certificate trusted by Cumulocity. This is done by uploading the certificate of the signee.
You can upload root certificate via <a href="https://cumulocity.com/guides/users-guide/device-management/#trusted-certificates">Cumulocity UI</a> or with <a href="howto-guides/../references/tedge-cert.html"><code>tedge cert upload</code></a> as described below.</p>
<blockquote>
<p>Note: This command takes parameter <code>user</code>, this is due to upload mechanism to Cumulocity cloud which uses username and password for authentication.</p>
<p>After issuing this command you are going to be prompted for a password. Users usernames and passwords are not stored in configuration due to security.</p>
</blockquote>
<pre><code class="language-shell">$ sudo tedge cert upload c8y –-user &lt;username&gt;
Password:
</code></pre>
<p>where:</p>
<blockquote>
<p><code>username</code> -&gt; user in Cumulocity with permissions to upload new certificates</p>
</blockquote>
<hr />
<p>To create bridge use <a href="howto-guides/../references/tedge-connect.html"><code>tedge connect</code></a>:</p>
<pre><code class="language-shell">$ sudo tedge connect c8y
Checking if systemd is available.

Checking if configuration for requested bridge already exists.

Validating the bridge certificates.

Saving configuration for requested bridge.

Restarting mosquitto service.

Awaiting mosquitto to start. This may take up to 5 seconds.

Persisting mosquitto on reboot.

Successfully created bridge connection!

Checking if tedge-mapper is installed.

Starting tedge-mapper service.

Persisting tedge-mapper on reboot.

tedge-mapper service successfully started and enabled!

Sending packets to check connection. This may take up to 10 seconds.

Try 1 / 2: Sending a message to Cumulocity. Received expected response message, connection check is successful.
</code></pre>
<h3 id="errors-1"><a class="header" href="#errors-1">Errors</a></h3>
<h4 id="connection-already-established"><a class="header" href="#connection-already-established">Connection already established</a></h4>
<p>If connection has already been established following error may appear:</p>
<pre><code class="language-shell">$ sudo tedge connect c8y
Checking if systemd is available.

Checking if configuration for requested bridge already exists.

Error: failed to create bridge to connect Cumulocity cloud.

Caused by:
    Connection is already established. To remove existing connection use 'tedge disconnect c8y' and try again.
</code></pre>
<p>To remove existing connection and create new one follow the advice and issue <a href="howto-guides/../references/tedge-disconnect.html"><code>tedge disconnect c8y</code></a>:</p>
<pre><code class="language-shell">$ sudo tedge disconnect c8y
Removing Cumulocity bridge.

Applying changes to mosquitto.

Cumulocity Bridge successfully disconnected!

Stopping tedge-mapper service.

Disabling tedge-mapper service.

tedge-mapper service successfully stopped and disabled!

</code></pre>
<blockquote>
<p>Note: <code>tedge disconnect c8y</code> also stops and disable <strong>tedge-mapper</strong> service if it is installed on the device.</p>
</blockquote>
<p>And now you can issue <a href="howto-guides/../references/tedge-connect.html"><code>tedge connect c8y</code></a> to create new bridge.</p>
<h4 id="connection-check-failure"><a class="header" href="#connection-check-failure">Connection check failure</a></h4>
<p>Sample output of tedge connect when this error occurs:</p>
<pre><code class="language-shell">$ sudo tedge connect c8y
Checking if systemd is available.

Checking if configuration for requested bridge already exists.

Validating the bridge certificates.

Saving configuration for requested bridge.

Restarting mosquitto service.

Awaiting mosquitto to start. This may take up to 5 seconds.

Persisting mosquitto on reboot.

Successfully created bridge connection!

Checking if tedge-mapper is installed.

Starting tedge-mapper service.

Persisting tedge-mapper on reboot.

tedge-mapper service successfully started and enabled!

Sending packets to check connection. This may take up to 10 seconds.

Try 1 / 2: Sending a message to Cumulocity. ... No response. If the device is new, it's normal to get no response in the first try.
Try 2 / 2: Sending a message to Cumulocity. ... No response. 
Warning: Bridge has been configured, but Cumulocity connection check failed.
</code></pre>
<p>This error may be caused by some of the following reasons:</p>
<ul>
<li>No access to Internet connection</li>
</ul>
<p>Local bridge has been configured and is running but the connection check has failed due to no access to the northbound endpoint.</p>
<ul>
<li>Cumulocity tenant not available</li>
</ul>
<p>Tenant couldn't be reached and therefore connection check has failed.</p>
<ul>
<li>Check bridge</li>
</ul>
<p>Bridge configuration is correct but the connection couldn't be established to unknown reason.</p>
<p>To retry start with <a href="howto-guides/../references/tedge-disconnect.html"><code>tedge disconnect c8y</code></a> removing this bridge:</p>
<pre><code class="language-shell">sudo tedge disconnect c8y
</code></pre>
<p>When this is done, issue <a href="howto-guides/../references/tedge-connect.html"><code>tedge connect c8y</code></a> again.</p>
<h4 id="file-permissions"><a class="header" href="#file-permissions">File permissions</a></h4>
<p>Sample output:</p>
<pre><code class="language-shell">$ tedge connect c8y
Checking if systemd is available.

Checking if configuration for requested bridge already exists.

Validating the bridge certificates.

Saving configuration for requested bridge.

Error: failed to create bridge to connect Cumulocity cloud.

Caused by:
    0: File Error. Check permissions for /etc/tedge/mosquitto-conf/tedge-mosquitto.conf.
    1: failed to persist temporary file: Permission denied (os error 13)
    2: Permission denied (os error 13)
</code></pre>
<p>tedge connect cannot access location to create the bridge configuration (<code>/etc/tedge/mosquitto-conf</code>), check permissions for the directory and adjust it to allow the tedge connect to access it.</p>
<p>Example of incorrect permissions:</p>
<pre><code class="language-shell">$ ls -l /etc/tedge
dr--r--r-- 2 tedge     tedge     4096 Mar 30 15:40 mosquitto-conf
</code></pre>
<p>You should give it the permission 755.</p>
<pre><code class="language-shell">$ ls -l /etc/tedge
drwxr-xr-x 2 tedge     tedge     4096 Mar 30 15:40 mosquitto-conf
</code></pre>
<h4 id="mosquitto-and-systemd-check-fails"><a class="header" href="#mosquitto-and-systemd-check-fails">mosquitto and systemd check fails</a></h4>
<p>Sample output:</p>
<pre><code class="language-shell">$ sudo tedge connect c8y
Checking if systemd is available.

Checking if configuration for requested bridge already exists.

Validating the bridge certificates.

Saving configuration for requested bridge.

Restarting mosquitto service.

Error: failed to create bridge to connect Cumulocity cloud.

Caused by:
    Service mosquitto not found. Install mosquitto to use this command.
</code></pre>
<p>mosquitto server has not been installed on the system and it is required to run this command, refer to <a href="howto-guides/./002_installation.html">How to install thin-edge.io?</a> to install mosquitto and try again.</p>
<h2 id="next-steps-4"><a class="header" href="#next-steps-4">Next steps</a></h2>
<ol>
<li><a href="howto-guides/./005_pub_sub.html">How to use mqtt pub/sub?</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-use-a-hrefhowto-guidesreferencestedge-mqtthtmltedge-mqtta-pub-and-sub"><a class="header" href="#how-to-use-a-hrefhowto-guidesreferencestedge-mqtthtmltedge-mqtta-pub-and-sub">How to use <a href="howto-guides/../references/tedge-mqtt.html"><code>tedge mqtt</code></a> pub and sub?</a></h1>
<p>thin-edge.io cli provides a convenient way to debug and aid development process.</p>
<h2 id="publish"><a class="header" href="#publish">Publish</a></h2>
<p>Command <a href="howto-guides/../references/tedge-mqtt.html"><code>tedge mqtt pub</code></a> can be used to publish MQTT messages on a topic to the local mosquitto server.</p>
<p>Example:</p>
<pre><code class="language-shell">tedge mqtt pub 'tedge/measurements' '{ &quot;temperature&quot;: 21.3 }'
</code></pre>
<p><code>tedge mqtt pub</code> supports setting of QoS for MQTT messages:</p>
<pre><code class="language-shell">tedge mqtt pub 'tedge/measurements' '{ &quot;temperature&quot;: 21.3 }' --qos 2
</code></pre>
<h2 id="subscribe"><a class="header" href="#subscribe">Subscribe</a></h2>
<p>Command <a href="howto-guides/../references/tedge-mqtt.html"><code>tedge mqtt sub</code></a> can be used to ease debugging of of MQTT communication on local bridge. You can subscribe to topic of your choosing:</p>
<pre><code class="language-shell">tedge mqtt sub tedge/errors
</code></pre>
<p>Or you can subscribe to any topic on the server using wildcard (<code>#</code>) topic:</p>
<pre><code class="language-shell">tedge mqtt sub '#'
</code></pre>
<p>Now use <code>tedge mqtt pub 'tedge/measurements' '{ &quot;temperature&quot;: 21.3 }'</code> to publish message on <code>tedge/measurements</code> topic with payload <code>{ &quot;temperature&quot;: 21.3 }</code>.</p>
<p>All messages from sub command are printed to <code>stdout</code> and can be captured to a file if you need to:</p>
<pre><code class="language-shell">tedge mqtt sub '#' &gt; filename.mqtt
</code></pre>
<p>Wildcard (<code>#</code>) topic is used by <a href="https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901242">MQTT protocol</a> as a wildcard and will listen on all topics</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-test-the-connection-to-cloud"><a class="header" href="#how-to-test-the-connection-to-cloud">How to test the connection to cloud?</a></h1>
<p>We provide a way to test the connection from your device to a cloud provider.
You can call this connection check function by</p>
<pre><code class="language-shell">sudo tedge connect &lt;cloud&gt; --test
</code></pre>
<p>It returns exit code 0 if the connection check is successful, otherwise, 1.</p>
<p>This test is already performed as part of the <code>tedge connect &lt;cloud&gt;</code> command.</p>
<h2 id="what-does-the-test-do"><a class="header" href="#what-does-the-test-do">What does the test do?</a></h2>
<p>The connection test sends a message to the cloud and waits for a response.
The subsequent sections explain the cloud-specific behaviour.</p>
<h3 id="for-cumulocity-iot"><a class="header" href="#for-cumulocity-iot">For Cumulocity IoT</a></h3>
<p>The test publishes <a href="https://cumulocity.com/guides/device-sdk/mqtt/#a-nameinventory-templatesinventory-templates-1xxa">a SmartREST2.0 static template message for device creation <code>100</code></a> to the topic <code>c8y/s/us</code>.
If the device-twin is already created in your Cumulocity,
the device is supposed to receive <code>41,100,Device already existing</code> on the error topic <code>c8y/s/e</code>.</p>
<p>So, the test subscribes to <code>c8y/s/e</code> topic and if it receives the expected message on the topic, the test is marked successful.</p>
<p>The connection test sends maximum two of SmartREST2.0 <code>100</code> requests.
This is because the first <code>100</code> request can be considered a successful device creation request if the device-twin does not exist in Cumulocity yet.</p>
<h3 id="for-azure-iot-hub"><a class="header" href="#for-azure-iot-hub">For Azure IoT Hub</a></h3>
<p>The test subscribes to the topic <code>az/twin/res/</code>.
Then, it publishes an empty string to the topic <code>az/twin/GET/?$rid=1</code>. </p>
<p>If the connection check receives a message containing <code>200</code> (status success), the test is marked successful.</p>
<p>The connection test sends the empty string only once.</p>
<h2 id="next-steps-5"><a class="header" href="#next-steps-5">Next steps</a></h2>
<ol>
<li><a href="howto-guides/./005_pub_sub.html">How to use mqtt pub/sub?</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-configure-the-local-port-in-mosquitto"><a class="header" href="#how-to-configure-the-local-port-in-mosquitto">How to configure the local port in mosquitto?</a></h1>
<p>Configuring a mosquitto port in thin edge is a three step process.</p>
<h2 id="step-1-disconnect-the-thin-edge-device"><a class="header" href="#step-1-disconnect-the-thin-edge-device">Step 1: Disconnect the thin edge device</a></h2>
<p>The thin edge device has to be disconnected from the cloud using the <code>tedge</code> command</p>
<pre><code class="language-shell">tedge disconnect c8y/az
</code></pre>
<h2 id="step-2-set-and-verify-the-new-mqtt-port"><a class="header" href="#step-2-set-and-verify-the-new-mqtt-port">Step 2: Set and verify the new mqtt port</a></h2>
<p>Set the mqtt.port with a desired port using <code>tedge</code> command as below.</p>
<pre><code class="language-shell">tedge config set mqtt.port 1024
</code></pre>
<p>This will make sure that all the mqtt clients use the newer port that has been set.</p>
<h2 id="verify-the-port-configuredset"><a class="header" href="#verify-the-port-configuredset">Verify the port configured/set</a></h2>
<p>Use below command to check the port has been set properly or not.</p>
<pre><code class="language-shell">tedge config get mqtt.port
</code></pre>
<p>This prints out the port that has been set.</p>
<h2 id="step-3-connect-the-thin-edge-device-to-cloud"><a class="header" href="#step-3-connect-the-thin-edge-device-to-cloud">Step 3: Connect the thin edge device to cloud</a></h2>
<p>Using <code>tedge</code> command connect to the desired cloud as below.</p>
<p>This will configure all the services (mosquitto, tedge-mapper-c8y.service, tedge-mapper-az.service, sm_agent,
tedge-agent.service, tedge-mapper-sm-c8y.service) to use the newely set port.</p>
<pre><code class="language-shell">tedge connect c8y

#or

tedge connect az
</code></pre>
<p>Note: The step 1 and 2 can be followed in any order.</p>
<h2 id="update-to-use-default-port"><a class="header" href="#update-to-use-default-port">Update to use default port</a></h2>
<p>To use the default port (1883), the mqtt.port has to be unset using the <code>tedge</code> command as below</p>
<pre><code class="language-shell">tedge config unset mqtt.port
</code></pre>
<p>Once the port is reverted to default, the <a href="howto-guides/008_config_local_mqtt_port.html#Step-3:-Connect-the-thin-edge-device-to-cloud">step 1</a>
and 3 has to be followed to use the default port.</p>
<h2 id="error-case"><a class="header" href="#error-case">Error case</a></h2>
<p>Below example shows that we can not set string value for the port number.</p>
<pre><code class="language-shell">tedge config set mqtt.port '&quot;1234&quot;'

Error: failed to set the configuration key: mqtt.port with value: &quot;1234&quot;.

Caused by:
    Conversion from String failed
</code></pre>
<h2 id="updating-the-mqtt-port-in-collectd--for-collectd-mapper"><a class="header" href="#updating-the-mqtt-port-in-collectd--for-collectd-mapper">Updating the mqtt port in collectd &amp; for collectd-mapper</a></h2>
<p>Update the <code>collectd.conf</code> with the new port in <code>&lt;Plugin mqtt&gt;</code></p>
<p>Restart the collectd service</p>
<pre><code class="language-shell">sudo systemctl restart collectd.service
</code></pre>
<p>After changing the mqtt port and connected to cloud using <code>tedge connect c8y/az</code>,
(Steps 1-3) the collectd-mapper has to be restarted to use the newly set port.</p>
<p>Restart the collectd-mapper service</p>
<pre><code class="language-shell">sudo systemctl restart collectd-mapper.service
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-trouble-shoot-device-monitoring"><a class="header" href="#how-to-trouble-shoot-device-monitoring">How to trouble shoot device monitoring</a></h1>
<p>To install and configure monitoring on your device,
see the tutorial <a href="howto-guides/../tutorials/device-monitoring.html">Monitor your device with collectd</a>.</p>
<h2 id="is-collectd-running"><a class="header" href="#is-collectd-running">Is collectd running?</a></h2>
<pre><code>sudo systemctl status collectd
</code></pre>
<p>If not, launch collected</p>
<pre><code>sudo systemctl start collectd
</code></pre>
<h2 id="is-collectd-publishing-mqtt-messages"><a class="header" href="#is-collectd-publishing-mqtt-messages">Is collectd publishing MQTT messages?</a></h2>
<pre><code>tedge mqtt sub 'collectd/#'
</code></pre>
<p>If no metrics are collected, please check the <a href="howto-guides/../tutorials/device-monitoring.html#collectdconf">MQTT configuration</a></p>
<h2 id="is-the-tedge-mapper-collectdservice-running"><a class="header" href="#is-the-tedge-mapper-collectdservice-running">Is the <code>tedge-mapper-collectd.service</code> running?</a></h2>
<pre><code>sudo systemctl status tedge-mapper-collectd.service
</code></pre>
<p>If not, launch tedge-mapper-collectd.service as below</p>
<pre><code>sudo systemctl start tedge-mapper-collectd.service
</code></pre>
<h2 id="are-the-collectd-metrics-published-in-thin-edge-json-format"><a class="header" href="#are-the-collectd-metrics-published-in-thin-edge-json-format">Are the collectd metrics published in Thin Edge JSON format?</a></h2>
<pre><code>tedge mqtt sub 'tedge/measurements'
</code></pre>
<h2 id="are-the-collectd-metrics-published-to-cumulocity-iot"><a class="header" href="#are-the-collectd-metrics-published-to-cumulocity-iot">Are the collectd metrics published to Cumulocity IoT?</a></h2>
<pre><code>tedge mqtt sub 'c8y/#'
</code></pre>
<p>If not see how to <a href="howto-guides/../tutorials/connect-c8y.html">connect a device to Cumulocity IoT</a></p>
<h2 id="are-the-collectd-metrics-published-to-azure-iot"><a class="header" href="#are-the-collectd-metrics-published-to-azure-iot">Are the collectd metrics published to Azure IoT?</a></h2>
<pre><code>tedge mqtt sub 'az/#'
</code></pre>
<p>If not see how to <a href="howto-guides/../tutorials/connect-azure.html">connect a device to Azure IoT</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-add-self-signed-certificate-to-trusted-certificates-list"><a class="header" href="#how-to-add-self-signed-certificate-to-trusted-certificates-list">How to add self-signed certificate to trusted certificates list</a></h1>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>If the server you are trying to connect <code>thin-edge.io</code> to is presenting a certificate with a root that is not currently trusted, then you can add the server's root certificate to the list of trusted root certificates.
For the most part the store will be filled with certificates from your TLS/SSL provider, but when you want to use self-signed certificates you may need to update your local certificate store.
Below are instructions on how to add new CA certificate and update the certificate store.</p>
<blockquote>
<p>Please note: Provided instructions are for supported OSes and may not apply to the flavour you are running, if you need help with other OS please consult appropriate documentation.</p>
</blockquote>
<h2 id="ubuntu-and-raspberry-pi-os"><a class="header" href="#ubuntu-and-raspberry-pi-os">Ubuntu and Raspberry Pi OS</a></h2>
<blockquote>
<p>If you do not have the <code>ca-certificates</code> package installed on your system, install it with your package manager.</p>
<pre><code class="language-shell">sudo apt install ca-certificates
</code></pre>
</blockquote>
<p>To add a self-signed certificate to the trusted certificate repository on thin-edge.io system:</p>
<p>Create a <code>/usr/local/share/ca-certificates/</code> directory if it does not exist on your computer:</p>
<pre><code class="language-shell">sudo mkdir /usr/local/share/ca-certificates/
</code></pre>
<p>The directory should be owned by <code>root:root</code> and have <code>755</code> permissions set for it. The certificates files should be <code>644</code>.</p>
<p>Copy your root certificate (in <code>PEM</code> format with <code>.crt</code> extension) to the created directory:</p>
<pre><code class="language-shell">sudo cp &lt;full_path_to_the_certificate&gt; /usr/local/share/ca-certificates/
</code></pre>
<p>Install the certificates:</p>
<pre><code class="language-shell">$ sudo update-ca-certificates
Updating certificates in /etc/ssl/certs...
1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d...
done.
</code></pre>
<p>To check the certificate was correctly installed:</p>
<pre><code class="language-shell">sudo ls /etc/ssl/certs | grep &lt;certificate_name&gt;
</code></pre>
<p>Additionally you can check correctness of the installed certificate:</p>
<pre><code class="language-shell">sudo cat /etc/ssl/certs/ca-certificates.crt | grep -f &lt;full_path_to_the_certificate&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="how-to-retrieve-a-jwt-token-to-authenticate-on-cumulocity"><a class="header" href="#how-to-retrieve-a-jwt-token-to-authenticate-on-cumulocity">How to retrieve a JWT Token to authenticate on Cumulocity</a></h2>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>In order to <a href="https://cumulocity.com/guides/10.5.0/reference/rest-implementation/#authentication">authenticate HTTP requests on Cumulocity</a>,
a device can retrieve a JWT token using MQTT.</p>
<h2 id="retrieving-the-token"><a class="header" href="#retrieving-the-token">Retrieving the token</a></h2>
<p>Follow the below steps in order to retrieve the token from the Cumulocity cloud using MQTT.</p>
<p>Subscribe to <code>c8y/s/dat</code> topic</p>
<pre><code>$ tedge mqtt sub c8y/s/dat --no-topic
</code></pre>
<p>Publish an empty message on <code>c8y/s/uat</code> topic</p>
<pre><code>$ tedge mqtt pub c8y/s/uat ''
</code></pre>
<p>After a while the token will be published on the subscribed topic <code>c8y/s/dat</code> in the below format</p>
<p>71,[Base64 encoded JWT token]</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-and-enable-the-software-management-feature"><a class="header" href="#install-and-enable-the-software-management-feature">Install and enable the software management feature</a></h1>
<blockquote>
<p>Note: As of now, this feature is supported only on devices with <strong>debian</strong> based
distributions, which use the <strong>apt</strong> package manager(Ex: RaspberryPi OS , Ubuntu, Debian), from Cumulocity cloud.</p>
</blockquote>
<p>Below steps show how to download, install and enable thin-edge software management feature.</p>
<h2 id="download-and-install-software-management-packages-on-the-device"><a class="header" href="#download-and-install-software-management-packages-on-the-device">Download and install software management packages on the device</a></h2>
<p>As a prerequisite, install <a href="howto-guides/../howto-guides/002_installation.html">tedge and tedge_mapper</a> if not installed already.</p>
<p>The thin-edge software management packages are in repository on GitHub: <a href="https://github.com/thin-edge/thin-edge.io/releases">thin-edge.io</a>.</p>
<p>To download the package from github repository use the following command (use desired version):</p>
<pre><code class="language-shell">curl -LJO https://github.com/thin-edge/thin-edge.io/releases/download/&lt;package&gt;_&lt;version&gt;_&lt;arch&gt;.deb
</code></pre>
<p>where:</p>
<blockquote>
<p><code>version</code> -&gt; thin-edge.io software management components version in x.x.x format</p>
<p><code>arch</code> -&gt; architecture type (amd64, armhf)</p>
</blockquote>
<p>Download <code>tedge_apt_plugin</code> and <code>tedge_agent</code></p>
<pre><code class="language-shell">curl -LJO https://github.com/thin-edge/thin-edge.io/releases/download/0.5.0/tedge_apt_plugin_0.5.0_armhf.deb
curl -LJO https://github.com/thin-edge/thin-edge.io/releases/download/0.5.0/tedge_agent_0.5.0_armhf.deb
</code></pre>
<p>Once the packages are downloaded, proceed to installation.</p>
<p>To install <code>tedge_apt_plugin</code> and <code>tedge_agent</code> on thin-edge device do:</p>
<pre><code class="language-shell">sudo dpkg -i tedge_apt_plugin_&lt;version&gt;_&lt;arch&gt;.deb
sudo dpkg -i tedge_agent&lt;version&gt;_&lt;arch&gt;.deb
</code></pre>
<blockquote>
<p>Note: Software management feature will be enabled after installation if the device
is connected to the Cumulocity cloud using <code>tedge connect c8y</code>.</p>
</blockquote>
<h2 id="start-and-enable-the-software-management-feature"><a class="header" href="#start-and-enable-the-software-management-feature">Start and enable the software management feature</a></h2>
<h3 id="using-tedge-connect-c8y"><a class="header" href="#using-tedge-connect-c8y">Using <code>tedge connect c8y</code></a></h3>
<p>The <code>tedge connect c8y</code> will automatically start and enable the software management feature.
Find more about <a href="howto-guides/../howto-guides/004_connect.html">how to connect thin-edge device to cloud</a></p>
<p>Once the thin-edge device is successfully connected to Cumulocity cloud, the <strong>Software</strong> option will be enabled and
the list of softwares that are installed on the device will be visible as shown in the figure below.</p>
<p><img src="howto-guides/./images/start-software-management.png" alt="Add new software" /></p>
<blockquote>
<p>Note: Disconnecting thin-edge device from cloud with <code>tedge disconnect c8y</code> command will stop and disable the software management feature.</p>
</blockquote>
<h3 id="manually-enabling-and-disabling-software-management-feature"><a class="header" href="#manually-enabling-and-disabling-software-management-feature">Manually enabling and disabling software management feature</a></h3>
<p>For debugging purpose or to disable/enable the software management services, one can start/stop manually as shown below.</p>
<h3 id="starting-the-services"><a class="header" href="#starting-the-services">Starting the services</a></h3>
<pre><code class="language-shell">sudo systemctl start tedge-agent.service
sudo systemctl start tedge-mapper-sm-c8y.service
</code></pre>
<h3 id="stopping-the-services"><a class="header" href="#stopping-the-services">Stopping the services</a></h3>
<pre><code class="language-shell">sudo systemctl stop tedge-agent.service
sudo systemctl stop tedge-mapper-sm-c8y.service
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="connecting-an-external-device-to-thin-edgeio"><a class="header" href="#connecting-an-external-device-to-thin-edgeio">Connecting an external device to <code>thin-edge.io</code></a></h1>
<p>With <code>thin-edge.io</code> you can enable connection for external devices to your <code>thin-edge.io</code> enabled device with the use of a few commands.</p>
<blockquote>
<p>Note: Currently, only one additional listener can be defined.</p>
</blockquote>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>External devices connection can be setup by using the <code>tedge</code> cli tool making some changes to the configuration.</p>
<p>The following configurations option are available for you if you want to add an external listener to thin-edge.io:</p>
<p><code>mqtt.external.port</code>             Mqtt broker port, which is used by the external mqtt clients to publish or subscribe. Example: 8883
<code>mqtt.external.bind_address</code>     IP address / hostname, which the mqtt broker limits incoming connections on. Example: 0.0.0.0
<code>mqtt.external.bind_interface</code>   Name of network interface, which the mqtt broker limits incoming connections on. Example: wlan0</p>
<p><code>mqtt.external.capath</code>           Path to a file containing the PEM encoded CA certificates that are trusted when checking incoming client certificates. Example: /etc/ssl/certs
<code>mqtt.external.certfile</code>         Path to the certificate file, which is used by external MQTT listener. Example: /etc/tedge/server-certs/tedge-certificate.pem
<code>mqtt.external.keyfile</code>          Path to the private key file, which is used by external MQTT listener. Example: /etc/tedge/server-certs/tedge-private-key.pem</p>
<blockquote>
<p>If none of these options is set, then no external listener is set.
If one of these options is set, then default values are inferred by the MQTT server (Mosquitto). For instance, the port defaults to 1883 for a non-TLS listener, and to 8883 for a TLS listener.</p>
</blockquote>
<p>These settings can be considered in 2 groups, listener configuration and TLS configuration.</p>
<h3 id="configure-basic-listener"><a class="header" href="#configure-basic-listener">Configure basic listener</a></h3>
<p>To configure basic listener you should provide port and/or bind address which will use default interface.
To change the default interface you can use mqtt.external.bind_interface configuration option.</p>
<p>To set them you can use <code>tedge config</code> as so:</p>
<pre><code class="language-shell">tedge config set mqtt.external.port 8883
</code></pre>
<p>To allow connections from all IP addresses on the interface:</p>
<pre><code class="language-shell">tedge config set mqtt.external.bind_address 0.0.0.0
</code></pre>
<h3 id="configure-tls-on-the-listener"><a class="header" href="#configure-tls-on-the-listener">Configure TLS on the listener</a></h3>
<p>To configure the external listener with TLS additional settings are available: <code>mqtt.external.capath</code> <code>mqtt.external.certfile</code> <code>mqtt.external.keyfile</code></p>
<p>To enable MQTT over TLS, a server side certificate must be configured using the 2 following settings:</p>
<pre><code class="language-shell">tedge config set mqtt.external.certfile /etc/tedge/server-certs/tedge-certificate.pem
tedge config set mqtt.external.keyfile /etc/tedge/server-certs/tedge-private-key.pem
</code></pre>
<p>To fully enable TLS authentication clients, client side certificate validation can be enabled:</p>
<pre><code class="language-shell">tedge config set mqtt.external.capath /etc/ssl/certs
</code></pre>
<blockquote>
<p>Note: Providing all 3 configuration will trigger thin-edge.io to require client certificates.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-thin-edge-logs"><a class="header" href="#the-thin-edge-logs">The thin-edge logs</a></h1>
<p>The logs that are useful for debugging thin-edge.io break down into logs that are created by thin-edge itself and by third party components.</p>
<h2 id="thin-edge-logs"><a class="header" href="#thin-edge-logs">Thin-edge logs</a></h2>
<p>On a thin-edge device different components like mappers, agent, and plugins run. The log messages of these components can be accessed as below.
The logs here capture INFO, WARNING, and ERROR messages.</p>
<h3 id="cloud-mapper-logs"><a class="header" href="#cloud-mapper-logs">Cloud mapper logs</a></h3>
<p>The thin-edge cloud mapper component that sends the measurement data to the cloud can be accessed as below.</p>
<h4 id="tedge-cumulocity-mapper"><a class="header" href="#tedge-cumulocity-mapper">Tedge Cumulocity mapper</a></h4>
<p>The log messages of the Cumulocity mapper component that sends the measurement data from the thin-edge device to the Cumulocity
cloud can be accessed as below</p>
<p><code>journalctl -u tedge-mapper-c8y.service</code></p>
<blockquote>
<p>Note: Run <code>tedge_mapper --debug c8y</code> to log more debug messages</p>
</blockquote>
<h4 id="tedge-azure-mapper"><a class="header" href="#tedge-azure-mapper">Tedge Azure mapper</a></h4>
<p>The log messages of the Azure mapper component that sends the measurement data from the thin-edge device to the Azure
cloud can be accessed as below.</p>
<p><code>journalctl -u tedge-mapper-az.service</code></p>
<blockquote>
<p>Note: Run <code>tedge_mapper --debug az</code> to log more debug messages</p>
</blockquote>
<h3 id="device-monitoring-logs"><a class="header" href="#device-monitoring-logs">Device monitoring logs</a></h3>
<p>The thin-edge device monitoring component logs can be found as below</p>
<h4 id="collectd-mapper-logs"><a class="header" href="#collectd-mapper-logs">Collectd mapper logs</a></h4>
<p>The log messages of the collectd mapper that sends the monitoring data to the cloud can be accessed as below</p>
<p><code>journalctl -u tedge-mapper-collectd.service</code></p>
<blockquote>
<p>Note: Run <code>tedge_mapper --debug collectd</code> to log more debug messages</p>
</blockquote>
<h3 id="software-management-logs"><a class="header" href="#software-management-logs">Software Management logs</a></h3>
<p>This section describes how to access the software management component logs</p>
<h4 id="software-update-operation-log"><a class="header" href="#software-update-operation-log">Software update operation log</a></h4>
<p>For every new software operation (list/update), a new log file will be created at <code>/var/log/tedge/agent</code>.
For each <code>plugin command</code> like prepare, update-list (install, remove), finalize, and list,
the log file captures <code>exit status, stdout, and stderr</code> messages.</p>
<h4 id="tedge-agent-logs"><a class="header" href="#tedge-agent-logs">Tedge Agent logs</a></h4>
<p>The agent service logs can be accessed as below</p>
<p><code>journalctl -u tedge-agent.service</code></p>
<p>For example: tedge-agent logs plugin calls finalize and list.</p>
<p>tedge-agent : TTY=unknown ; PWD=/tmp ; USER=root ; COMMAND=/etc/tedge/sm-plugins/apt finalize</p>
<p>tedge-agent : TTY=unknown ; PWD=/tmp ; USER=root ; COMMAND=/etc/tedge/sm-plugins/apt list</p>
<blockquote>
<p>Note: Run <code>tedge_agent --debug</code> to log more debug messages</p>
</blockquote>
<h4 id="tedge-cumulocity-sm-mapper-logs"><a class="header" href="#tedge-cumulocity-sm-mapper-logs">Tedge cumulocity sm mapper logs</a></h4>
<p>The software management mapper service logs can be accessed as below</p>
<p><code>journalctl -u tedge-mapper-sm-c8y.service</code></p>
<p>For example: tedge_mapper[6696]: 2021-09-29T03:38:53.853+00:00 ERROR tedge_mapper::mapper: MQTT connection error: I/O: Connection refused</p>
<blockquote>
<p>Note: Run <code>tedge_mapper --debug sm-c8y</code> to log more debug messages</p>
</blockquote>
<h2 id="thirdparty-component-logs"><a class="header" href="#thirdparty-component-logs">Thirdparty component logs</a></h2>
<p>Thin-edge uses the third-party components <code>Mosquitto</code> as the mqtt broker and <code>Collectd</code> for monitoring purpose.
The logs that are created by these components can be accessed on a thin-edge device as below.</p>
<h3 id="mosquitto-logs"><a class="header" href="#mosquitto-logs">Mosquitto logs</a></h3>
<p>Thin-edge uses <code>Mosquitto</code> as the <code>mqtt broker</code> for local communication as well as to communicate with the cloud.
The <code>Mosquitto</code> logs can be found in <code>/var/log/mosquitto/mosquitto.log</code>.
<code>Mosquitto</code> captures error, warning, notice, information, subscribe, and unsubscribe messages.</p>
<blockquote>
<p>Note: Set <code>log_type debug</code> or <code>log_type all</code> on /etc/mosquitto/mosquitto.conf, to capture more debug information.</p>
</blockquote>
<h3 id="collectd-logs"><a class="header" href="#collectd-logs">Collectd logs</a></h3>
<p><code>Collectd</code> is used for monitoring the resource status of a thin-edge device.
Collectd logs all the messages at <code>/var/log/syslog</code>.
So, the collectd specific logs can be accessed using the <code>journalctl</code> as below</p>
<p><code>journalctl -u collectd.service</code></p>
<h2 id="accessing-logs-remotely"><a class="header" href="#accessing-logs-remotely">Accessing logs remotely</a></h2>
<p>You can access logs from Cumulocity's &quot;Logs&quot; tab in Device Management. Do to this, go to the device you want to the logs for
and click on the &quot;Logs&quot; button on the left-hand side. Next, click on the &quot;Request log file&quot; button located in the top right corner. 
This will bring a dropdown into view where you can select the date and time range, the type of log required as well as filter 
for any particular words in the logs (such as ERROR) and select the total number of lines to upload.</p>
<p><img src="howto-guides/images/log_request_dropdown.png" alt="Log request dropdown" /></p>
<p>Logs are uploaded in the &quot;Events&quot; tab, where you can download them. </p>
<p><img src="howto-guides/images/log_request_events_tab.png" alt="Log request events tab" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-install-thin-edgeio-on-any-linux-os-no-deb-support"><a class="header" href="#how-to-install-thin-edgeio-on-any-linux-os-no-deb-support">How to install <code>thin-edge.io</code> on any Linux OS (no deb support)?</a></h1>
<h2 id="thin-edgeio-on-supported-platforms"><a class="header" href="#thin-edgeio-on-supported-platforms"><code>thin-edge.io</code> on supported platforms</a></h2>
<p><code>thin-edge.io</code> can be installed on a range of platforms, a platform is defined as a set of hardware architecture and OS, more details can be found in <a href="howto-guides/../supported-platforms.html">Supported Platforms</a> document.</p>
<p>Out of the box <code>thin-edge.io</code> uses deb packages for an automated installation (<a href="howto-guides/./002_installation.html">Installation Guide</a>), you can install it yourself on any Linux system as long as you follow the guidelines below.</p>
<h2 id="installation-on-unsupported-platforms"><a class="header" href="#installation-on-unsupported-platforms">Installation on 'unsupported platforms'</a></h2>
<h3 id="obtaining-binaries"><a class="header" href="#obtaining-binaries">Obtaining binaries</a></h3>
<p>The prebuilt binaries can be obtained from <code>thin-edge.io</code> <a href="https://github.com/thin-edge/thin-edge.io/releases">repository releases</a>.</p>
<p>By default <code>thin-edge.io</code> is built with 3 architectures in mind: <code>amd64 (x86_64)</code>, <code>arm64 (aarch64)</code> and <code>armhf</code> with gnulibc bindings, so if you are looking to install <code>thin-edge.io</code> on a different platform you have to build your own binaries from source which you can do easily if you follow the <a href="howto-guides/./../BUILDING.html">Building <code>thin-edge.io</code></a> guide.</p>
<blockquote>
<p>Note: By default <code>thin-edge.io</code> is built with <code>GNU libc</code>, but it is possible to use <code>musl</code> instead.</p>
</blockquote>
<p>Full installation of <code>thin-edge.io</code> requires the following components:</p>
<ul>
<li>tedge</li>
<li>tedge-mapper</li>
<li>tedge-agent</li>
</ul>
<h4 id="extracting-binaries-from-deb-packages"><a class="header" href="#extracting-binaries-from-deb-packages">Extracting binaries from deb packages</a></h4>
<blockquote>
<p>Required packages:</p>
<ul>
<li>ar</li>
<li>tar</li>
</ul>
</blockquote>
<p>Currently all binaries provided with releases are packaged into <code>deb</code> packages.
<code>deb</code> packages can be extracted to get the binaries for installation (example):</p>
<pre><code class="language-shell">ar -x tedge_&lt;version&gt;_amd64.deb | tar -xf data.tar.xz
ar -x tedge_agent_&lt;version&gt;_amd64.deb | tar -xf data.tar.xz
ar -x tedge_mapper_&lt;version&gt;_amd64.deb | tar -xf data.tar.xz
</code></pre>
<p>Which should give you <code>usr</code> and/or <code>lib</code> directory where you can find binaries.
After extracting all packages, you should now adjust permissions on those files:</p>
<pre><code class="language-shell">chown root:root /usr/bin/tedge
chown root:root /usr/bin/tedge_agent
chown root:root /usr/bin/tedge_mapper
</code></pre>
<p>and then move your binaries to the appropriate directory, eg:</p>
<pre><code class="language-shell">mv ./lib/ ./bin/ /
</code></pre>
<h4 id="if-building-from-source"><a class="header" href="#if-building-from-source">If building from source</a></h4>
<p>If you have built the binaries from source you should install them on the target in: <code>/usr/bin/</code>.</p>
<p><code>systemd</code> unit files for <code>tedge_mapper</code> and <code>tedge_agent</code> can be found in the repository at <code>configuration/init/systemd/tedge-*</code> and should be installed on the target in: <code>lib/systemd/system/tedge-*</code>.</p>
<h3 id="configuring-the-system-and-systemd-units"><a class="header" href="#configuring-the-system-and-systemd-units">Configuring the system and systemd-units</a></h3>
<p><code>thin-edge.io</code> relies on certain system configuration and systemd process management, when installing from deb package all of that is setup automatically but with manual installation a set of steps has to be performed.</p>
<p>On most Linux distribution it should suffice to execute them as <code>root</code> to do the setup, but in some cases (eg, your system uses <code>useradd</code> instead of <code>adduser</code> package) more detailed instructions are documented:</p>
<ul>
<li><a href="https://github.com/thin-edge/thin-edge.io/blob/main/configuration/debian/tedge/postinst">tedge</a></li>
<li><a href="https://github.com/thin-edge/thin-edge.io/blob/main/configuration/debian/tedge_agent/postinst">tedge-agent</a></li>
<li><a href="https://github.com/thin-edge/thin-edge.io/blob/main/configuration/debian/tedge_mapper/postinst">tedge-mapper</a></li>
</ul>
<p>After following steps for all the components installed <code>thin-edge.io</code> should be operational.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-restart-your-thin-edgeio-device"><a class="header" href="#how-to-restart-your-thin-edgeio-device">How to restart your thin-edge.io device</a></h1>
<p>If your device is running thin-edge.io, you can restart it from the cloud. This guide shows how to trigger a restart operation from different cloud providers.</p>
<h3 id="cumulocity"><a class="header" href="#cumulocity">Cumulocity</a></h3>
<p>Go to your device's homepage on c8y, and find the &quot;Control&quot; button. </p>
<p><img src="howto-guides/./images/control-button-red-highlight.png" alt="Control button" /></p>
<p>In the top right corner, you will find the &quot;More&quot; button, click it and select, &quot;Restart device&quot;.</p>
<p><img src="howto-guides/./images/restart-button-red-highlight.png" alt="Restart device button" /></p>
<h3 id="azure"><a class="header" href="#azure">Azure</a></h3>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apama-software-management-plugin"><a class="header" href="#apama-software-management-plugin">Apama Software Management Plugin</a></h1>
<p>The apama plugin can be used to install and manage apama artefacts.
This plugin can be used to install an apama project on a device as well as inject monitor files into an already installed project.</p>
<h2 id="download-and-install-apama-plugin"><a class="header" href="#download-and-install-apama-plugin">Download and Install Apama Plugin</a></h2>
<blockquote>
<p>Note: This plugin expects an apama installation on the device which is managed as a System V service. If Apama is not installed or if the System V init script is not installed, follow the Apama installation instructions <a href="https://github.com/thin-edge/thin-edge.io_examples/tree/main/StreamingAnalytics#setup-and-configuration">here</a> before installing/using the apama plugin.</p>
</blockquote>
<p>Apama plugin is delivered as a debian package which can be downloaded from the releases section of thin-edge.io repository on <a href="https://github.com/thin-edge/thin-edge.io/releases">GitHub</a>.</p>
<p>Example command for downloading the <code>0.5.0</code> version of the plugin for <code>armhf</code> architecture (Adjust the version and architecture values as per your requirements):</p>
<pre><code class="language-shell">curl -LJO https://github.com/thin-edge/thin-edge.io/releases/download/0.5.0/tedge_apama_plugin_0.5.0_armhf.deb
</code></pre>
<p>Once the debian package is downloaded, install it with the <code>dpkg</code> command:</p>
<pre><code class="language-shell">sudo dpkg -i tedge_apama_plugin_0.5.0_armhf.deb
</code></pre>
<p>Once the plugin is installed on the device, you can install apama projects and mon files using Cumulocity software management feature.</p>
<h2 id="install-apama-artefacts-from-cumulocity"><a class="header" href="#install-apama-artefacts-from-cumulocity">Install Apama artefacts from Cumulocity</a></h2>
<p>Before an apama project or a mon files can be installed on the device using the software management feature in Cumulocity, these project files or monitor files need to be added to the Cumulocity software repository first.</p>
<p>There's some naming convention that you need to follow while creating software entries for apama artefacts in the software repository.</p>
<p>For apama projects:</p>
<ol>
<li>Name must be suffixed with <code>::project</code> as in <code>my-demo-project::project</code></li>
<li>Version must be suffixed with <code>::apama</code> as in <code>1.0::apama</code> or just <code>::apama</code> if you don't need a version number.</li>
<li>The uploaded binary must be a <code>zip</code> file that contains the <code>project</code> directory. If a directory named <code>project</code> is not found at the root level in the zip, it's considered invalid.</li>
</ol>
<p><img src="howto-guides/./images/apama-plugin/apama-project-c8y-software-repository.png" alt="Add new apama project in Software Repository" /></p>
<p>For apama monitor file:</p>
<ol>
<li>Name must be suffixed with <code>::mon</code> as in <code>MyDemoMonitor::mon</code></li>
<li>Version must be suffixed with <code>::apama</code> as in <code>2.0::apama</code> or just <code>::apama</code> if you don't need a version number.</li>
<li>The uploaded binary must be a <code>mon</code> file with <code>.mon</code> extension</li>
</ol>
<p><img src="howto-guides/./images/apama-plugin/apama-monitor-c8y-software-repository.png" alt="Add new apama monitor file in Software Repository" /></p>
<p>Once the software modules are added in the software repository, these can be installed on the device just like any other software from the <code>Software</code> tab of the device in Cumulocity device UI.</p>
<h3 id="testing-apama-plugin"><a class="header" href="#testing-apama-plugin">Testing Apama Plugin</a></h3>
<p>Here are some test apama artefacts that you can use to test this plugin:</p>
<ol>
<li>Demo apama <a href="https://github.com/thin-edge/thin-edge.io/raw/main/tests/PySys/plugin_apama/Input/quickstart.zip">project zip</a></li>
<li>Demo apama <a href="https://github.com/thin-edge/thin-edge.io/raw/main/tests/PySys/plugin_apama/Input/TedgeTestMonitor.mon">monitor file</a></li>
</ol>
<p>Add these binaries as software packages in Cumulocity software repository by following the instructions in the previous section.
Once added, this apama project can be installed on any target device.
You can test if the project got successfully installed by running the following Apama command:</p>
<pre><code class="language-shell">/opt/softwareag/Apama/bin/apama_env engine_inspect -m
</code></pre>
<p>And you can expect an output like this:</p>
<pre><code class="language-console">Monitors
========
Name                                               Num Sub Monitors
----                                               ----------------
TedgeDemoMonitor                                             1
</code></pre>
<p>You can find more information on this apama project <a href="https://github.com/thin-edge/thin-edge.io_examples/tree/main/StreamingAnalytics#testing-a-project">here</a></p>
<p>Once the project installation is validated successfully, you can install the demo monitor file as well just like you installed the project from Cumulocity.
Once the installation succeeds, you can validate if this monitor file got injected successfully by running the same <code>engine_inspect</code> command and you should get an output like this with a second monitor in the list named <code>TedgeTestMonitor</code>:</p>
<pre><code class="language-console">Monitors
========
Name                                               Num Sub Monitors
----                                               ----------------
TedgeDemoMonitor                                             1
TedgeTestMonitor                                             1
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-change-temp-path"><a class="header" href="#how-to-change-temp-path">How to change temp path</a></h1>
<p>The <code>tedge</code> command can be used to change the temp path. By default the directory used is <code>/tmp</code>. </p>
<p>To change the temp path, run:</p>
<pre><code class="language-shell">sudo tedge config set tmp.path /path/to/directory
</code></pre>
<p>Note that the directory must be available to <code>tedge-agent</code> user and <code>tedge-agent</code> group.</p>
<p>For example:</p>
<pre><code class="language-shell"># create a directory (with/without sudo)

mkdir ~/tedge_tmp_dir

# give ownership to tedge-agent

sudo chown tedge-agent:tedge-agent ~/tedge_tmp_dir 

# reconnect to cloud.
</code></pre>
<p>To revert the path back to its default value:</p>
<pre><code class="language-shell">sudo tedge config unset tmp.path
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-use-thin-edgeio-with-your-preferred-init-system"><a class="header" href="#how-to-use-thin-edgeio-with-your-preferred-init-system">How to use thin-edge.io with your preferred init system</a></h1>
<p>thin-edge.io works seamlessly with <code>systemd</code> on the CLI commands <code>tedge connect</code> and <code>tedge disconnect</code>.
However, not all OS support <code>systemd</code>.
You might want to use another init system like <code>OpenRC</code>, <code>BSD</code>, <code>init.d</code> with thin-edge.io.
This guide explains how to configure thin-edge.io to use another init system.</p>
<h2 id="how-to-set-a-custom-init-system-configuration"><a class="header" href="#how-to-set-a-custom-init-system-configuration">How to set a custom init system configuration</a></h2>
<p>Create a file <code>system.toml</code> owned by <code>root:root</code> in <code>/etc/tedge</code> directory.</p>
<pre><code class="language-shell">sudo touch /etc/tedge/system.toml
</code></pre>
<p>Open your editor and copy and paste the following toml contents.
This is an example how to configure OpenRC as the init system for thin-edge.io.
We have example configurations for BSD, OpenRC, and systemd under <a href="https://github.com/thin-edge/thin-edge.io/tree/main/configuration/contrib/system">thin-edge.io/configuration/contrib/system</a>.</p>
<pre><code class="language-toml">[init]
name = &quot;OpenRC&quot;
is_available = [&quot;/sbin/rc-service&quot;, &quot;-l&quot;]
restart = [&quot;/sbin/rc-service&quot;, &quot;{}&quot;, &quot;restart&quot;]
stop =  [&quot;/sbin/rc-service&quot;, &quot;{}&quot;, &quot;stop&quot;]
enable =  [&quot;/sbin/rc-update&quot;, &quot;add&quot;, &quot;{}&quot;]
disable =  [&quot;/sbin/rc-update&quot;, &quot;delete&quot;, &quot;{}&quot;]
is_active = [&quot;/sbin/rc-service&quot;, &quot;{}&quot;, &quot;status&quot;]
</code></pre>
<p>Then, adjust the values with your preferred init system.
To get to know the rules of the configuration file, please refer to <a href="howto-guides/./../references/init-system-config.html">Init System Configuration File</a>.</p>
<p>After you finish creating your own configuration file, it's good to limit the file permission to read-only.</p>
<pre><code class="language-shell">sudo chmod 444 /etc/tedge/system.toml
</code></pre>
<p>Now <code>tedge connect</code> and <code>tedge disconnect</code> will use the init system that you specified!</p>
<h2 id="default-settings"><a class="header" href="#default-settings">Default settings</a></h2>
<p>If the custom configuration file <code>/etc/tedge/system.toml</code> is not in place,
<code>tedge connect</code> and <code>tedge disconnect</code> will use <code>/bin/systemctl</code> as the init system.</p>
<h2 id="reference-document"><a class="header" href="#reference-document">Reference document</a></h2>
<ul>
<li><a href="howto-guides/./../references/init-system-config.html">Init System Configuration File</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-documentation"><a class="header" href="#developer-documentation">Developer Documentation</a></h1>
<p>The Developer Documentation for everybody who is interested in extending thin-edge.io. For more deeper interested users this also might be interesting, even if not required to operate thin-edge.io.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p>Thin-edge.io is an open-source framework to develop lightweight, smart and secure connected devices.</p>
<p>Cloud agnostic, thin-edge.io provides the foundations for cloud connectivity and device management,
a set of pre-packaged  modules, plug &amp; play connectors to cloud platforms,
device certificate management, monitoring as well as built-in software and firmware management.</p>
<p>On top of these foundations, telemetry applications can be built using a combination of components provided by various IoT actors.
The features provided by these components can be as diverse as low-level connectivity to IoT protocols,
event-stream analytics, machine-learning-powered systems, or application specific processors.</p>
<p>Built around an extensible architecture,
thin-edge.io can be extended in various programming languages.
Here are the key aspects of the thin-edge.io architecture:</p>
<ol>
<li>
<p>The components are processes exchanging messages over an MQTT bus.</p>
</li>
<li>
<p>The MQTT bus is connected to the cloud, forwarding the messages published on cloud specific topics. </p>
</li>
<li>
<p>A <a href="architecture/thin-edge-json.html">canonical data format</a> let the components exchange telemetry data independently of the connected cloud.
This is an optional feature, and the components are free to also use cloud specific data formats.</p>
</li>
<li>
<p>The mapper processes are responsible for translating the canonical data format into cloud specific messages and vice versa.</p>
</li>
</ol>
<p><img src="architecture/./images/thin-edge-overview.png" alt="Overview" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="thin-edge-json-format"><a class="header" href="#thin-edge-json-format">Thin Edge JSON format</a></h1>
<p>Thin Edge JSON is a lightweight format used in <code>thin-edge.io</code> to represent measurements data.
This format can be used to represent single-valued measurements, multi-valued measurements
or a combination of both along with some auxiliary data like the timestamp at which the measurement(s) was generated.</p>
<h2 id="single-valued-measurements"><a class="header" href="#single-valued-measurements">Single-valued measurements</a></h2>
<p>Simple single-valued measurements like temperature or pressure measurement with a single value can be expressed as follows:</p>
<pre><code class="language-json">{
    &quot;temperature&quot;: 25
}
</code></pre>
<p>where the key represents the measurement type, and the value represents the measurement value.
The keys can only have alphanumeric characters, and the &quot;_&quot; (underscore) character but must not start with an underscore.
The values can only be numeric.
String, Boolean or other JSON object values are not allowed.</p>
<h2 id="multi-valued-measurements"><a class="header" href="#multi-valued-measurements">Multi-valued measurements</a></h2>
<p>A multi-valued measurement is a measurement that is comprised of multiple values. Here is the representation of a
<code>three_phase_current</code> measurement that consists of <code>L1</code>, <code>L2</code> and <code>L3</code> values, representing the current on each phase:</p>
<pre><code class="language-json">{
    &quot;three_phase_current&quot;: {
      &quot;L1&quot;: 9.5,
      &quot;L2&quot;: 10.3,
      &quot;L3&quot;: 8.8
    }
}
</code></pre>
<p>where the key is the top-level measurement type and value is a JSON object having further key-value pairs 
representing each aspect of the multi-valued measurement.
Only one level of nesting is allowed, meaning the values of the measurement keys at the inner level can only be numeric values.
For example, a multi-level measurement as follows is NOT valid: </p>
<pre><code class="language-json">{ 
    &quot;three_phase_current&quot;: {
        &quot;phase1&quot;: {
            &quot;L1&quot;: 9.5
        },
        &quot;phase2&quot;: {
            &quot;L2&quot;: 10.3
        },
        &quot;phase3&quot;: {
            &quot;L3&quot;: 8.8
        }
    }
}
</code></pre>
<p>because the values at the second level(<code>phase1</code>, <code>phase2</code> and <code>phase3</code>) are not numeric values.</p>
<h2 id="grouping-measurements"><a class="header" href="#grouping-measurements">Grouping measurements</a></h2>
<p>Multiple single-valued and multi-valued measurements can be grouped into a single Thin Edge JSON message as follows:</p>
<pre><code class="language-json">{ 
    &quot;temperature&quot;: 25,
    &quot;three_phase_current&quot;: {
        &quot;L1&quot;: 9.5,
        &quot;L2&quot;: 10.3,
        &quot;L3&quot;: 8.8
    },
    &quot;pressure&quot;: 98 
}
</code></pre>
<p>The grouping of measurements is usually done to represent measurements collected at the same instant of time.</p>
<h2 id="auxiliary-measurement-data"><a class="header" href="#auxiliary-measurement-data">Auxiliary measurement data</a></h2>
<p>When <code>thin-edge.io</code> receives a measurement, it will add a timestamp to it before any further processing.
If the user doesn't want to rely on <code>thin-edge.io</code> generated timestamps,
an explicit timestamp can be provided in the measurement message itself by adding the time value as a string 
in ISO 8601 format using <code>time</code> as the key name, as follows:</p>
<pre><code class="language-json">{ 
    &quot;time&quot;: &quot;2020-10-15T05:30:47+00:00&quot;, 
    &quot;temperature&quot;: 25, 
    &quot;location&quot;: { 
        &quot;latitude&quot;: 32.54, 
        &quot;longitude&quot;: -117.67, 
        &quot;altitude&quot;: 98.6 
    }, 
    &quot;pressure&quot;: 98 
}
</code></pre>
<p>The <code>time</code> key is a reserved keyword and hence can not be used as a measurement key.
The <code>time</code> field must be defined at the root level of the measurement JSON and not allowed at any other level,
like inside the object value of a multi-valued measurement.
Non-numeric values like the ISO 8601 timestamp string are allowed only for such reserved keys and not for regular measurements. </p>
<p>Here is the complete list of reserved keys that has special meanings inside the <code>thin-edge.io</code> framework
and hence must not be used as measurement keys:</p>
<table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody>
<tr><td>time</td><td>Timestamp in ISO 8601 string format</td></tr>
<tr><td>type</td><td>Internal to <code>thin-edge.io</code></td></tr>
</tbody></table>
<h2 id="sending-measurements-to-thin-edgeio"><a class="header" href="#sending-measurements-to-thin-edgeio">Sending measurements to thin-edge.io</a></h2>
<p>The <code>thin-edge.io</code> framework exposes some MQTT endpoints that can be used by local processes
to exchange data between themselves as well as to get some data forwarded to the cloud.
It will essentially act like an MQTT broker against which you can write your application logic.
Other thin-edge processes can use this broker as an inter-process communication mechanism by publishing and 
subscribing to various MQTT topics.
Any data can be forwarded to the connected cloud-provider as well, by publishing the data to some standard topics.</p>
<p>All topics with the prefix <code>tedge/</code> are reserved by <code>thin-edge.io</code> for this purpose.
To send measurements to <code>thin-edge.io</code>, the measurements represented in Thin Edge JSON format can be published 
to the <code>tedge/measurements</code> topic.
Other processes running on the thin-edge device can subscribe to this topic to process these measurements.</p>
<p>If the messages published to this <code>tedge/measurements</code> topic is not a well-formed Thin Edge JSON, 
then that message won’t be processed by <code>thin-edge.io</code>, not even partially,
and an appropriate error message on why the validation failed will be published to a dedicated <code>tedge/errors</code> topic.
The messages published to this topic will be highly verbose error messages and can be used for any debugging during development.
You should not rely on the structure of these error messages to automate any actions as they are purely textual data 
and bound to change from time-to-time.</p>
<p>More topics will be added under the <code>tedge/</code> topic in future to support more data types like events, alarms etc.
So, it is advised to avoid any sub-topics under <code>tedge/</code> for any other data exchange between processes.</p>
<p>Here is the complete list of topics reserved by <code>thin-edge.io</code> for its internal working:</p>
<table><thead><tr><th>Topic</th><th>Description</th></tr></thead><tbody>
<tr><td><code>tedge/</code></td><td>Reserved root topic of <code>thin-edge.io</code></td></tr>
<tr><td><code>tedge/measurements</code></td><td>Topic to publish measurements to <code>thin-edge.io</code></td></tr>
<tr><td><code>tedge/measurements/&lt;child-id&gt;</code></td><td>Topic to publish measurements to <code>thin-edge.io</code>'s child device</td></tr>
<tr><td><code>tedge/errors</code></td><td>Topic to subscribe to receive any error messages emitted by <code>thin-edge.io</code> while processing measurements</td></tr>
</tbody></table>
<h2 id="sending-measurements-to-the-cloud"><a class="header" href="#sending-measurements-to-the-cloud">Sending measurements to the cloud</a></h2>
<p>The <code>thin-edge.io</code> framework allows users forward all the measurements generated and published to
<code>tedge/measurements</code> MQTT topic in the thin-edge device to any IoT cloud provider that it is connected to,
with the help of a <em>mapper</em> component designed for that cloud.
The responsibility of a mapper is to subscribe to the <code>tedge/measurements</code> topic to receive all incoming measurements 
represented in the cloud vendor neutral Thin Edge JSON format, to a format that the connected cloud understands.
Refer to <a href="architecture/./mapper.html">Cloud Message Mapper Architecture</a> for more details on the mapper component.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tedge-mapper"><a class="header" href="#the-tedge-mapper">The tedge-mapper</a></h1>
<p>The tedge-mapper is a key concept to support multiple cloud providers.
The purpose is to translate
messages written using the cloud-agnostic <a href="architecture/thin-edge-json.html">Thin Edge JSON format</a>,
into cloud-specific messages.</p>
<p>The tedge-mapper is composed of multiple cloud-specific mappers, such as Cumulocity mapper and Azure mapper.
Each mapper is responsible for its dedicated cloud.
These specific mappers are launched by the respective <code>tedge connect</code> command.
For instance, <code>tedge connect c8y</code> establishes a bridge to Cumulocity and launches a Cumulocity mapper
that translates the messages in the background.</p>
<p>A mapper subscribes to the reserved MQTT topic <code>tedge/measurements</code> with the QoS level 1 (at least once).
The messages that arrive in the mapper should be formed in the <a href="architecture/thin-edge-json.html">Thin Edge JSON</a> format.
The mapper verifies whether the arrived messages are correctly formatted,
in case the verification fails, the mapper publishes a corresponded error message
on the topic <code>tedge/errors</code> with the QoS level 1 (at least once).</p>
<p>When the mapper receives a correctly formatted message, 
the message will be translated into a cloud-specific format.</p>
<h2 id="cumulocity-mapper"><a class="header" href="#cumulocity-mapper">Cumulocity mapper</a></h2>
<p>The Cumulocity mapper translates <a href="architecture/thin-edge-json.html">Thin Edge JSON</a> into Cumulocity's <a href="https://cumulocity.com/guides/device-sdk/mqtt/#json">JSON via MQTT</a>.
The translated messages are published on the topic <code>c8y/measurement/measurements/create</code> from where they are forwarded to Cumulocity.
This mapper is launched by the <code>tedge connect c8y</code> command, and stopped by the <code>tedge disconnect c8y</code> command.</p>
<p>Example in Thin Edge JSON:</p>
<pre><code class="language-json">{
  &quot;temperature&quot;: 23
}
</code></pre>
<p>Translated into JSON via MQTT by the Cumulocity mapper:</p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;ThinEdgeMeasurement&quot;,
  &quot;time&quot;: &quot;2021-04-22T17:05:26.958340390+00:00&quot;,
  &quot;temperature&quot;: {
    &quot;temperature&quot;: {
      &quot;value&quot;: 23
    }
  }
}
</code></pre>
<p>You can see the Cumulocity mapper added the three things which are not defined before translation.</p>
<ol>
<li><code>type</code> is added.</li>
<li><code>time</code> is added.</li>
<li>Another hierarchy level is added, as required by the cumulocity data model.
String <code>temperature</code> is used as fragment and series.</li>
</ol>
<p>(1) The <code>type</code> is a mandatory field in the Cumulocity's JSON via MQTT manner,
therefore, the Cumulocity mapper always adds <code>ThinEdgeMeasurement</code> as a type.
This value is not configurable by users.</p>
<p>(2) <code>time</code> will be added by the mapper <strong>only when it is not specified in a received Thin Edge JSON message</strong>.
In this case, the mapper uses the device's local timezone. If you want another timezone, specify the time filed in Thin Edge JSON.</p>
<p>(3) The mapper uses a measurement name (&quot;temperature&quot; in this example)
as both a fragment type and a fragment series in <a href="https://cumulocity.com/guides/reference/measurements/#examples">Cumulocity's measurements</a>.</p>
<p>After the mapper publishes a message on the topic <code>c8y/measurement/measurements/create</code>,
the message will be transferred to the topic <code>measurement/measurements/create</code> by <a href="architecture/../references/bridged-topics.html">the MQTT bridge</a>.</p>
<h3 id="for-child-devices"><a class="header" href="#for-child-devices">For child devices</a></h3>
<p>The Cumulocity mapper collects measurements not only from the main device but also from child devices.
These measurements are collected under the <code>tedge/measurements/&lt;child-id&gt;</code> topics and forwarded to Cumulocity to corresponding child devices created under the <code>thin-edge.io</code> parent device.
(<code>&lt;child-id&gt;</code> is your desired child device ID.)</p>
<p>The mapper works in the following steps.</p>
<ol>
<li>When the mapper receives a Thin Edge JSON message on the <code>tedge/measurements/&lt;child-id&gt;</code> topic,
the mapper sends a request to create a child device under the <code>thin-edge.io</code> parent device.
The child device is named after the <code>&lt;child-id&gt;</code> topic name, and the type is <code>thin-edge.io-child</code>.</li>
<li>Publish corresponded Cumulocity JSON measurements messages over MQTT.</li>
<li>The child device is created on receipt of the very first measurement for that child device.</li>
</ol>
<p>If the incoming Thin Edge JSON message (published on <code>tedge/measurements/child1</code>) is as follows,</p>
<pre><code class="language-json">{
  &quot;temperature&quot;: 23
}
</code></pre>
<p>it gets translated into JSON via MQTT by the Cumulocity mapper.</p>
<pre><code class="language-json">{
  &quot;type&quot;:&quot;ThinEdgeMeasurement&quot;,
  &quot;externalSource&quot;:{
    &quot;externalId&quot;:&quot;child1&quot;,
    &quot;type&quot;:&quot;c8y_Serial&quot;
  },
  &quot;time&quot;:&quot;2013-06-22T17:03:14+02:00&quot;,
  &quot;temperature&quot;:{
    &quot;temperature&quot;:{
      &quot;value&quot;:23
    }
  }
}
</code></pre>
<h2 id="azure-iot-hub-mapper"><a class="header" href="#azure-iot-hub-mapper">Azure IoT Hub mapper</a></h2>
<blockquote>
<p>Note: Child device measurements are not supported yet on Azure IoT Hub.</p>
</blockquote>
<p>The Azure IoT Hub mapper takes messages formatted in the <a href="architecture/thin-edge-json.html">Thin Edge JSON</a> as input.
It validates if the incoming message is correctly formatted Thin Edge JSON, then outputs the message.
The validated messages are published on the topic <code>az/messages/events/</code> from where they are forwarded to Azure IoT Hub.
This mapper is launched by the <code>tedge connect az</code> command, and stopped by the <code>tedge disconnect az</code> command.</p>
<p>The Azure IoT Hub Mapper processes a message in the following ways.</p>
<ol>
<li>Validates if it is a correct Thin Edge JSON message or not.</li>
<li>Validates the incoming message size is below 255 KB.
<a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-d2c-guidance">The size of all device-to-cloud messages must be up to 256 KB</a>.
The mapper keeps 1 KB as a buffer for the strings added by Azure.</li>
<li>(default) Adds a current timestamp if a timestamp is not included in an incoming message. To stop this behavior, please refer to the following instruction.</li>
</ol>
<p>So, if the input is below,</p>
<pre><code class="language-json">{
  &quot;temperature&quot;: 23
}
</code></pre>
<p>the output of the mapper is</p>
<pre><code class="language-json">{
  &quot;temperature&quot;: 23,
  &quot;time&quot;: &quot;2021-06-01T17:24:48.709803664+02:00&quot;
}
</code></pre>
<h3 id="configure-whether-adding-a-timestamp-or-not"><a class="header" href="#configure-whether-adding-a-timestamp-or-not">Configure whether adding a timestamp or not</a></h3>
<p>However, if you don't want to add a timestamp in the output of Azure IoT Hub Mapper, you can change the behavior by running this:</p>
<pre><code class="language-shell">sudo tedge config set az.mapper.timestamp false 
</code></pre>
<p>After changing the configuration, you need to restart the mapper service by</p>
<pre><code class="language-shell">sudo systemctl restart tedge-mapper-az.service
</code></pre>
<h2 id="error-cases"><a class="header" href="#error-cases">Error cases</a></h2>
<p>When some error occurs in a mapper process, the mapper publishes a corresponded error message
on the topic <code>tedge/errors</code> with the QoS level 1 (at least once).</p>
<p>Here is an example if you publish invalid Thin Edge JSON messages on <code>tedge/measurements</code>:</p>
<pre><code class="language-shell">$ tedge mqtt pub tedge/measurements '{&quot;temperature&quot;: 23,&quot;pressure&quot;: 220'
$ tedge mqtt pub tedge/measurements '{&quot;temperature&quot;: 23,&quot;time&quot;: 220}'
</code></pre>
<p>Then, you'll receive error messages from the mapper on the topic <code>tedge/errors</code>:</p>
<pre><code class="language-shell">$ tedge mqtt sub tedge/errors
[tedge/errors] Invalid JSON: Unexpected end of JSON: {&quot;temperature&quot;:23,&quot;pressure&quot;:220
[tedge/errors] Not a timestamp: the time value must be an ISO8601 timestamp string in the YYYY-MM-DDThh:mm:ss.sss.±hh:mm format, not a number.
</code></pre>
<h2 id="topics-used-by-tedge-mapper"><a class="header" href="#topics-used-by-tedge-mapper">Topics used by tedge-mapper</a></h2>
<ul>
<li>
<p>Incoming topics</p>
<ul>
<li><code>tedge/measurements</code></li>
<li><code>tedge/measurements/&lt;child-id&gt;</code> (for Cumulocity)</li>
</ul>
</li>
<li>
<p>Outgoing topics</p>
<ul>
<li><code>tedge/errors</code> (for errors)</li>
<li><code>c8y/measurement/measurements/create</code> (for Cumulocity)</li>
<li><code>az/messages/events/</code> (for Azure IoT Hub)</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="software-management-with-thin-edgeio"><a class="header" href="#software-management-with-thin-edgeio">Software Management with thin-edge.io</a></h1>
<p>With thin-edge.io you can ease the burden of managing packages on your device.
Software Management operates end to end from a cloud down to the OS of your device and reports statuses accordingly.</p>
<h2 id="software-management-components"><a class="header" href="#software-management-components">Software management components</a></h2>
<p>Software Management uses the following 3 components to perform software operations:
<strong>Cloud Mapper</strong>, <strong>Agent</strong>, and <strong>Software Management Plugin</strong>.</p>
<p>You can find the diagrams which explain how those 3 components interact with each other from <a href="https://thin-edge.github.io/thin-edge.io-specs/software-management/sm-agent.html">Software Management Agent Specification</a>.</p>
<h3 id="cloud-mapper"><a class="header" href="#cloud-mapper">Cloud Mapper</a></h3>
<p>The <strong>Cloud Mapper</strong> converts from/to cloud-specific format to/from cloud-agnostic format.
It communicates with the dedicated IoT cloud platform and the <strong>Tedge Agent</strong>.</p>
<h3 id="tedge-agent"><a class="header" href="#tedge-agent">Tedge Agent</a></h3>
<p>The <strong>Tedge Agent</strong> addresses cloud-agnostic software management operations e.g. listing current installed software list, software update, software removal.
Also, the Tedge Agent calls an <strong>SM Plugin(s)</strong> to execute an action defined by a received operation.</p>
<p>The key points are that the <strong>Tedge Agent</strong> is always generic in cloud platforms and software types, and <strong>Cloud Mapper</strong> handles cloud-specific actions.</p>
<h3 id="software-management-plugin"><a class="header" href="#software-management-plugin">Software Management Plugin</a></h3>
<p>The <strong>Software Management Plugin</strong> is dedicated to defining the behaviour of software actions (list, update, remove) per software type (apt, docker, etc.)</p>
<h2 id="related-documents"><a class="header" href="#related-documents">Related documents</a></h2>
<ol>
<li><a href="architecture/../howto-guides/012_install_and_enable_software_management.html">How to install and enable software management?</a></li>
<li><a href="architecture/../tutorials/software-management.html">Manage my device software</a></li>
<li><a href="architecture/../tutorials/write-my-software-management-plugin.html">Write my software management plugin</a></li>
<li><a href="architecture/../references/plugin-api.html">The Software Management Plugin API</a></li>
<li><a href="https://github.com/thin-edge/thin-edge.io-specs/tree/main/src/software-management">Software Management Specification</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture-faq"><a class="header" href="#architecture-faq">Architecture FAQ</a></h1>
<h2 id="design-principles"><a class="header" href="#design-principles">Design principles</a></h2>
<p>The primary goal of thin-edge.io is to simplify the connection of edge devices to the cloud
by providing a secure and reliable cloud connectivity as well as a device management agent.
The primary goal of thin-edge.io is the ability to build IoT applications
around a large diversity of components provided by independent actors.</p>
<p>For that purpose, thin-edge.io focuses on:</p>
<ul>
<li><strong>Interoperability</strong> -
Thin-edge.io lets the users integrate components producing or consuming telemetry data,
northbound with cloud platforms, southbound with sensors
as well as for east-west communication between analytics components.</li>
<li><strong>Flexibility</strong> -
Thin-edge.io lets users integrate component provided by different IoT actors,
not even originally designed with thin-edge.io in-mind,
using various technologies and programming languages.</li>
<li><strong>Security</strong> -
Thin-edge.io provides a secure and stable foundation for cloud connections, software/firmware updates,
and remote device management.</li>
<li><strong>Reliability</strong> -
Thin-edge.io components can survive in chaotic environments as network outages and process restarts happen.</li>
<li><strong>Efficiency</strong> -
Thin-edge.io lets users build applications that can run on constrained device hardware and with limited bandwidth networks.</li>
<li><strong>Multi-cloud</strong> -
Thin-edge.io enables users to connect their edge devices with multiple clouds.
The actual cloud used can be decided at run-time by the end-user.</li>
</ul>
<h2 id="why-is-thin-edgeio-an-executable-binary-and-not-a-library"><a class="header" href="#why-is-thin-edgeio-an-executable-binary-and-not-a-library">Why is thin-edge.io an executable binary and not a library?</a></h2>
<p>Interoperability of software components can be addressed along very different approaches.
Thin-edge.io uses dynamic and loose inter-process communication (IPC) using messages exchange over an MQTT bus.</p>
<p>In the past and even today, many clouds provide a library (SDK) to help you connect your code to the cloud.</p>
<p>In thin-edge.io we decided not to follow this approach because:</p>
<ul>
<li>Libraries are <strong>programming language dependent</strong>,
and thus developing a library for a number of  programming languages always excludes developers using other
programming languages. Additionally the effort to support many libraries (C, C++, Rust, Python, etc) is huge,
including adding new features, testing, documentation, examples, stackoverflow.
Essentially we would create multiple small user groups instead of one large user group.</li>
<li>Using an IPC mechanism (and not a library) makes it easier to <strong>dynamically plug</strong> together components during runtime
(instead of recompiling the software). For example, it is easier to add additional protocol stacks
(OPC/UA, modbus, ProfiNet, IO-Link, KNX, ...) to thin-edge.io during run-time. </li>
<li>Linking libraries to existing code can be problematic for some developers, for example for licensing reasons.
While thin-edge.io has a very user-friendly licensing (Apache 2.0),
some developers prefer to reduce the number of libraries that they link to their software.</li>
</ul>
<h2 id="why-does-thin-edgeio-use-mqtt-for-ipc"><a class="header" href="#why-does-thin-edgeio-use-mqtt-for-ipc">Why does thin-edge.io use MQTT for IPC?</a></h2>
<p><a href="https://mqtt.org/">MQTT</a> is a lightweight and flexible messaging protocol widely used by IoT applications.</p>
<p>We were looking for a widely-used, performant IPC mechanism and we investigated a number of alternatives.
In the end, we decided to use MQTT for the following reasons:</p>
<ul>
<li>The approach is used by other industrial IoT organisations and software,
for example by <a href="https://openindustry4.com/">Open Industry 4.0 Alliance</a>.</li>
<li>Existing components (like <a href="https://nodered.org/">Node-RED</a> or <a href="https://collectd.org/">collectd</a> )
that support MQTT can be easily integrated. In this case, thin-edge.io acts as an MQTT proxy:
existing components connect to the local MQTT bus of thin-edge.io,
and thin-edge.io routes the messages to different clouds in a secure and reliable manner.</li>
<li>MQTT is message oriented and bi-directional, which matches well with the event oriented programming model of industrial IoT.</li>
<li>MQTT is available on many platforms, including Linux and Windows.</li>
<li>MQTT client libraries are available for 25+ programming languages (see <a href="https://mqtt.org/software/">MQTT.org</a>]) </li>
<li>MQTT overhead is relatively small in terms of client libary size and network overhead.</li>
<li>MQTT is message payload agnostic which enables sending not only JSON messages, but also text, CSV or binary data.</li>
</ul>
<p>Alternatives considered where: DBus, gRPC and REST over HTTP. </p>
<h2 id="why-does-thin-edgeio-use-mqtt-for-cloud-communication"><a class="header" href="#why-does-thin-edgeio-use-mqtt-for-cloud-communication">Why does thin-edge.io use MQTT for cloud communication?</a></h2>
<p><a href="https://mqtt.org/">MQTT</a> is a lightweight and flexible messaging protocol widely used by IoT applications.
Nearly all the IoT cloud platforms provide an MQTT endpoint to consume and publish messages from a fleet of devices.
Therefore, MQTT was an obvious choice for edge to cloud communication.</p>
<p>Using MQTT for cloud communication is not mandatory. You are free to add additional protocols beside MQTT:
Because thin-edge.io has an internal bus, you can implement a bridge to another protocol (e.g. LWM2M or plain HTTPS).
In that case, MQTT is used inside the edge devices, and another protocol is used for external communication.</p>
<h2 id="why-is-the-thin-edgeio-canonical-format-based-on-json"><a class="header" href="#why-is-the-thin-edgeio-canonical-format-based-on-json">Why is the thin-edge.io canonical format based on JSON?</a></h2>
<p><a href="architecture/./thin-edge-json.html">Thin-Edge-Json</a>, the cloud-agnostic message format of thin-edge.io, is based on JSON.</p>
<p>Supported by nearly all programming languages, JSON provides a nice compromise between simplicity and flexibility.
Notably, it features <a href="https://en.wikipedia.org/wiki/Duck_typing">duck typing</a>,
a flexible way to group different data fields that can be read
by consumers with different expectations over the message content.
For instance, a consumer expecting a temperature can process messages
where the temperature measurements are produced along with other kinds of measurements.</p>
<p>Additionally, JSON is supported by most (if not all) cloud vendors, which makes the transformation easier.</p>
<p>JSON is also used by other (Industrial) IoT standards, including OPC/UA and LWM2M.</p>
<h2 id="why-use-rust"><a class="header" href="#why-use-rust">Why use Rust?</a></h2>
<p>The command line interface, and the daemon processes of thin-edge.io are implemented in <a href="https://www.rust-lang.org/">Rust</a>,
<em>a language empowering everyone to build reliable and efficient software</em>.</p>
<p>The main motivation to use Rust is security: Rust avoids many security vulnerabilities and threading issues at compile time.
With the type system of Rust you write software that is free from typical security flaws:
undefined behavior, data races or any memory safety issues.</p>
<p>The second motivation is efficiency. Rust software is typically as efficient as C/C++ software. 
One reason is that Rust does not have (by default) a garbage collector. Instead, memory lifetime is calculated at compile time.</p>
<p>Note that, even if the core of thin-edge.io is written in Rust,
any programming language can be used to implement thin-edge.io components.
For that, one just needs an MQTT library that lets them interact with the thin-edge.io MQTT broker.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="thin-edgeio-platform-support"><a class="header" href="#thin-edgeio-platform-support">thin-edge.io platform support</a></h1>
<p>Common requirements for all systems are:</p>
<ul>
<li>minimum 16MB of RAM</li>
<li>systemd (for production systems)</li>
<li>mosquitto minimum version 1.6 (for security reasons we recommend the latest 1.x version)</li>
<li>dpkg (if you want to use our prebuilt deb packages)</li>
</ul>
<h1 id="level-1"><a class="header" href="#level-1">Level 1</a></h1>
<p>Level 1 supported platforms are officially supported and are actively tested in the CI/CD.</p>
<ul>
<li>ARMv7 Raspberry Pi OS 10</li>
<li>ARMv8 Raspberry Pi OS 10</li>
<li>AMD64 Ubuntu 20.04</li>
</ul>
<h1 id="level-2"><a class="header" href="#level-2">Level 2</a></h1>
<p>Level 2 platforms are not officially supported and tested yet, but we know from our experiences that these systems used to work for some maintainers or users. If your os is not listed here, this does not mean it is not working, just give it a try. We are happy to hear about your experience in the Github discussions.</p>
<ul>
<li>Ubuntu 20.04 in WSL (only for development, not for running thin-edge.io due to missing systemd)</li>
<li>AMD64 Debian 10</li>
<li>ARMv6 Raspberry Pi OS 10 (needs to be built for this specific target, please refer to <a href="https://github.com/thin-edge/thin-edge.io/issues/161">Issue-161</a>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="init-system-configuration-file"><a class="header" href="#init-system-configuration-file">Init System Configuration File</a></h1>
<p>To support multiple init systems and service managers, <code>tedge</code> requires the <code>/etc/tedge/system.toml</code> file.
The file contains configurations about the init system and the supported actions.</p>
<p>The format of the file is:</p>
<pre><code class="language-toml">[init]
name = &quot;systemd&quot;
is_available = [&quot;/bin/systemctl&quot;, &quot;--version&quot;]
restart = [&quot;/bin/systemctl&quot;, &quot;restart&quot;, &quot;{}&quot;]
stop =  [&quot;/bin/systemctl&quot;, &quot;stop&quot;, &quot;{}&quot;]
enable =  [&quot;/bin/systemctl&quot;, &quot;enable&quot;, &quot;{}&quot;]
disable =  [&quot;/bin/systemctl&quot;, &quot;disable&quot;, &quot;{}&quot;]
is_active = [&quot;/bin/systemctl&quot;, &quot;is-active&quot;, &quot;{}&quot;]
</code></pre>
<h2 id="placeholder"><a class="header" href="#placeholder">Placeholder</a></h2>
<p><code>{}</code> will be replaced by a service name (<code>mosquitto</code>, <code>tedge-mapper-c8y</code>, <code>tedge-mapper-az</code>, etc.).
For example,</p>
<pre><code class="language-toml">restart = [&quot;/bin/systemctl&quot;, &quot;restart&quot;, &quot;{}&quot;]
</code></pre>
<p>will be interpreted as</p>
<pre><code class="language-shell">/bin/systemctl restart mosquitto
</code></pre>
<h2 id="keys"><a class="header" href="#keys">Keys</a></h2>
<ul>
<li><strong>name</strong>: An identifier of the init system. 
It is used in the output of <code>tedge connect</code> and <code>tedge disconnect</code>.</li>
<li><strong>is_available</strong>: The command to check if the init is available on your system.</li>
<li><strong>restart</strong>: The command to restart a service by the init system.</li>
<li><strong>stop</strong>: The command to stop a service by the init system.</li>
<li><strong>enable</strong>: The command to enable a service by the init system.</li>
<li><strong>disable</strong>: The command to disable a service by the init system.</li>
<li><strong>is_active</strong>: The command to check if the service is running by the init system.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="write-my-software-management-plugin-1"><a class="header" href="#write-my-software-management-plugin-1">Write my software management plugin</a></h1>
<p><strong>thin-edge.io</strong> Software Management natively supports APT (Debian) packages.
However, there are many package management systems in the world,
and you may want to have a plugin that is suitable for your device.
For such a demand, we provide the <a href="tutorials/./../references/plugin-api.html"><strong>Package Manager Plugin API</strong></a>
to write a custom Software Management plugin in your preferred programming language.</p>
<p>In this tutorial, we will look into the <strong>Package Manager Plugin API</strong>,
and learn how to write your own plugin with a docker plugin shell script example.</p>
<h2 id="create-a-plugin-1"><a class="header" href="#create-a-plugin-1">Create a plugin</a></h2>
<p>Create a <em>docker</em> file in the directory <em>/etc/tedge/sm-plugins/</em>. 
A plugin must be an executable file located in that directory.</p>
<p>Filename: /etc/tedge/sm-plugins/docker</p>
<pre><code class="language-shell">#!/bin/sh

COMMAND=&quot;$1&quot;
IMAGE_NAME=&quot;$2&quot;

case &quot;$COMMAND&quot; in
    list)
        docker image list --format '{{.Repository}}\t{{.Tag}}' || exit 2
        ;;
    install)
        docker pull $IMAGE_NAME || exit 2
        ;;
    remove)
        docker rmi $IMAGE_NAME || exit 2
        ;;
    prepare)
        ;;
    finalize)
        ;;
    update-list)
        exit 1
        ;;
esac
exit 0
</code></pre>
<blockquote>
<p><strong>Info</strong>: the filename will be used as a plugin type to report the software list to a cloud.
If you name it <code>docker.sh</code>, you will see <code>docker.sh</code> as a plugin type in cloud.</p>
</blockquote>
<p>If you execute <code>./docker list</code>, you will see this kind of output.</p>
<pre><code class="language-csv">alpine  3.14
eclipse-mosquitto   2.0-openssl
...
</code></pre>
<p>The Software Management Agent runs executable plugins with a special argument, like <code>list</code>.
Let's call the pre-defined argument such as <code>list</code>, <code>install</code>, and <code>remove</code> a <strong>command</strong> here. 
As you can see from this example, a plugin should be an executable file 
that accepts the commands and outputs to stdout and stderr.
Hence, you can implement a plugin in your preferred language.</p>
<p>Here is the table of the commands that you can use in a plugin.</p>
<table><thead><tr><th>Command</th><th>Input arguments</th><th>Expected output</th><th>Description</th></tr></thead><tbody>
<tr><td>list</td><td>-</td><td>lines with tab separated values</td><td>Returns the list of software modules that have been installed with this plugin.</td></tr>
<tr><td>prepare</td><td>-</td><td>-</td><td>Executes the provided actions before a sequence of install and remove commands.</td></tr>
<tr><td>finalize</td><td>-</td><td>-</td><td>Executes the provided actions after a sequence of install and remove commands.</td></tr>
<tr><td>install</td><td>NAME [--version VERSION] [--file FILE]</td><td>-</td><td>Executes the action of installation.</td></tr>
<tr><td>remove</td><td>NAME [--version VERSION]</td><td>-</td><td>Executes the action of uninstallation.</td></tr>
<tr><td>update-list</td><td>COMMAND NAME [--version VERSION] [--file FILE]</td><td>-</td><td>Executes the list of <code>install</code> and <code>remove</code> commands.</td></tr>
</tbody></table>
<p>The order of the commands invoked by the Software Management Agent is:
<code>prepare</code> -&gt; <code>update-list</code> or [<code>install</code>, <code>remove</code>] -&gt;<code>finalize</code></p>
<blockquote>
<p><strong>info</strong>: There is no guarantee of the order between <code>install</code> and <code>remove</code>.
If you need a specific order, use <code>update-list</code> command instead.</p>
</blockquote>
<p>In the following sections, we will dive into each command and other rules deeply.</p>
<h2 id="input-output-and-errors-1"><a class="header" href="#input-output-and-errors-1">Input, Output, and Errors</a></h2>
<p>Before we dive into each command, we should clarify the basic rules of plugins.</p>
<h3 id="input-1"><a class="header" href="#input-1">Input</a></h3>
<p>The command themselves and further required arguments must be given as command-line arguments.
The only exception is <code>update-list</code>, which requires <strong>stdin</strong> input.</p>
<h3 id="output-1"><a class="header" href="#output-1">Output</a></h3>
<p>The <strong>stdout</strong> and <strong>stderr</strong> of the process running a plugin command are captured by the Software Management Agent.</p>
<h3 id="exit-status-1"><a class="header" href="#exit-status-1">Exit status</a></h3>
<p>The exit status of plugins are interpreted by sm-agent as follows:</p>
<ul>
<li><strong>0</strong>: success.</li>
<li><strong>1</strong>: usage. The command arguments cannot be interpreted, and the command has not been launched.</li>
<li><strong>2</strong>: failure. The command failed and there is no point to retry.</li>
<li><strong>3</strong>: retry. The command failed but might be successful later (for instance, when the network will be back).</li>
</ul>
<h2 id="list-1"><a class="header" href="#list-1">List</a></h2>
<p>The <code>list</code> command is responsible to return the list of the installed software modules.</p>
<p>Rules:</p>
<ul>
<li>This command takes no arguments.</li>
<li>The list is returned using <a href="https://en.wikipedia.org/wiki/Tab-separated_values">CSV with tabulations as separators</a>,
including:
<ul>
<li><strong>name</strong>: the name of the software module, e.g. <code>mosquitto</code>.
This name is the name that has been used to install it and that needs to be used to remove it.</li>
<li><strong>version</strong>: the version currently installed.
This is a string that can only be interpreted in the context of the plugin.
&gt;Note: If the version is not present for a module, then list can return only the module name without trailing tabulation.
Given that your plugin is named <code>docker</code>, then the Software Management Agent calls</li>
</ul>
</li>
</ul>
<pre><code class="language-shell">sudo /etc/tedge/sm-plugins/docker list
</code></pre>
<p>to report the list of software modules installed.</p>
<blockquote>
<p><strong>Important</strong>: the Software Management Agent executes a plugin using <code>sudo</code> and as <code>tedge-agent</code> user.</p>
</blockquote>
<p><code>docker</code> should output in the CSV with tabulations as separators like</p>
<pre><code class="language-csv">alpine  3.14
eclipse-mosquitto   2.0-openssl
rust    1.51-alpine
</code></pre>
<p>with exit code <code>0</code> (successful).</p>
<p>In most cases, the output of the <code>list</code> command is multi-lines.
The line separator should be <code>\n</code>.</p>
<p>A plugin must return a CSV line per software module, using a tabulation <code>\t</code> as separator.
If there is no version field then only the module name will be returned.
In the <em>docker</em> file example, the following command outputs CSV structures with tabulations as separator.</p>
<pre><code class="language-shell">docker image list --format '{{.Repository}}\t{{.Tag}}'
</code></pre>
<h2 id="prepare-1"><a class="header" href="#prepare-1">Prepare</a></h2>
<p>The <code>prepare</code> command is invoked by the sm-agent before a sequence of install and remove commands.</p>
<p>Rules:</p>
<ul>
<li>It takes no argument and no output is expected.</li>
<li>If the <code>prepare</code> command fails,
then the whole Software Management operation is cancelled.</li>
</ul>
<p>For many plugins, this command has nothing specific to do, and can simply return with a <code>0</code> exit status.</p>
<p>In some plugin types, this <code>prepare</code> command can help you.
For example, assume that you want to implement a plugin for APT,
and want to run <code>apt-get update</code> always before calling the <code>install</code> command. 
In this example, the <code>prepare</code> command is the right place to invoke <code>apt-get update</code>.</p>
<h2 id="finalize-1"><a class="header" href="#finalize-1">Finalize</a></h2>
<p>The <code>finalize</code> command closes a sequence of install and removes commands started by a prepare command.</p>
<p>Rules:</p>
<ul>
<li>It takes no argument and no output is expected.</li>
<li>If the <code>finalize</code> command fails, then the whole Software Management operation is reported as failed,
even if all the atomic actions have been successfully completed.</li>
</ul>
<p>Similar to the <code>prepare</code> plugin, you must define the command even if you want nothing in the <code>finalize</code> command.</p>
<p>The command can be used in several situations. For example, </p>
<ul>
<li>remove any unnecessary software module after a sequence of actions.</li>
<li>commit or roll back the sequence of actions.</li>
<li>restart any processes using the modules,
e.g. restart the analytics engines if the modules have changed.</li>
</ul>
<h2 id="install-1"><a class="header" href="#install-1">Install</a></h2>
<p>The <code>install</code> command installs a software module, possibly of some expected version.
A plugin must be executable in the below format.</p>
<pre><code class="language-shell">$ myplugin install NAME [--module-version VERSION] [--file FILE]
</code></pre>
<p>This command takes 1 mandatory argument and has 2 optional flags.</p>
<ul>
<li><strong>NAME</strong>: the name of the software module to be installed, e.g. <code>mosquitto</code>. (Mandatory)</li>
<li><strong>VERSION</strong>: the version to be installed. e.g. <code>1.5.7-1+deb10u1</code>.
The version can be blank, so it's recommended to define the behaviour if a version is not provided. 
For example, always installs the &quot;latest&quot; version if a version is not provided. (Optional)</li>
<li><strong>FILE</strong>: the path to the software to be installed. (Optional)</li>
</ul>
<p>The installation phase may fail due to the following reasons.
An error must be reported if:</p>
<ul>
<li>The module name is unknown.</li>
<li>There is no version for the module that matches the constraint provided by the <code>--module-version</code> option.</li>
<li>The file content provided by <code>--file</code> option:
<ul>
<li>is not in the expected format,</li>
<li>doesn't correspond to the software module name,</li>
<li>has a version that doesn't match the constraint provided by the <code>--module-version</code> option (if any).</li>
</ul>
</li>
<li>The module cannot be downloaded.</li>
<li>The module cannot be installed.</li>
</ul>
<p>At the API level, there is no command to distinguish install or upgrade.</p>
<p>Back to the first <em>docker</em> example, it doesn't address the case with version. 
Let's expand the example file as below.</p>
<p>Filename: /etc/tedge/sm-plugins/docker</p>
<pre><code class="language-shell">#!/bin/sh

COMMAND=&quot;$1&quot;
IMAGE_NAME=&quot;$2&quot;
VERSION_FLAG=&quot;$3&quot;
IMAGE_TAG=&quot;$4&quot;

case &quot;$COMMAND&quot; in
    list)
        docker image list --format '{{.Repository}}\t{{.Tag}}' || exit 2
        ;;
    install)
        if [ $# -eq 2 ]; then
            docker pull $IMAGE_NAME || exit 2
        elif [ $# -eq 4 ] &amp;&amp; [ $VERSION_FLAG = &quot;--module-version&quot; ]; then
            docker pull $IMAGE_NAME:$IMAGE_TAG || exit 2
        else
            echo &quot;Invalid arguments&quot;
            exit 1
        fi
        ;;
    remove)
        if [ $# -eq 2 ]; then
            docker rmi $IMAGE_NAME || exit 2
        elif [ $# -eq 4 ] &amp;&amp; [ $VERSION_FLAG = &quot;--module-version&quot; ]; then
            docker rmi $IMAGE_NAME:$IMAGE_TAG || exit 2
        else
            echo &quot;Invalid arguments&quot;
            exit 1
        fi
        ;;
    prepare)
        ;;
    finalize)
        ;;
    update-list)
        exit 1
        ;;
esac
exit 0
</code></pre>
<p>Pay attention to the exit statuses.
In case of invalid arguments, the plugin returns <code>1</code>.
If a command is executed but fails, the plugin returns <code>2</code>.
Each exit status is defined <a href="tutorials/write-my-software-management-plugin.html#exit-status">here</a>.</p>
<p>If the given NAME is <code>mosquitto</code>, and the given VERSION is <code>1.5.7-1+deb10u1</code>,
the Software Management Agent calls</p>
<pre><code class="language-shell">sudo /etc/tedge/sm-plugins/docker install mosquitto --module-version 1.5.7-1+deb10u1
</code></pre>
<p>Then, the plugin executes</p>
<pre><code class="language-shell">docker pull mosquitto:1.5.7-1+deb10u1
</code></pre>
<h2 id="remove-1"><a class="header" href="#remove-1">Remove</a></h2>
<p>The <code>remove</code> command uninstalls a software module,
and possibly its dependencies if no other modules are dependent on those.
A plugin must be executable in the below format.</p>
<pre><code class="language-shell">$ myplugin remove NAME [--module-version VERSION]
</code></pre>
<p>This command takes 1 mandatory argument and 1 optional argument with a flag.</p>
<ul>
<li><strong>NAME</strong>: the name of the software module to be removed, e.g. <code>mosquitto</code>. (Mandatory)</li>
<li><strong>VERSION</strong>: the version to be installed. e.g. <code>1.5.7-1+deb10u1</code>.
The version can be blank, so it's recommended to define the behaviour if a version is not provided.
For example, uninstall a software module regardless of its version if a version is not provided. (Optional)</li>
</ul>
<p>The uninstallation phase can be failed due to several reasons. An error must be reported if:</p>
<ul>
<li>The module name is unknown.</li>
<li>The module cannot be uninstalled.</li>
</ul>
<p>Back to the first <em>docker</em> plugin example,
if the NAME is <code>mosquitto</code>, and the VERSION is <code>1.5.7-1+deb10u1</code>,
the Software Management Agent calls</p>
<pre><code class="language-shell">sudo /etc/tedge/sm-plugins/docker remove mosquitto --module-version 1.5.7-1+deb10u1
</code></pre>
<p>Then, the plugin executes</p>
<pre><code class="language-shell">docker rmi mosquitto:1.5.7-1+deb10u1
</code></pre>
<h2 id="update-list-1"><a class="header" href="#update-list-1">Update-list</a></h2>
<p>The <code>update-list</code> command accepts a list of software modules and associated operations as <code>install</code> or <code>remove</code>.
This basically achieves the same purpose as original commands install and remove,
but gets passed all software modules to be processed in one command.
This can be needed when an order of processing software modules is relevant.</p>
<p>In other words, you can choose a combination of the <code>install</code> or <code>remove</code> commands or this <code>update-list</code> command up to your requirement.
If you don't want to use <code>update-list</code>, the plugin must return <code>1</code> like the first <em>docker</em> plugin example.</p>
<pre><code class="language-shell">case &quot;$COMMAND&quot; in
    ...
    update-list)
        exit 1
        ;;
esac
</code></pre>
<p>Let's expand the first <em>docker</em> plugin example to use <code>update-list</code>.
First, learn what is the input of <code>update-list</code>.</p>
<p>The Software Management Agent calls a plugin as below. Note that each argument is tab separated:</p>
<pre><code class="language-shell">$ sudo /etc/tedge/sm-plugins/docker update-list &lt;&lt;EOF
  install	name1	version1
  install	name2		path2
  remove	name3	version3
  remove	name4
EOF
</code></pre>
<p>The point is that it doesn't take any command-line argument, 
but the software action list is sent through <strong>stdin</strong>.</p>
<p>The behaviour of operations <code>install</code> and <code>remove</code> is the same as for original commands <code>install</code> and <code>remove</code>. 
The above input is equivalent to the use of original commands (<code>install</code> and <code>remove</code>):</p>
<pre><code class="language-shell">$ /etc/tedge/sm-plugins/docker install name1 --module-version version1
$ /etc/tedge/sm-plugins/docker install name2 --file path2
$ /etc/tedge/sm-plugins/docker remove &quot;name 3&quot; --module-version version3
$ /etc/tedge/sm-plugins/docker remove name4
</code></pre>
<p>To make the <em>docker</em> plugin accept a list of install and remove actions,
let's change the file as below.
Note that this example works only in bash.</p>
<p>Filename: /etc/tedge/sm-plugins/docker</p>
<pre><code class="language-shell">#!/bin/bash

COMMAND=&quot;$1&quot;

case &quot;$COMMAND&quot; in
    list)
        docker image list --format '{{.Repository}}\t{{.Tag}}' || exit 2
        ;;
    install)
        echo docker pull &quot;$2:$3&quot;
        ;;
    remove)
        echo docker rmi &quot;$2:$3&quot;
        ;;
    prepare)
        ;;
    finalize)
        ;;
    update-list)
        while IFS=$'\t' read -r ACTION MODULE VERSION FILE
        do
            bash -c &quot;$0 $ACTION $MODULE $VERSION&quot;
        done
        ;;
esac
exit 0
</code></pre>
<p>You can find that <code>install</code> and <code>remove</code> are replaced by <code>update-list</code>.
<code>update-list</code> should define the behaviour to read line by line for the case <code>install</code> and <code>remove</code>.</p>
<p>Also, <code>update-list</code> must be <strong>fail-fast</strong>.
That example exists immediately if one of the commands fails.</p>
<h2 id="project-references-1"><a class="header" href="#project-references-1">Project references</a></h2>
<p>You can also refer to:</p>
<ul>
<li>the specification of the <a href="https://github.com/thin-edge/thin-edge.io/blob/main/docs/src/references/plugin-api.md">Package Manager Plugin API</a>.</li>
<li><a href="https://github.com/thin-edge/thin-edge.io/tree/main/plugins/tedge_apt_plugin">the APT plugin</a> written in Rust. </li>
<li><a href="https://github.com/thin-edge/thin-edge.io/blob/main/sm/plugins/tedge_docker_plugin/tedge_docker_plugin.sh">the example Docker plugin</a> written in POSIX standard shell script.
This plugin can install/remove docker containers using docker image tags. This plugin is <strong>not</strong> to be used in production without necessary enhancements. It is to be used only as a reference to write your own plugin.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apis"><a class="header" href="#apis">APIs</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-bridged-topics"><a class="header" href="#the-bridged-topics">The bridged topics</a></h1>
<p>This document lists the MQTT topics that are supported by the thin-edge.io.</p>
<h2 id="thin-edge-json-mqtt-topics"><a class="header" href="#thin-edge-json-mqtt-topics">Thin Edge JSON MQTT Topics</a></h2>
<p>To send the Thin Edge JSON measurements to a supported IoT cloud, the device should publish the measurements on
<strong>tedge/measurements</strong> topic. Internally the tedge-mapper will consume the measurements from this topic, translates and
send them to the cloud that the device has been connected to by the <code>tedge connect</code> command.</p>
<h2 id="cumulocity-mqtt-topics"><a class="header" href="#cumulocity-mqtt-topics">Cumulocity MQTT Topics</a></h2>
<p>The topics follow the below format
<code>&lt;protocol&gt;/&lt;direction&gt;&lt;type&gt;[/&lt;template&gt;][/&lt;child id&gt;] </code></p>
<table><thead><tr><th>Protocol</th><th>Direction</th><th>Type</th></tr></thead><tbody>
<tr><td>s = standard</td><td>u = upstream</td><td>s =  static (built-in)</td></tr>
<tr><td>t = transient</td><td>d = downstream</td><td>c = custom (device-defined)</td></tr>
<tr><td></td><td>e = error</td><td>d = default (defined in connect)</td></tr>
<tr><td></td><td></td><td>t = template</td></tr>
<tr><td></td><td></td><td>cr = credentials</td></tr>
</tbody></table>
<h3 id="smartrest20-topics"><a class="header" href="#smartrest20-topics">SmartREST2.0 topics</a></h3>
<p>All Cumulocity topics have been prefixed by <code>c8y/</code>.</p>
<ul>
<li>
<p>Registration topics
c8y/s/dcr
c8y/s/ucr</p>
</li>
<li>
<p>Creating template topics
c8y/s/dt
c8y/s/ut/#</p>
</li>
<li>
<p>Static templates topics
c8y/s/us
c8y/t/us
c8y/q/us
c8y/c/us
c8y/s/ds</p>
</li>
<li>
<p>Debug topics
c8y/s/e</p>
</li>
<li>
<p>Custom template topics
c8y/s/uc/#
c8y/t/uc/#
c8y/q/uc/#
c8y/c/uc/#
c8y/s/dc/#</p>
</li>
</ul>
<h3 id="c8y-json-topics"><a class="header" href="#c8y-json-topics">C8Y JSON topics</a></h3>
<pre><code>c8y/measurement/measurements/create
c8y/error
</code></pre>
<p>You can find more information about Cumulocity topics <a href="https://tech.forums.softwareag.com/t/cumulocity-iot-tips-and-tricks-mqtt-cheat-sheet/237187">Here</a></p>
<h2 id="azure-mqtt-topics"><a class="header" href="#azure-mqtt-topics">Azure MQTT Topics</a></h2>
<p>MQTT clients on Thin Edge device must use the below topics to communicate with the Azure cloud.
The Azure topics are prefixed by <code>az/</code>.</p>
<ul>
<li>
<p><code>az/messages/events/</code>  - Use this topic to send the messages from device to cloud.
The messages are forwarded to the Azure topic named <code>devices/{device_id}/messages/events/</code>
where device_id is the Thin Edge device id.</p>
</li>
<li>
<p><code>az/messages/devicebound/#</code> - Use this topic to subscribe for the messages that were sent from cloud to device.
Any message published by Azure on one the subtopics of <code>devices/{device_id}/messages/devicebound/#</code>
is republished here.</p>
</li>
</ul>
<h2 id="collectd-topics"><a class="header" href="#collectd-topics">Collectd topics</a></h2>
<p>When the <a href="references/../tutorials/device-monitoring.html">device monitoring feature is enabled</a>,
monitoring metrics are emitted by <code>collectd</code> on a hierarchy of MQTT topics.</p>
<ul>
<li><code>collectd/$HOSTNAME/#</code> - All the metrics collected on the device (which hostname is <code>$HOSTNAME</code>).</li>
<li><code>collectd/$HOSTNAME/$PLUGIN/#</code> - All the metrics collected by a given collectd plugin, named <code>$PLUGIN</code>.</li>
<li><code>collectd/$HOSTNAME/$PLUGIN/$METRIC</code> - The topic for a given metric, named <code>$METRIC</code>.
All the measurements are published as a pair of a Unix timestamp in milli-seconds and a numeric value
in the format <code>$TIMESTAMP:$VALUE</code>. For example, <code>1623155717:98.6</code>.</li>
</ul>
<p>The <code>collectd-mapper</code> daemon process ingests these measurements and emits translated messages
the <code>tedge/measurements</code> topic.</p>
<ul>
<li>This process groups the atomic measurements that have been received during the same time-window (currently 200 ms)</li>
<li>and produces a single thin-edge-json for the whole group of measurements.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="software-management-plugin-api"><a class="header" href="#software-management-plugin-api">Software Management Plugin API</a></h1>
<p>Thin-edge uses plugins to delegate to the appropriate package managers and installers
all the software management operations: installation of packages, uninstallations and queries.</p>
<ul>
<li>A package manager plugin acts as a facade for a specific package manager.</li>
<li>A plugin is an executable that follows the <a href="references/./#plugin-api">plugin API</a>.</li>
<li>On a device, several plugins can be installed to deal with different kinds of software modules.</li>
<li>The filename of a plugin is used by thin-edge to determine the appropriate plugin for a software module.</li>
<li>All the actions on a software module are directed to the plugin bearing the name that matches the module type name.</li>
<li>The plugins are loaded and invoked by the sm-agent in a systematic order (in practice the alphanumerical order of their names in the file system).</li>
<li>The software modules to be installed/removed are also passed to the plugins in a consistent order.</li>
<li>Among all the plugins, one can be marked as the default plugin using <code>tedge config</code> cli.</li>
<li>The default plugin is invoked when an incoming software module in the cloud request doesn't contain any explicit type annotation.</li>
<li>Several plugins can co-exist for a given package manager as long as they are given different names.
Each can implement a specific software management policy.
For instance, for a debian package manager, several plugins can concurrently be installed, say one named <code>apt</code> to handle regular packages from the public apt repository and another named <code>company-apt</code> to install packages from a company's private package repository.</li>
</ul>
<h2 id="plugin-repository"><a class="header" href="#plugin-repository">Plugin repository</a></h2>
<ul>
<li>To be used by thin-edge, a plugin has to stored in the directory <code>/etc/tedge/sm-plugins</code>.</li>
<li>A plugin must be named after the software module type as specified in the cloud request.
That is, a plugin named <code>apt</code> handles software modules that are defined with type <code>apt</code> in the cloud request.
Consequently a plugin to handle software module defined for <code>docker</code> must be named <code>docker</code>.</li>
<li>The same plugin can be given different names, using virtual links.</li>
<li>When there are multiple plugins on a device, one can be marked as the default plugin using the command
<code>tedge config set software.plugin.default &lt;plugin-name&gt;</code></li>
<li>If there's one and only one plugin available on a device, that's treated as the default, even without an explicit configuration.</li>
</ul>
<p>On start-up and sighup, the sm-agent registers the plugins as follow:</p>
<ol>
<li>Iterate over the executable file of the directory <code>/etc/tedge/sm-plugins</code>.</li>
<li>Check the executable is indeed a plugin, calling the <a href="references/./#the_list_command"><code>list</code></a> command.</li>
</ol>
<h2 id="plugin-api"><a class="header" href="#plugin-api">Plugin API</a></h2>
<ul>
<li>A plugin must implement all the commands used by the sm-agent of thin-edge,
and support all the options for these commands.</li>
<li>A plugin should not support extra command or option.</li>
<li>A plugin might have a configuration file.
<ul>
<li>It can be a list of remote repositories, or a list of software modules to be excluded.</li>
<li>These configuration files can be managed from the cloud via the sm-agent (TODO: how).</li>
</ul>
</li>
</ul>
<h3 id="input-output-and-errors-2"><a class="header" href="#input-output-and-errors-2">Input, Output and Errors</a></h3>
<ul>
<li>The plugins are called by the sm-agent using a child process for each action.</li>
<li>Beside command <code>update-list</code> there is no input beyond the command arguments, and a plugin that does not
implement <code>update-list</code> can close its <code>stdin</code>.</li>
<li>The <code>stdout</code> and <code>stderr</code> of the process running a plugin command are captured by the sm-agent.
<ul>
<li>These streams don't have to be the streams returned by the underlying package manager.
It can be a one sentence summary of the error, redirecting the administrator to the package manager logs.</li>
</ul>
</li>
<li>A plugin must return the appropriate exit status after each command.
<ul>
<li>In no cases, the error status of the underlying package manager should be reported.</li>
</ul>
</li>
<li>The exit status are interpreted by sm-agent as follows:
<ul>
<li><strong><code>0</code></strong>: success.</li>
<li><strong><code>1</code></strong>: usage. The command arguments cannot be interpreted, and the command has not been launched.</li>
<li><strong><code>2</code></strong>: failure. The command failed and there is no point to retry.</li>
<li><strong><code>3</code></strong>: retry. The command failed but might be successful later (for instance, when the network will be back).</li>
</ul>
</li>
<li>If the command fails to return within 5 minutes, the sm-agent reports a timeout error:
<ul>
<li><strong><code>4</code></strong>: timeout.</li>
</ul>
</li>
</ul>
<h3 id="the-list-command"><a class="header" href="#the-list-command">The <code>list</code> command</a></h3>
<p>When called with the <code>list</code> command, a plugin returns the list of software modules that have been installed with this plugin,
using tab separated values.</p>
<pre><code class="language-shell">$ debian-plugin list
...
collectd-core  5.8.1-1.3
mosquitto   1.5.7-1+deb10u1
...
</code></pre>
<p>Contract:</p>
<ul>
<li>This command take no arguments.</li>
<li>If an error status is returned, the executable is removed from the list of plugins.</li>
<li>The list is returned using <a href="https://en.wikipedia.org/wiki/Tab-separated_values">CSV with tabulations as separators</a>.
Each line has two values separated by a tab: the name of the module then the version of that module.
If there is no version for a module, then the trailing tabulation is not required and be skipped.</li>
</ul>
<h3 id="the-prepare-command"><a class="header" href="#the-prepare-command">The <code>prepare</code> command</a></h3>
<p>The <code>prepare</code> command is invoked by the sm-agent before a sequence of install and remove commands</p>
<pre><code class="language-shell">$ /etc/tedge/sm-plugins/debian prepare
$ /etc/tedge/sm-plugins/debian install x
$ /etc/tedge/sm-plugins/debian install y
$ /etc/tedge/sm-plugins/debian remove z
$ /etc/tedge/sm-plugins/debian finalize
</code></pre>
<p>For many plugins this command will do nothing. However, It gives an opportunity to the plugin to:</p>
<ul>
<li>Update the dependencies before an operation, *i.e. a sequence of actions.
Notably, a debian plugin can update the <code>apt</code> cache issuing an <code>apt-get update</code>.</li>
<li>Start a transaction, in case the plugin is able to manage rollbacks.</li>
</ul>
<p>Contract:</p>
<ul>
<li>This command take no arguments.</li>
<li>No output is expected.</li>
<li>If the <code>prepare</code> command fails, then the planned sequences of actions (.i.e the whole sm operation) is cancelled.</li>
</ul>
<h3 id="the-finalize-command"><a class="header" href="#the-finalize-command">The <code>finalize</code> command</a></h3>
<p>The <code>finalize</code> command closes a sequence of install and remove commands started by a <code>prepare</code> command.</p>
<p>This can be a no-op, but this is also an opportunity to:</p>
<ul>
<li>Remove any unnecessary software module after a sequence of actions.</li>
<li>Commit or rollback the sequence of actions.</li>
<li>Restart any processes using the modules, e.g. restart the analytics engines if the modules have changed</li>
</ul>
<p>Contract:</p>
<ul>
<li>This command take no arguments.</li>
<li>No output is expected.</li>
<li>This command might check (but doesn't have to) that the list of install and remove command has been consistent.
<ul>
<li>For instance, a plugin might raise an error after the sequence <code>prepare;install a; remove a-dependency; finalize</code>.</li>
</ul>
</li>
<li>If the <code>finalize</code> command fails, then the planned sequences of actions (.i.e the whole sm operation) is reported as failed,
even if all the atomic actions has been successfully completed.</li>
</ul>
<h3 id="the-install-command"><a class="header" href="#the-install-command">The <code>install</code> command</a></h3>
<p>The <code>install</code> command installs a software module, possibly of some expected version.</p>
<pre><code class="language-shell">$ plugin install NAME [--module-version VERSION] [--file FILE]
</code></pre>
<p>Contract:</p>
<ul>
<li>The command requires a single mandatory argument: the software module name.
<ul>
<li>This module name is meaningful only to the plugin.</li>
</ul>
</li>
<li>An optional version string can be provided.
<ul>
<li>This version string is meaningful only to the plugin
and is transmitted unchanged from the cloud to the plugin.</li>
<li>The version string can include constraints (as at least that version),
from the sm-agent viewpoint this is no more than a string.</li>
<li>If no version is provided the plugin is free to install the more appropriate version.</li>
</ul>
</li>
<li>An optional file path can be provided.
<ul>
<li>When the device administrator provides an url,
the sm-agent downloads the software module on the device,
then invoke the install command with a path to that file.</li>
<li>If no file is provided, the plugin has to derive the appropriate location from its repository
and to download the software module accordingly.</li>
</ul>
</li>
<li>The command installs the requested software module and any dependencies that might be required.
<ul>
<li>It is up to the plugin to define if this command triggers an installation or an upgrade.
It depends on the presence of a previous version on the device and
of the ability of the package manager to deal with concurrent versions for a module.</li>
<li>A plugin might not be able to install dependencies.
In that case, the device administrator will have to request explicitly the dependencies to be installed first.</li>
<li>After a successful sequence <code>prepare; install foo; finalize</code> the module <code>foo</code> must be reported by the <code>list</code> command.</li>
<li>After a successful sequence <code>prepare; install foo --module-version v; finalize</code> the module <code>foo</code> must be reported by the <code>list</code> command with the version <code>v</code>.
If the plugin manage concurrent versions, the module <code>foo</code> might also be reported with versions already installed before the operation.</li>
<li>A plugin is not required to detect inconsistent actions as <code>prepare; install a; remove a-dependency; finalize</code>.</li>
<li>This is not an error to run this command twice or when the module is already installed.</li>
</ul>
</li>
<li>An error must be reported if:
<ul>
<li>The module name is unknown.</li>
<li>There is no version for the module that matches the constraint provided by the <code>--version</code> option.</li>
<li>The file content provided by <code>--file</code> option:
<ul>
<li>is not in the expected format,</li>
<li>doesn't correspond to the software module name,</li>
<li>has a version that doesn't match the constraint provided by the <code>--module-version</code> option (if any).</li>
</ul>
</li>
<li>The module cannot be downloaded.</li>
<li>The module cannot be installed.</li>
</ul>
</li>
</ul>
<h3 id="the-remove-command"><a class="header" href="#the-remove-command">The <code>remove</code> command</a></h3>
<p>The <code>remove</code> command uninstalls a software module, and possibly its dependencies if no other modules are dependent on those.</p>
<pre><code class="language-shell">$ plugin remove NAME [--module-version VERSION]
</code></pre>
<p>Contract:</p>
<ul>
<li>The command requires a single mandatory argument: the module name.
<ul>
<li>This module name is meaningful only to the plugin
and is transmitted unchanged from the cloud to the plugin.</li>
</ul>
</li>
<li>An optional version string can be provided.
<ul>
<li>This version string is meaningful only to the plugin
and is transmitted unchanged from the cloud to the plugin.</li>
</ul>
</li>
<li>The command uninstall the requested module and possibly any dependencies that are no more required.
<ul>
<li>If a version is provided, only the module of that version is removed.
This is in-practice useful only for a package manager that is able to install concurrent versions of a module.</li>
<li>After a successful sequence <code>prepare; remove foo; finalize</code> the module <code>foo</code> must no more be reported by the <code>list</code> command.</li>
<li>After a successful sequence <code>prepare; remove foo --module-version v; finalize</code> the module <code>foo</code> no more be reported by the <code>list</code> command with the version <code>v</code>.
If the plugin manage concurrent versions, the module <code>foo</code> might still be reported with versions already installed before the operation.</li>
<li>A plugin is not required to detect inconsistent actions as <code>prepare; remove a; install a-reverse-dependency; finalize</code>.</li>
<li>This is not an error to run this command twice or when the module is not installed.</li>
</ul>
</li>
<li>An error must be reported if:
<ul>
<li>The module name is unknown.</li>
<li>The module cannot be uninstalled.</li>
</ul>
</li>
</ul>
<h3 id="the-update-list-command"><a class="header" href="#the-update-list-command">The <code>update-list</code> command</a></h3>
<p>The <code>update-list</code> command accepts a list of software modules and associated operations as <code>install</code> or <code>remove</code>.</p>
<p>This basically achieves same purpose as original commands <code>install</code> and <code>remove</code>, but gets passed all software modules to be processed in one command.
This can be needed when order of processing software modules is relevant - e.g. when dependencies between packages inside the software list do occur.</p>
<pre><code class="language-shell"># building list of software modules and operations, 
# and passing to plugin's stdin via pipe:
# NOTE that each argument is tab separated:

$ echo '\
  install	name1	version1
  install	name2		path2
  remove	name3	version3
  remove	name4'\
 | plugin update-list
</code></pre>
<p>Contract:</p>
<ul>
<li>This command is optional for a plugin. It can be implemented alternatively to original commands <code>install</code> and <code>remove</code> as both are specified above.
<ul>
<li>If a plugin does not implement this command it must return exit status <code>1</code>. In that case sm-agent will call the plugin again
package-by-package using original commands <code>install</code> and <code>remove</code>.</li>
<li>If a plugin implements this command sm-agent uses it instead of original commands <code>install</code> and <code>remove</code>.</li>
</ul>
</li>
<li>This command takes no commandline arguments, but expects a software list sent from sm-agent to plugin's <code>stdin</code>.</li>
<li>In the software list each software module is represented by exactly one line, using tab separated values.</li>
<li>The position of each argument in the argument list has it's defined meaning:
<ul>
<li>1st argument: Is the operation and can be <code>install</code> or <code>remove</code></li>
<li>2nd argument: Is the software module's name.</li>
<li>3rd argument: Is the software module's version. That argument is optional and can be empty (then empty string &quot;&quot; is used).</li>
<li>4th argument: Is the software module's path. That argument is optional and can be empty (then empty string &quot;&quot; is used). For operation <code>remove</code> that argument does not exist.</li>
</ul>
</li>
<li>Behaviour of operations <code>install</code> and <code>remove</code> is same as for original commands <code>install</code> and <code>remove</code> as specified above.
<ul>
<li>For details about operations' arguments &quot;name&quot;, &quot;version&quot; and &quot;path&quot;, see specification of original command <code>install</code> or <code>remove</code>.</li>
<li>For details about <code>exitstatus</code> see accoring specification of original command <code>install</code> or <code>remove</code>.</li>
</ul>
</li>
<li>An overall error must be reported (via process's exit status) when at least one software module operation has failed.</li>
</ul>
<p>Example how to invoke that plugin command <code>update-list</code>. Note that each argument is tab separated:</p>
<pre><code class="language-shell">$ plugin update-list &lt;&lt;EOF
  install	name1	version1
  install	name2		path2
  remove	name3	version3
  remove	name4
EOF
</code></pre>
<p>That is equivalent to use of original commands (<code>install</code> and <code>remove</code>):</p>
<pre><code class="language-shell">$ plugin install name1 --module-version version1
$ plugin install name2 --module-path path2
$ plugin remove &quot;name 3&quot; --module-version version3
$ plugin remove name4
</code></pre>
<p>Exemplary implementation of a shell script for parsing software list from <code>stdin</code>:</p>
<p>Note that this example works only in bash.</p>
<pre><code class="language-shell">#!/bin/bash

echo &quot;&quot;
echo &quot;---+++ reading software list +++---&quot;
while IFS=$'\t' read -r ACTION MODULE VERSION FILE
do
    echo &quot;$0 $ACTION $MODULE $VERSION&quot;
done
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building-thin-edgeio"><a class="header" href="#building-thin-edgeio">Building thin-edge.io</a></h1>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<p>You can use any OS to build from source (below has been tested on Ubuntu, but we also use Debian, macOS, and FreeBSD successfully).</p>
<p>Our recommended setup and required tools are:</p>
<ul>
<li>Ubuntu 20.04 or Debian 10.9 (Buster)</li>
<li>git</li>
<li>Rust toolchain</li>
</ul>
<p>Following packages are required:</p>
<ul>
<li>build-essentials</li>
<li>curl</li>
<li>gcc</li>
</ul>
<p>A list of our test platforms can be found <a href="./supported-platforms.html">here</a>.</p>
<h2 id="get-the-code"><a class="header" href="#get-the-code">Get the code</a></h2>
<p>thin-edge.io code is in git repository on github to acquire the code use following command:</p>
<ul>
<li>via SSH:</li>
</ul>
<pre><code class="language-shell">git clone git@github.com:thin-edge/thin-edge.io.git
</code></pre>
<ul>
<li>or via HTTPS:</li>
</ul>
<pre><code class="language-shell">git clone https://github.com/thin-edge/thin-edge.io.git
</code></pre>
<h2 id="installing-toolchain"><a class="header" href="#installing-toolchain">Installing toolchain</a></h2>
<h3 id="rust-toolchain"><a class="header" href="#rust-toolchain">Rust toolchain</a></h3>
<p>To install Rust follow <a href="https://www.rust-lang.org/tools/install">Official installation guide</a>.
To get started you need Cargo's bin directory (<code>$HOME/.cargo/bin</code>) in your <code>PATH</code> environment variable.</p>
<pre><code class="language-shell">export PATH=$PATH:$HOME/.cargo/bin
</code></pre>
<p>And then you can run <code>rustc</code> to view current version:</p>
<pre><code class="language-shell">$ rustc --version
rustc 1.54.0 (a178d0322 2021-07-26)
</code></pre>
<blockquote>
<p>Note: Above command will add rust to path only for existing session,
after you restart the session you will have to add it again,
to add rust to the path permanently it will depend on your shell but for Bash,
you simply need to add the line from above, <code>export PATH=$PATH:$HOME/.cargo/bin</code> to your ~/.bashrc.</p>
</blockquote>
<blockquote>
<p>For other shells, you'll want to find the appropriate place to set a configuration at start time,
eg. zsh uses ~/.zshrc. Check your shell's documentation to find what file it uses.</p>
</blockquote>
<p>thin-edge.io operates the <code>MSRV</code> (Minimum Supported Rust Version) and uses stable toolchain.</p>
<p>Current MSRV is <code>1.54.0</code>.</p>
<h3 id="cross-compilation-toolchain-optional"><a class="header" href="#cross-compilation-toolchain-optional">Cross compilation toolchain (optional)</a></h3>
<p>thin-edge.io can be compiled for target architecture on non-target device, this is called cross compilation.
Currently we support <code>Raspberry Pi 3B</code> for <code>armv7</code> architecture with Rust's cross compilation toolchain called <a href="https://github.com/rust-embedded/cross">cargo cross</a>.</p>
<p>To install <a href="https://github.com/rust-embedded/cross">cargo cross</a>:</p>
<pre><code class="language-shell">cargo install cross
</code></pre>
<h3 id="debian-packaging-optional"><a class="header" href="#debian-packaging-optional">Debian packaging (optional)</a></h3>
<p>We use <a href="https://github.com/mmstick/cargo-deb">cargo deb</a> to build our debian packages, the tool takes care of all the work to package thin-edge.io.</p>
<p>To install <a href="https://github.com/mmstick/cargo-deb">cargo deb</a> use:</p>
<pre><code class="language-shell">cargo install cargo-deb
</code></pre>
<h2 id="compiling"><a class="header" href="#compiling">Compiling</a></h2>
<p>To build thin-edge.io we are using <code>cargo</code>.</p>
<p>As we are using  <code>cargo workspace</code> for all our crates. All compiled files are put in <code>./target/</code> directory with target's name eg: <code>./target/debug</code> or <code>./target/release</code> for native builds and for cross compiled targets <code>./target/&lt;architecture&gt;/debug</code> or <code>./target/&lt;architecture&gt;/release</code> dependent on the target of the build.</p>
<h3 id="compiling-dev"><a class="header" href="#compiling-dev">Compiling dev</a></h3>
<p>To compile dev profile (with debug symbols) we use following command:</p>
<pre><code class="language-shell">cargo build
</code></pre>
<p>Build artifacts can be found in <code>./target/debug</code> and will include executables:</p>
<pre><code class="language-shell">$ ls ./target/debug/tedge*
-rwxrwxr-x   2 user user 11111 Jan 1 00:00 tedge
-rwxrwxr-x   2 user user 11111 Jan 1 00:00 tedge_mapper
</code></pre>
<p>Binaries can be run eg: <code>./target/debug/tedge</code>.
Alternatively, you can use <code>cargo</code> to build and run executable in a single command:</p>
<pre><code class="language-shell">cargo run --bin tedge
</code></pre>
<h3 id="compiling-release"><a class="header" href="#compiling-release">Compiling release</a></h3>
<p>To compile release profile we use following command:</p>
<pre><code class="language-shell">cargo build --release
</code></pre>
<p>Build artifacts can be found in <code>./target/release</code> and will include executables:</p>
<pre><code class="language-shell">$ ls ./target/release/tedge*
-rwxrwxr-x   2 user user 11111 Jan 1 00:00 tedge
-rwxrwxr-x   2 user user 11111 Jan 1 00:00 tedge_mapper
</code></pre>
<p>Binaries can be run eg: <code>./target/release/tedge</code>.</p>
<h2 id="building-deb-package"><a class="header" href="#building-deb-package">Building deb package</a></h2>
<p>Currently thin-edge.io contains 2 binaries, <code>tedge</code> (cli) and <code>tedge_mapper</code> which are packaged as separate debian packages. To create following commands are to be issued:</p>
<pre><code class="language-shell">cargo deb -p tedge
</code></pre>
<pre><code class="language-shell">cargo deb -p tedge_mapper
</code></pre>
<p>All resulting packages are going to be in: <code>./target/debian/</code> directory:</p>
<pre><code class="language-shell">$ ls ./target/debian -l
total 2948
-rw-rw-r-- 1 user user 11111 Jan 1 00:00 tedge_0.5.0_amd64.deb
-rw-rw-r-- 1 user user 11111 Jan 1 00:00 tedge_mapper_0.5.0_amd64.deb
</code></pre>
<h2 id="cross-compiling"><a class="header" href="#cross-compiling">Cross compiling</a></h2>
<p>To create binaries which can run on different platform than one you are currently on you can use <a href="https://github.com/rust-embedded/cross">cargo cross</a>:</p>
<pre><code class="language-shell">cross build --target armv7-unknown-linux-gnueabihf
</code></pre>
<p>Build artifacts can be found in <code>./target/armv7-unknown-linux-gnueabihf/debug</code> and will include executables:</p>
<pre><code class="language-shell">$ ls ./target/armv7-unknown-linux-gnueabihf/debug/tedge*
-rwxrwxr-x   2 user user 11111 Jan 1 00:00 tedge
-rwxrwxr-x   2 user user 11111 Jan 1 00:00 tedge_mapper
</code></pre>
<p>To cross compile release version of the binaries just add <code>--release</code> to the above command like so:</p>
<pre><code class="language-shell">cross build --target armv7-unknown-linux-gnueabihf --release
</code></pre>
<h2 id="running-tests"><a class="header" href="#running-tests">Running tests</a></h2>
<p>When contributing to thin-edge.io we ask you to write tests for the code you have written. The tests will be run by build pipeline when you create pull request, but you can easily run all the tests when you are developing with following command:</p>
<pre><code class="language-shell">cargo test
</code></pre>
<p>This will run all tests from the repository and sometime may take long time, <code>cargo</code> allows you to run specific test or set of tests for binary:</p>
<pre><code class="language-shell">cargo test --bin tedge
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference-guides"><a class="header" href="#reference-guides">Reference Guides</a></h1>
<p>The thin-edge.io command-line interface (tedge CLI) is a set of commands used to create and manage thin-edge.io resources.</p>
<p>Following sections show the tedge sub commands.</p>
<ul>
<li><a href="references/../references/tedge.html"><code>tedge</code> command</a></li>
<li><a href="references/../references/tedge-cert.html"><code>tedge cert</code> command</a></li>
<li><a href="references/../references/tedge-config.html"><code>tedge config</code> command</a></li>
<li><a href="references/../references/tedge-connect.html"><code>tedge connect</code> command</a></li>
<li><a href="references/../references/tedge-disconnect.html"><code>tedge disconnect</code> command</a></li>
<li><a href="references/../references/tedge-mqtt.html"><code>tedge mqtt</code> command</a></li>
<li><a href="references/../references/bridged-topics.html">Bridged Topics</a></li>
</ul>
<p>Software Management (under development)</p>
<ul>
<li><a href="references/./plugin-api.html">Plugin API</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tedge-command"><a class="header" href="#the-tedge-command">The <code>tedge</code> command</a></h1>
<pre><code>tedge 0.2.0
tedge is the cli tool for thin-edge.io

USAGE:
    tedge &lt;SUBCOMMAND&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

SUBCOMMANDS:
    cert          Create and manage device certificate
    config        Configure Thin Edge
    connect       Connect to connector provider
    disconnect    Remove bridge connection for a provider
    help          Prints this message or the help of the given subcommand(s)
    mqtt          Publish a message on a topic and subscribe a topic
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tedge-config-command"><a class="header" href="#the-tedge-config-command">The <code>tedge config</code> command</a></h1>
<pre><code>tedge-config 0.2.0
Configure Thin Edge

USAGE:
    tedge config &lt;SUBCOMMAND&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

SUBCOMMANDS:
    get      Get the value of the provided configuration key
    help     Prints this message or the help of the given subcommand(s)
    list     Print the configuration keys and their values
    set      Set or update the provided configuration key with the given value
    unset    Unset the provided configuration key
</code></pre>
<h2 id="get"><a class="header" href="#get">Get</a></h2>
<pre><code>tedge-config-get 0.2.0
Get the value of the provided configuration key

USAGE:
    tedge config get &lt;key&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

ARGS:
    &lt;key&gt;    Configuration key. Run `tedge config list --doc` for available keys
</code></pre>
<h2 id="set"><a class="header" href="#set">Set</a></h2>
<pre><code>tedge-config-set 0.2.0
Set or update the provided configuration key with the given value

USAGE:
    tedge config set &lt;key&gt; &lt;value&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

ARGS:
    &lt;key&gt;      Configuration key. Run `tedge config list --doc` for available keys
    &lt;value&gt;    Configuration value
</code></pre>
<h2 id="list-2"><a class="header" href="#list-2">List</a></h2>
<pre><code>tedge-config-list 0.2.0
Print the configuration keys and their values

USAGE:
    tedge config list [FLAGS]

FLAGS:
    -h, --help       Prints help information
        --all        Prints all the configuration keys, even those without a configured value
        --doc        Prints all keys and descriptions with example values
    -V, --version    Prints version information
</code></pre>
<h2 id="unset"><a class="header" href="#unset">Unset</a></h2>
<pre><code>tedge-config-unset 0.2.0
Unset the provided configuration key

USAGE:
    tedge config unset &lt;key&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

ARGS:
    &lt;key&gt;    Configuration key. Run `tedge config list --doc` for available keys
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tedge-cert-command"><a class="header" href="#the-tedge-cert-command">The <code>tedge cert</code> command</a></h1>
<pre><code>tedge-cert 0.2.0
Create and manage device certificate

USAGE:
    tedge cert &lt;SUBCOMMAND&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

SUBCOMMANDS:
    create    Create a self-signed device certificate
    help      Prints this message or the help of the given subcommand(s)
    remove    Remove the device certificate
    show      Show the device certificate, if any
    upload    Upload root certificate
</code></pre>
<h2 id="create"><a class="header" href="#create">Create</a></h2>
<pre><code>tedge-cert-create 0.2.0
Create a self-signed device certificate

USAGE:
    tedge cert create --device-id &lt;id&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

OPTIONS:
        --device-id &lt;id&gt;    The device identifier to be used as the common name for the certificate
</code></pre>
<h2 id="show"><a class="header" href="#show">Show</a></h2>
<pre><code>tedge-cert-show 0.2.0
Show the device certificate, if any

USAGE:
    tedge cert show

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information
</code></pre>
<h2 id="remove-2"><a class="header" href="#remove-2">Remove</a></h2>
<pre><code>tedge-cert-remove 0.2.0
Remove the device certificate

USAGE:
    tedge cert remove

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information
</code></pre>
<h2 id="upload"><a class="header" href="#upload">Upload</a></h2>
<pre><code>tedge-cert-upload 0.2.0
Upload root certificate

USAGE:
    tedge cert upload &lt;SUBCOMMAND&gt;

FLAGS:
    -h, --help       
            Prints help information

    -V, --version    
            Prints version information


SUBCOMMANDS:
    c8y     Upload root certificate to Cumulocity
    help    Prints this message or the help of the given subcommand(s)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tedge-connect-command"><a class="header" href="#the-tedge-connect-command">The <code>tedge connect</code> command</a></h1>
<pre><code>tedge-connect 0.2.0
Connect to connector provider

USAGE:
    tedge connect &lt;SUBCOMMAND&gt;

FLAGS:
    -h, --help       
            Prints help information

    -V, --version    
            Prints version information


SUBCOMMANDS:
    az      Create connection to Azure
    c8y     Create connection to Cumulocity
    help    Prints this message or the help of the given subcommand(s)
</code></pre>
<h2 id="azure-1"><a class="header" href="#azure-1">Azure</a></h2>
<pre><code>tedge-connect-az 0.2.0
Create connection to Azure

The command will create config and start edge relay from the device to az instance

USAGE:
    tedge connect az [FLAGS]

FLAGS:
    -h, --help       
            Prints help information

        --test       
            Test connection to Azure

    -V, --version    
            Prints version information
</code></pre>
<h2 id="cumulocity-1"><a class="header" href="#cumulocity-1">Cumulocity</a></h2>
<pre><code>tedge-connect-c8y 0.2.0
Create connection to Cumulocity

The command will create config and start edge relay from the device to c8y instance

USAGE:
    tedge connect c8y [FLAGS]

FLAGS:
    -h, --help       
            Prints help information

        --test       
            Test connection to Cumulocity

    -V, --version    
            Prints version information
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tedge-disconnect-command"><a class="header" href="#the-tedge-disconnect-command">The <code>tedge disconnect</code> command</a></h1>
<pre><code>tedge-disconnect 0.2.0
Remove bridge connection for a provider

USAGE:
    tedge disconnect &lt;SUBCOMMAND&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

SUBCOMMANDS:
    az      Remove bridge connection to Azure
    c8y     Remove bridge connection to Cumulocity
    help    Prints this message or the help of the given subcommand(s)
</code></pre>
<h2 id="azure-2"><a class="header" href="#azure-2">Azure</a></h2>
<pre><code>tedge-disconnect-az 0.2.0
Remove bridge connection to Azure

USAGE:
    tedge disconnect az

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information
</code></pre>
<h2 id="cumulocity-2"><a class="header" href="#cumulocity-2">Cumulocity</a></h2>
<pre><code>tedge-disconnect-c8y 0.2.0
Remove bridge connection to Cumulocity

USAGE:
    tedge disconnect c8y

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-tedge-mqtt-command"><a class="header" href="#the-tedge-mqtt-command">The <code>tedge mqtt</code> command</a></h1>
<pre><code>tedge-mqtt 0.2.0
Publish a message on a topic and subscribe a topic

USAGE:
    tedge mqtt &lt;SUBCOMMAND&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

SUBCOMMANDS:
    help    Prints this message or the help of the given subcommand(s)
    pub     Publish a MQTT message on a topic
    sub     Subscribe a MQTT topic
</code></pre>
<h2 id="pub"><a class="header" href="#pub">Pub</a></h2>
<pre><code>tedge-mqtt-pub 0.2.0
Publish a MQTT message on a topic

USAGE:
    tedge mqtt pub [OPTIONS] &lt;topic&gt; &lt;message&gt;

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

OPTIONS:
    -q, --qos &lt;qos&gt;    QoS level (0, 1, 2) [default: 0]

ARGS:
    &lt;topic&gt;      Topic to publish
    &lt;message&gt;    Message to publish
</code></pre>
<h2 id="sub"><a class="header" href="#sub">Sub</a></h2>
<pre><code>tedge-mqtt-sub 0.2.0
Subscribe a MQTT topic

USAGE:
    tedge mqtt sub [FLAGS] [OPTIONS] &lt;topic&gt;

FLAGS:
    -h, --help        Prints help information
        --no-topic    Avoid printing the message topics on the console
    -V, --version     Prints version information

OPTIONS:
    -q, --qos &lt;qos&gt;    QoS level (0, 1, 2) [default: 0]

ARGS:
    &lt;topic&gt;    Topic to subscribe to
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
